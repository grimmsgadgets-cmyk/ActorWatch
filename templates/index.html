<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ app_name }}</title>
    <style>
      body { margin: 0; font-family: Arial, sans-serif; background: #f7f7f7; color: #111; line-height: 1.4; }
      .layout { display: grid; grid-template-columns: 320px 1fr; min-height: 100vh; }
      .sidebar { background: #1e2430; color: #fff; padding: 16px; }
      .sidebar h1 { font-size: 20px; margin: 0 0 12px; }
      .sidebar h3 { margin: 0 0 8px; font-size: 14px; letter-spacing: .01em; }
      .sidebar-panel, .sidebar-card { margin-top: 12px; padding: 10px; border: 1px solid #3d4658; border-radius: 10px; background: #273143; }
      .sidebar-panel:first-of-type { margin-top: 0; }
      .actor-list { list-style: none; padding: 0; margin: 0; }
      .actor-list li { margin-bottom: 6px; }
      .actors-head { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin: 0 0 6px; }
      .actors-head h3 { margin: 0; }
      .geo-open-btn.compact {
        width: auto;
        min-height: 28px;
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 11px;
      }
      .actors-subhead { margin: 0 0 8px; font-size: 12px; letter-spacing: .01em; color: #d6e3f5; }
      .actors-divider { margin: 10px 0; border: 0; border-top: 1px dashed #4f5e77; }
      .actor-autocomplete-wrap { position: relative; }
      .actor-autocomplete-list {
        position: absolute;
        left: 0;
        right: 0;
        top: calc(100% + 4px);
        z-index: 30;
        border: 1px solid #3d4658;
        border-radius: 8px;
        background: #1f2735;
        max-height: 220px;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(10, 15, 25, 0.35);
      }
      .actor-autocomplete-list[hidden] { display: none; }
      .actor-autocomplete-item {
        width: 100%;
        border: 0;
        border-bottom: 1px solid #2d3646;
        background: transparent;
        color: #e8eef6;
        text-align: left;
        padding: 8px 10px;
        font-size: 12px;
        cursor: pointer;
      }
      .actor-autocomplete-item:last-child { border-bottom: 0; }
      .actor-autocomplete-item:hover,
      .actor-autocomplete-item.active { background: #31415a; }
      .actor-autocomplete-hint {
        display: block;
        margin-top: 6px;
        font-size: 11px;
        color: #a7b7cb;
      }
      .actor-link {
        display: block;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid #3d4658;
        color: #fff;
        text-decoration: none;
        background: #2b3445;
      }
      .actor-link.selected { background: #35527f; border-color: #7ea4df; }
      .actor-name { font-weight: bold; display: block; }
      .actor-scope { font-size: 11px; opacity: 0.9; margin-top: 3px; }
      .actor-row { display: grid; grid-template-columns: 1fr auto; gap: 6px; align-items: stretch; }
      .actor-row form { margin: 0; display: flex; }
      .actor-row .actor-remove {
        padding: 0 4px;
        border-radius: 6px;
        border: 0;
        background: transparent;
        color: #9fb3d5;
        font-size: 11px;
        line-height: 1;
        cursor: pointer;
      }
      .actor-row .actor-remove:hover { color: #d7e4ff; text-decoration: underline; }
      .sidebar form { display: grid; gap: 8px; }
      .sidebar input, .sidebar textarea, .sidebar button { padding: 8px; border-radius: 6px; border: 1px solid #6c7586; }
      .sidebar button { background: #4a7bd0; color: #fff; border: 0; cursor: pointer; }
      .sidebar .action-button {
        display: block;
        width: 100%;
        min-height: 36px;
        padding: 8px;
        border-radius: 6px;
        box-sizing: border-box;
        border: 0;
        background: #4a7bd0;
        color: #fff;
        font-size: 14px;
        line-height: 1.2;
        font-weight: 400;
        text-align: center;
      }
      button,
      .action-button,
      .quick-actions a,
      .quick-actions details.quick-export-menu > summary,
      .question-feedback-btn,
      .live-controls button {
        transition: transform 90ms ease, box-shadow 120ms ease, filter 120ms ease, opacity 120ms ease;
      }
      button:active,
      .action-button:active,
      .quick-actions a:active,
      .quick-actions details.quick-export-menu > summary:active,
      .question-feedback-btn:active,
      .live-controls button:active {
        transform: translateY(1px) scale(0.99);
        filter: brightness(0.94);
        box-shadow: inset 0 0 0 2px rgba(15, 23, 42, 0.14);
      }
      button:focus-visible,
      .action-button:focus-visible,
      .quick-actions a:focus-visible,
      .quick-actions details.quick-export-menu > summary:focus-visible,
      .question-feedback-btn:focus-visible,
      .live-controls button:focus-visible {
        outline: 2px solid #1f4a8a;
        outline-offset: 2px;
      }
      .main { padding: 16px; overflow: hidden; display: flex; flex-direction: column; gap: 12px; }
      .top-status-row { position: sticky; top: 0; z-index: 15; background: #f7f7f7; padding-bottom: 6px; }
      .dashboard { display: grid; grid-template-rows: auto auto auto auto; gap: 10px; flex: 1; min-height: 0; align-content: start; }
      .workspace-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: auto; gap: 10px; min-height: 0; align-items: start; }
      .workspace-grid .pane { min-height: 0; max-height: 430px; overflow: auto; }
      .workspace-grid .pane .section-title { position: sticky; top: 0; z-index: 4; background: #fff; }
      .workspace-grid.single-card { grid-template-columns: 1fr; }
      .giant-notebook-card { min-height: 0; }
      .main-tabs { display: inline-flex; gap: 8px; align-items: center; margin-bottom: 10px; }
      .main-tab-btn {
        border: 1px solid #c9d7ef;
        border-radius: 999px;
        background: #f8fbff;
        color: #1f2937;
        font-size: 12px;
        padding: 6px 12px;
        cursor: pointer;
      }
      .main-tab-btn.active {
        background: #35527f;
        border-color: #35527f;
        color: #fff;
      }
      .tab-panel-hidden { display: none !important; }
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        border: 0;
      }
      .adv-tabs { display: inline-flex; gap: 6px; flex-wrap: wrap; margin: 8px 0; }
      .adv-tab-btn {
        border: 1px solid #c9d7ef;
        border-radius: 999px;
        background: #f8fbff;
        color: #1f2937;
        font-size: 11px;
        padding: 4px 10px;
        cursor: pointer;
      }
      .adv-tab-btn.active {
        background: #1f4a8a;
        border-color: #1f4a8a;
        color: #fff;
      }
      .notes-tabs { display: inline-flex; gap: 6px; flex-wrap: wrap; margin: 6px 0 8px; }
      .notes-tab-btn {
        border: 1px solid #c9d7ef;
        border-radius: 999px;
        background: #f8fbff;
        color: #1f2937;
        font-size: 11px;
        padding: 4px 10px;
        cursor: pointer;
      }
      .notes-tab-btn.active {
        background: #35527f;
        border-color: #35527f;
        color: #fff;
      }
      .card { background: #fff; border: 1px solid #d9e2ef; border-radius: 10px; padding: 12px; margin-bottom: 0; box-shadow: 0 1px 0 rgba(15, 23, 42, 0.03); }
      .card.span-2 { grid-column: 1 / -1; }
      .ataglance-strip { display: grid; grid-template-columns: repeat(4, minmax(120px, 1fr)); gap: 10px; padding: 10px 12px; position: sticky; top: 54px; z-index: 10; }
      .ataglance-metric { border: 1px solid #dce7f8; border-radius: 8px; background: #f8fbff; padding: 8px; min-height: 54px; }
      .ataglance-label { font-size: 10px; text-transform: uppercase; color: #64748b; letter-spacing: .03em; }
      .ataglance-value { font-size: 14px; font-weight: 700; color: #0f172a; margin-top: 3px; }
      .ataglance-value a { color: inherit; text-decoration: underline; text-decoration-thickness: 1px; text-underline-offset: 2px; }
      .ataglance-value a:hover { text-decoration-thickness: 2px; }
      .mini-trend-inline { display: flex; align-items: flex-end; gap: 2px; margin-top: 6px; height: 20px; overflow: hidden; }
      .mini-trend-bar { width: 6px; border-radius: 2px; background: #89a8d8; }
      .mini-trend-bar.peak { background: #c44f4f; }
      .mini-trend-meta { margin-top: 4px; font-size: 10px; color: #475569; line-height: 1.2; }
      .mini-trend-labels { display: flex; justify-content: space-between; margin-top: 2px; font-size: 9px; color: #64748b; }
      .mini-trend-kpis { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 4px; margin-top: 5px; }
      .mini-trend-kpi { border: 1px solid #d7e2f4; border-radius: 6px; background: #f2f7ff; padding: 3px 4px; }
      .mini-trend-kpi .k { display: block; font-size: 9px; text-transform: uppercase; letter-spacing: .02em; color: #64748b; line-height: 1.1; }
      .mini-trend-kpi .v { display: block; font-size: 11px; font-weight: 700; color: #1f2937; line-height: 1.2; margin-top: 1px; }
      .mini-trend-kpi.up .v { color: #0f6b2f; }
      .mini-trend-kpi.down .v { color: #8a1c1c; }
      .mini-trend-kpi.flat .v { color: #334155; }
      .bottom-drawer { min-height: 0; }
      .section-title { margin-top: 0; margin-bottom: 8px; font-size: 14px; line-height: 1.2; padding-bottom: 6px; border-bottom: 1px solid #e8eef8; }
      .role-chip { display: inline-block; margin-left: 8px; font-size: 10px; text-transform: uppercase; letter-spacing: .03em; border: 1px solid #cfdcee; border-radius: 999px; padding: 2px 7px; color: #41556f; background: #f3f8ff; vertical-align: middle; }
      .section-body { padding-right: 2px; }
      .section-body p { margin: 0 0 6px; }
      .section-body ul { margin-top: 4px; }
      .event { border-left: 3px solid #3f5f9a; margin: 6px 0; padding: 6px 8px; background: #f8fbff; }
      .event.notable-primary { border-left-color: #c44f4f; background: #fff1f1; }
      .event.notable-primary strong { color: #7f1d1d; }
      .change-list { display: grid; gap: 8px; margin-top: 8px; }
      .change-row { border: 1px solid #dfe6f3; border-radius: 8px; padding: 8px; background: #fbfdff; }
      .change-row-main { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; font-size: 12px; }
      .change-row-title { font-weight: 600; font-size: 13px; color: #1f2937; }
      .change-row-source { margin-top: 4px; font-size: 12px; color: #334155; }
      .timeline-graphic { position: relative; margin: 10px 0 0 6px; padding-left: 28px; }
      .timeline-graphic::before { content: ""; position: absolute; left: 9px; top: 0; bottom: 0; width: 3px; background: #c7d7ef; }
      .timeline-node { position: relative; margin: 0 0 14px; padding: 10px; border: 1px solid #d8e1ef; border-radius: 8px; background: #f9fbff; }
      .timeline-node::before { content: ""; position: absolute; left: -24px; top: 14px; width: 12px; height: 12px; border-radius: 50%; background: #3f5f9a; }
      .timeline-row { display: grid; grid-template-columns: 150px 1fr; gap: 10px; align-items: start; margin-bottom: 10px; }
      .timeline-date { font-size: 12px; color: #334155; }
      .timeline-bar { height: 8px; border-radius: 999px; background: linear-gradient(90deg, #4a7bd0, #9bb7e8); margin: 6px 0 10px; }
      .timeline-meta { font-size: 12px; color: #334155; margin-top: 4px; }
      .timeline-ataglance { display: grid; grid-template-columns: 1fr 2fr; gap: 10px; align-items: start; margin-bottom: 10px; }
      .deviation-strip { border: 1px solid #dce7f8; border-radius: 8px; background: #f7fbff; padding: 8px; }
      .deviation-strip h4 { margin: 0 0 6px; font-size: 13px; }
      .chip-line { display: flex; flex-wrap: wrap; gap: 6px; }
      .chip { display: inline-block; font-size: 11px; border-radius: 999px; border: 1px solid #9db2d3; padding: 2px 8px; background: #eef4ff; }
      .chip.alert { border-color: #e4b26b; background: #fff6e7; }
      .mini-graph { border: 1px solid #dce7f8; border-radius: 8px; padding: 8px; background: #fbfdff; }
      .mini-graph h4 { margin: 0 0 6px; font-size: 13px; }
      .graph-cols { display: flex; align-items: flex-end; gap: 6px; min-height: 110px; }
      .graph-col { width: 28px; display: flex; flex-direction: column; align-items: center; gap: 4px; }
      .stack { width: 20px; height: 100px; border-radius: 6px; border: 1px solid #d8e1ef; display: flex; flex-direction: column-reverse; overflow: hidden; background: #f1f4fa; }
      .stack-seg { width: 100%; }
      .graph-label { font-size: 10px; color: #4a5568; }
      .graph-legend { display: flex; flex-wrap: wrap; gap: 6px 10px; margin-top: 8px; font-size: 11px; color: #334155; }
      .legend-item { display: inline-flex; align-items: center; gap: 5px; }
      .legend-swatch { width: 10px; height: 10px; border-radius: 2px; border: 1px solid #c9d3e5; }
      .timeline-footer-link { margin-top: 8px; font-size: 12px; }
      .priority-strip { background: #fff; border: 1px solid #dfe6f3; border-radius: 10px; padding: 10px; margin-bottom: 10px; }
      .decision-queue { margin-bottom: 0; }
      .decision-header { display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 8px; }
      .phase-block { margin-bottom: 8px; }
      .phase-title { font-size: 11px; text-transform: uppercase; letter-spacing: .02em; color: #475569; margin: 0 0 4px; }
      .dq-card { border: 1px solid #e3e9f5; border-radius: 8px; padding: 7px 8px; background: #fbfdff; margin-bottom: 6px; }
      .dq-line { font-size: 12px; line-height: 1.35; color: #1f2937; margin: 4px 0; }
      .dq-line strong { font-weight: 600; }
      .dq-list { display: grid; gap: 6px; }
      .dq-row { border: 1px solid #e3e9f5; border-radius: 10px; background: #fbfdff; }
      .dq-row > summary { cursor: pointer; padding: 8px 10px; font-size: 12px; list-style: none; display: flex; align-items: center; justify-content: space-between; gap: 8px; }
      .dq-row > summary::-webkit-details-marker { display: none; }
      .dq-detail { padding: 0 10px 10px; border-top: 1px solid #ecf1fa; }
      .deemphasized { opacity: 0.75; }
      .summary-list { margin: 8px 0 0; padding-left: 18px; }
      .summary-list li { margin: 4px 0; font-size: 13px; line-height: 1.4; color: #1f2937; }
      .who-meta { margin: 6px 0 0; font-size: 12px; color: #334155; line-height: 1.4; }
      .who-meta a { color: #1f4a8a; }
      .who-summary { border: 1px solid #dce7f8; border-radius: 8px; background: #f8fbff; padding: 8px; margin-bottom: 8px; }
      .who-summary p { margin: 0; font-size: 13px; line-height: 1.4; color: #0f172a; }
      .who-why { margin: 8px 0; border: 1px solid #dce7f8; border-radius: 8px; background: #f8fbff; padding: 8px; font-size: 13px; line-height: 1.4; color: #0f172a; font-weight: 500; }
      .who-heading { margin: 8px 0 6px; font-size: 13px; letter-spacing: .01em; color: #1f2937; }
      .technique-grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 8px; margin-top: 8px; }
      .technique-item { border: 1px solid #dfe6f3; border-radius: 8px; background: #fbfdff; padding: 8px; }
      .technique-head { display: flex; align-items: center; gap: 6px; margin-bottom: 3px; }
      .technique-pill { display: inline-block; border-radius: 999px; border: 1px solid #9bb6dc; background: #eef4ff; color: #1f4a8a; padding: 2px 8px; font-size: 11px; text-decoration: none; font-weight: 600; }
      .technique-name { font-size: 13px; color: #0f172a; line-height: 1.35; }
      .technique-phase { font-size: 12px; color: #334155; line-height: 1.35; }
      .who-kpis { display: grid; grid-template-columns: repeat(3, minmax(120px, 1fr)); gap: 8px; margin: 10px 0; }
      .who-kpi { border: 1px solid #dfe6f3; border-radius: 8px; background: #fbfdff; padding: 8px; }
      .who-kpi-label { font-size: 11px; text-transform: uppercase; letter-spacing: .02em; color: #475569; }
      .who-kpi-value { margin-top: 2px; font-size: 15px; font-weight: 700; color: #0f172a; line-height: 1.3; }
      .snapshot-grid { display: grid; grid-template-columns: repeat(3, minmax(180px, 1fr)); gap: 8px; margin: 10px 0; }
      .snapshot-card { border: 1px solid #dfe6f3; border-radius: 10px; padding: 10px; background: #fbfdff; border-top: 3px solid #9aa8bf; min-height: 118px; display: flex; flex-direction: column; gap: 6px; }
      .snapshot-card.conf-high { border-top-color: #c44f4f; background: #fff7f7; }
      .snapshot-card.conf-medium { border-top-color: #d0a13b; background: #fffaf0; }
      .snapshot-card.conf-low { border-top-color: #4e7ecf; background: #f6faff; }
      .snapshot-title { font-size: 11px; text-transform: uppercase; letter-spacing: .04em; color: #475569; margin: 0; }
      .snapshot-text { font-size: 13px; line-height: 1.35; margin: 0; color: #1f2937; }
      .snapshot-meta { font-size: 11px; color: #475569; margin-top: auto; display: flex; gap: 8px; flex-wrap: wrap; }
      .helper-box { border: 1px solid #d9e3f7; border-radius: 8px; background: #f5f8ff; padding: 8px; margin: 8px 0; }
      .helper-box h4 { margin: 0 0 6px; font-size: 13px; }
      .helper-box p { margin: 0 0 6px; font-size: 12px; line-height: 1.35; color: #1f2937; }
      .helper-box ul { margin: 6px 0 0; padding-left: 18px; }
      .helper-box li { margin: 3px 0; font-size: 12px; line-height: 1.35; }
      .inline-note { margin: 6px 0 0; font-size: 12px; color: #334155; }
      .kpi-strip { display: grid; grid-template-columns: repeat(4, minmax(120px, 1fr)); gap: 8px; margin-bottom: 10px; }
      .kpi-card { background: #fff; border: 1px solid #dfe6f3; border-radius: 10px; padding: 8px 10px; }
      .kpi-label { font-size: 11px; color: #475569; text-transform: uppercase; letter-spacing: .02em; }
      .kpi-value { font-size: 18px; font-weight: 700; margin-top: 2px; }
      .priority-list { display: grid; gap: 6px; }
      .priority-item { display: grid; grid-template-columns: 70px 1fr; gap: 8px; align-items: start; border: 1px solid #edf1f7; border-radius: 8px; padding: 6px 8px; background: #fbfdff; }
      .priority-body { display: grid; gap: 4px; }
      .priority-q { font-size: 13px; line-height: 1.3; }
      .priority-meta { font-size: 11px; color: #475569; line-height: 1.25; }
      .pbadge { display: inline-block; border-radius: 999px; padding: 2px 8px; border: 1px solid #aeb8c5; font-size: 11px; }
      .pbadge.high { background: #ffe9e8; border-color: #e5a7a4; }
      .pbadge.medium { background: #fff6df; border-color: #e6cb86; }
      .pbadge.low { background: #edf7ed; border-color: #a8d0aa; }
      .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #888; }
      .badge.open { background: #fff7d8; }
      .badge.resolved { background: #e1f5e6; }
      .badge.freshness-new { background: #eaf9ef; border-color: #9fd2ac; }
      .badge.freshness-recent { background: #eef6ff; border-color: #a7c2ea; }
      .badge.freshness-stale { background: #fff6e8; border-color: #e8c885; }
      .badge.freshness-old { background: #f4f5f7; border-color: #c8ced8; }
      .badge.freshness-unknown { background: #f4f5f7; border-color: #c8ced8; }
      .source-item { border-bottom: 1px solid #e3e3e3; padding: 8px 0; }
      .recent-source-list { margin: 6px 0 0; padding: 0; list-style: none; display: grid; gap: 8px; }
      .recent-source-list li { margin: 0; font-size: 13px; border: 1px solid #e4ebf7; border-radius: 8px; background: #fbfdff; padding: 8px; }
      .source-headline { display: flex; flex-wrap: wrap; align-items: center; gap: 6px; margin-bottom: 4px; }
      .source-meta { display: block; color: #475569; font-size: 11px; line-height: 1.35; margin-bottom: 2px; }
      .source-title-link {
        display: inline-block;
        max-width: 56ch;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        vertical-align: bottom;
      }
      .question { border: 1px solid #ddd; border-radius: 8px; padding: 8px; margin: 8px 0; }
      blockquote { margin: 6px 0; padding: 8px 10px; background: #f3f5f7; border-left: 3px solid #9aa5b1; }
      .guidance { border: 1px solid #d6e3f5; border-radius: 8px; background: #f5faff; padding: 10px; margin: 8px 0; }
      .notice { background: #fff6d9; border: 1px solid #e1cc78; border-radius: 8px; padding: 6px 8px; margin-bottom: 8px; }
      .top-status-row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 10px; }
      .ui-mode-top {
        margin-left: auto;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border: 1px solid #c9d7ef;
        background: #f8fbff;
        border-radius: 999px;
        padding: 4px 8px;
      }
      .ui-mode-top label { font-size: 11px; color: #334155; font-weight: 600; }
      .ui-mode-top select {
        border: 1px solid #c7d4ea;
        border-radius: 999px;
        background: #fff;
        color: #0f172a;
        font-size: 11px;
        padding: 3px 8px;
      }
      .status-chip { margin-bottom: 0; padding: 4px 8px; font-size: 11px; line-height: 1.25; width: fit-content; max-width: 340px; border-radius: 999px; }
      .status-chip strong { font-weight: 600; }
      .status-button {
        border: 1px solid #c9d7ef;
        background: #f8fbff;
        color: #0f172a;
        cursor: default;
        text-align: left;
      }
      .status-ops-drawer {
        margin: 0;
      }
      .status-ops-drawer > summary {
        list-style: none;
      }
      .status-ops-drawer > summary::-webkit-details-marker { display: none; }
      .status-ops-panel {
        margin-top: 8px;
        border: 1px solid #d9e7fb;
        border-radius: 8px;
        background: #f7fbff;
        padding: 8px;
        min-width: min(760px, calc(100vw - 48px));
      }
      .status-ops-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(120px, 1fr));
        gap: 6px;
      }
      .status-ops-item {
        border: 1px solid #dce7f8;
        border-radius: 8px;
        background: #fff;
        padding: 6px;
      }
      .status-ops-item .label { font-size: 10px; text-transform: uppercase; letter-spacing: .02em; color: #64748b; }
      .status-ops-item .value { font-size: 12px; font-weight: 600; color: #0f172a; margin-top: 2px; overflow-wrap: anywhere; }
      .status-meta { margin-top: 3px; font-size: 10px; color: #334155; }
      .status-running { background: #eef6ff; border-color: #a7c2ea; }
      .status-ready { background: #eaf9ef; border-color: #9fd2ac; }
      .status-error { background: #ffeceb; border-color: #e4a8a3; }
      .status-idle { background: #f4f5f7; border-color: #c8ced8; }
      .status-warning { background: #fff6e8; border-color: #e8c885; }
      .status-llm-ok { background: #eaf9ef; border-color: #9fd2ac; }
      .status-llm-bad { background: #ffeceb; border-color: #e4a8a3; }
      .status-working { background: #eef6ff; border-color: #8fb2e8; }
      .ui-activity-strip { max-width: 520px; }
      .region-busy { opacity: 0.55; pointer-events: none; transition: opacity 120ms ease; }
      .is-loading-btn {
        opacity: 0.85;
        cursor: progress;
        box-shadow: inset 0 0 0 2px rgba(15, 23, 42, 0.14);
      }
      .ui-toast-stack { position: fixed; right: 14px; bottom: 14px; z-index: 60; display: grid; gap: 8px; width: min(340px, calc(100vw - 28px)); }
      .ui-toast { border-radius: 8px; border: 1px solid #c8d7ef; padding: 8px 10px; font-size: 12px; box-shadow: 0 8px 20px rgba(15, 23, 42, 0.12); background: #f8fbff; color: #0f172a; }
      .ui-toast.success { background: #edf9f0; border-color: #a9d9b3; }
      .ui-toast.error { background: #fff0ef; border-color: #e4b1ad; }
      .ui-toast.info { background: #eef5ff; border-color: #b5caec; }
      .progress-wrap { margin-top: 4px; background: #dfe9f7; border-radius: 999px; height: 6px; overflow: hidden; width: 120px; }
      .progress-bar { height: 6px; width: 35%; background: #4a7bd0; border-radius: 999px; animation: loading 1.1s linear infinite; }
      @keyframes loading { 0% { margin-left: -35%; } 100% { margin-left: 100%; } }
      .empty { padding: 40px; text-align: center; background: #fff; border: 1px dashed #bbb; border-radius: 8px; }
      pre { white-space: pre-wrap; margin: 0; }
      .track-grid { display: grid; gap: 8px; }
      .track-row { display: flex; justify-content: space-between; align-items: center; border: 1px solid #ddd; border-radius: 8px; padding: 8px; }
      .mini-form { display: inline; }
      .mini-form button { padding: 6px 10px; }
      details.compact { border: 1px solid #e3e3e3; border-radius: 8px; padding: 8px 10px; margin-top: 8px; background: #fafafa; }
      details.compact > summary { cursor: pointer; font-weight: 600; }
      .sidebar-card { margin-top: 12px; }
      .sidebar-card h3 { margin: 0 0 8px; }
      .sidebar-card small { display: block; opacity: 0.9; margin-bottom: 8px; line-height: 1.35; }
      .learning-grid { display: grid; gap: 6px; }
      .learning-grid label { font-size: 12px; opacity: 0.95; }
      .learning-status { font-size: 11px; color: #c6d4ea; min-height: 14px; }
      .feedback-actions { display: flex; gap: 6px; margin-top: 6px; }
      .feedback-actions button { padding: 4px 8px; font-size: 12px; border-radius: 6px; border: 1px solid #cdd8ea; cursor: pointer; }
      .feedback-actions .positive { background: #eaf9ef; border-color: #9fd2ac; }
      .feedback-actions .negative { background: #fff2ef; border-color: #e3b0a7; }
      .feedback-status { font-size: 11px; color: #475569; margin-left: 6px; }
      .sidebar details.compact { background: #2b3445; border: 1px solid #3d4658; color: #fff; }
      .sidebar details.compact > summary { list-style: none; }
      .sidebar details.compact > summary::-webkit-details-marker { display: none; }
      .sidebar .secondary-action {
        margin-top: 8px;
        padding: 0;
        border: 0;
        background: transparent;
      }
      .sidebar .secondary-action > summary {
        cursor: pointer;
      }
      .sidebar .secondary-action[open] {
        padding: 8px;
        border: 1px solid #3d4658;
        border-radius: 8px;
        background: #2b3445;
      }
      .quick-actions { display: grid; gap: 8px; margin-bottom: 10px; }
      .quick-actions form { margin: 0; }
      .quick-actions details.quick-export-menu { margin: 0; }
      .quick-actions details.quick-export-menu > summary { list-style: none; }
      .quick-actions details.quick-export-menu > summary::-webkit-details-marker { display: none; }
      .quick-actions a, .quick-actions button {
        display: block;
        width: 100%;
        min-height: 36px;
        text-align: center;
        border: 0;
        border-radius: 8px;
        padding: 8px;
        font-size: 12px;
        background: #4a7bd0;
        color: #fff;
        text-decoration: none;
        cursor: pointer;
      }
      .quick-actions a, .quick-actions button { display: inline-flex; align-items: center; justify-content: center; box-sizing: border-box; }
      .quick-actions details.quick-export-menu > summary {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        box-sizing: border-box;
        width: 100%;
        min-height: 36px;
        text-align: center;
        border: 0;
        border-radius: 8px;
        padding: 8px;
        font-size: 12px;
        background: #4a7bd0;
        color: #fff;
        text-decoration: none;
        cursor: pointer;
      }
      .quick-actions .quick-export-panel {
        margin-top: 8px;
        padding: 8px;
        border: 1px solid #3d4658;
        border-radius: 8px;
        background: #2b3445;
        display: grid;
        gap: 8px;
      }
      .quick-actions .quick-export-panel label { font-size: 11px; color: #d6e3f5; }
      .quick-actions .quick-export-panel select {
        width: 100%;
        background: #1f2735;
        border: 1px solid #465268;
        color: #fff;
        border-radius: 6px;
        padding: 8px;
      }
      .sidebar .secondary-action button { min-height: 34px; font-size: 12px; }
      .sidebar .secondary-action[open] > summary { margin-bottom: 8px; }
      .bastion-shell { display: none; }
      .bastion-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        border: 1px solid #6f4d29;
        border-radius: 12px;
        padding: 10px 12px;
        background: linear-gradient(180deg, #1b1512, #100e0d);
      }
      .bastion-brand { font-size: 15px; letter-spacing: 0.08em; text-transform: uppercase; font-weight: 700; }
      .bastion-sub { font-size: 11px; opacity: 0.85; }
      .bastion-micro { display: grid; grid-template-columns: repeat(4, minmax(80px, 1fr)); gap: 8px; }
      .bastion-micro .m { border: 1px solid #5f4221; border-radius: 8px; background: #140f0b; padding: 4px 6px; }
      .bastion-micro .mk { font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.8; }
      .bastion-micro .mv { font-size: 12px; font-weight: 700; margin-top: 2px; }
      .bastion-actions { display: flex; flex-wrap: wrap; gap: 6px; }
      .bastion-actions button {
        padding: 6px 9px;
        border-radius: 8px;
        border: 1px solid #ae7a3b;
        background: linear-gradient(180deg, #7c5530, #5a3d22);
        color: #f7e8cf;
        cursor: pointer;
        font-size: 11px;
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }
      .bastion-grid { display: grid; grid-template-columns: 1fr 320px; gap: 10px; min-height: 0; }
      .bastion-main { display: grid; grid-template-rows: 260px 1fr; gap: 10px; min-height: 0; }
      .bastion-viz { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; min-height: 0; }
      .bastion-card {
        border: 1px solid #6f4d29;
        border-radius: 10px;
        background: linear-gradient(180deg, rgba(34, 26, 20, 0.96), rgba(19, 15, 12, 0.98));
        color: #f0e5d2;
        padding: 8px;
      }
      .bastion-card h3 { margin: 0 0 6px; font-size: 13px; text-transform: uppercase; letter-spacing: .05em; }
      .bastion-bars { display: flex; align-items: flex-end; gap: 7px; min-height: 176px; }
      .bastion-bar-col { width: 22px; display: flex; flex-direction: column; align-items: center; gap: 4px; }
      .bastion-bar {
        width: 100%;
        border-radius: 5px 5px 2px 2px;
        background: linear-gradient(180deg, #d9a254, #815b2e);
        border: 1px solid #9b6b35;
      }
      .bastion-bar-label { font-size: 10px; color: #cbb394; }
      .bastion-sections { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; min-height: 0; }
      .bastion-sections ul { margin: 0; padding-left: 18px; display: grid; gap: 6px; font-size: 13px; }
      .bastion-right { display: grid; gap: 10px; align-content: start; }
      .bastion-feed-list { display: grid; gap: 6px; max-height: 52vh; overflow: auto; }
      .bastion-feed-item { border: 1px solid #554020; border-radius: 8px; background: #120f0c; padding: 6px; font-size: 12px; }
      .bastion-mission-grid { display: grid; gap: 8px; }
      .bastion-mission-item { border: 1px solid #5e4322; border-radius: 8px; padding: 6px; background: #140f0c; }
      .bastion-mission-item .label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; color: #c9b089; }
      .bastion-mission-item .value { margin-top: 3px; font-size: 12px; color: #f2e5cf; line-height: 1.35; }
      .bastion-health-chips { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 4px; }
      .bastion-health-chip {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        border: 1px solid #6a4a27;
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 11px;
        background: #1a130f;
        color: #e8d3b3;
      }
      .bastion-health-chip.ok { border-color: #5f8d67; color: #cbf0d2; background: #122217; }
      .bastion-health-chip.warn { border-color: #9f7a3f; color: #ffe2af; background: #22190f; }
      .bastion-health-chip.bad { border-color: #9a4b3b; color: #ffd0c9; background: #271310; }
      .bastion-attention-list { margin: 0; padding-left: 16px; display: grid; gap: 5px; font-size: 12px; }
      .bastion-attention-list li { margin: 0; color: #ecdcc3; }
      .bastion-terminal {
        border: 1px solid #6f4d29;
        border-radius: 10px;
        background: #09090c;
        padding: 8px;
        display: grid;
        grid-template-rows: auto 1fr auto;
        gap: 8px;
        min-height: 190px;
      }
      .bastion-terminal .head { display: flex; justify-content: space-between; align-items: center; font-size: 12px; letter-spacing: .07em; text-transform: uppercase; font-weight: 700; color: #f1dfc0; }
      .bastion-terminal .log {
        white-space: pre-wrap;
        overflow: auto;
        border: 1px solid #4e3620;
        border-radius: 8px;
        padding: 8px;
        background: #0e0b09;
        color: #dfcca8;
        font-size: 12px;
        min-height: 96px;
      }
      .bastion-terminal .cmds { display: flex; flex-wrap: wrap; gap: 6px; }
      .bastion-terminal .cmds button {
        background: linear-gradient(180deg, #b77c2f, #704819);
        border: 1px solid #d9a254;
        color: #fff4de;
        border-radius: 6px;
        padding: 4px 8px;
        cursor: pointer;
        font-size: 11px;
        text-transform: uppercase;
      }
      body[data-ui-mode="redraw"] {
        background:
          radial-gradient(1200px 720px at 12% -8%, #173c2c 0%, #07140f 52%, #030806 100%),
          repeating-linear-gradient(0deg, rgba(64, 160, 116, 0.08) 0 1px, transparent 1px 4px);
        color: #d7f5e8;
      }
      body[data-ui-mode="redraw"] .sidebar {
        background: linear-gradient(180deg, #0f2a20, #0a1b15 70%, #08120f);
        border-right: 2px solid #2f7a58;
        box-shadow: inset -1px 0 0 rgba(84, 201, 151, 0.35);
        color: #ddfff1;
      }
      body[data-ui-mode="redraw"] .main {
        background: linear-gradient(180deg, #07120d, #050d09);
      }
      body[data-ui-mode="redraw"] .card,
      body[data-ui-mode="redraw"] .ops-health,
      body[data-ui-mode="redraw"] .refresh-run-card,
      body[data-ui-mode="redraw"] .snapshot-card,
      body[data-ui-mode="redraw"] .who-summary,
      body[data-ui-mode="redraw"] .who-why,
      body[data-ui-mode="redraw"] .technique-item,
      body[data-ui-mode="redraw"] .change-row,
      body[data-ui-mode="redraw"] .sidebar-panel,
      body[data-ui-mode="redraw"] .sidebar-card,
      body[data-ui-mode="redraw"] details.compact,
      body[data-ui-mode="redraw"] .interactive-panel,
      body[data-ui-mode="redraw"] .review-strip {
        background: linear-gradient(180deg, rgba(14, 39, 30, 0.96), rgba(9, 26, 20, 0.98));
        border-color: #2e7a58;
        color: #dcf7eb;
        box-shadow: inset 0 0 0 1px rgba(86, 204, 154, 0.16), 0 6px 14px rgba(0, 0, 0, 0.24);
      }
      body[data-ui-mode="redraw"] .section-title,
      body[data-ui-mode="redraw"] .timeline-meta,
      body[data-ui-mode="redraw"] .inline-note,
      body[data-ui-mode="redraw"] .who-meta,
      body[data-ui-mode="redraw"] .source-meta,
      body[data-ui-mode="redraw"] .refresh-run-meta {
        color: #97d8be;
      }
      body[data-ui-mode="redraw"] .badge,
      body[data-ui-mode="redraw"] .status-chip,
      body[data-ui-mode="redraw"] .live-pill {
        background: #0d2a20;
        border-color: #2e7a58;
        color: #d5f7e8;
      }
      body[data-ui-mode="redraw"] .action-button,
      body[data-ui-mode="redraw"] .quick-actions a,
      body[data-ui-mode="redraw"] .quick-actions button,
      body[data-ui-mode="redraw"] .quick-actions details.quick-export-menu > summary,
      body[data-ui-mode="redraw"] button[type="submit"],
      body[data-ui-mode="redraw"] .geo-open-btn.compact {
        background: linear-gradient(180deg, #2a8b61, #1f6849);
        border-color: #72d0a8;
        color: #eafff6;
        letter-spacing: 0.02em;
      }
      body[data-ui-mode="redraw"] .main-tab-btn,
      body[data-ui-mode="redraw"] .notes-tab-btn,
      body[data-ui-mode="redraw"] .adv-tab-btn {
        background: linear-gradient(180deg, #123b2c, #0d2a20);
        border-color: #2e7a58;
        color: #c7f0de;
      }
      body[data-ui-mode="redraw"] .main-tab-btn.active,
      body[data-ui-mode="redraw"] .notes-tab-btn.active,
      body[data-ui-mode="redraw"] .adv-tab-btn.active {
        background: linear-gradient(180deg, #2b9a6c, #227a56);
        border-color: #90e0bf;
        color: #f1fffa;
      }
      body[data-ui-mode="redraw"] .ui-mode-top {
        background: #0d2a20;
        border-color: #2f7a58;
      }
      body[data-ui-mode="redraw"] .ui-mode-top label { color: #a9e7cd; }
      body[data-ui-mode="redraw"] .ui-mode-top select {
        background: #0b2119;
        border-color: #2f7a58;
        color: #daf8ec;
      }
      body[data-ui-mode="redraw"] .actor-link {
        background: #0f2e22;
        border-color: #2f7a58;
        color: #dbf8eb;
      }
      body[data-ui-mode="redraw"] .actor-link.selected {
        background: #1f6f4f;
        border-color: #88e1bd;
        color: #f4fffb;
      }
      body[data-ui-mode="redraw"] .actor-row .actor-remove { color: #a9e7cd; }
      body[data-ui-mode="redraw"] .actor-row .actor-remove:hover { color: #e9fff6; }
      body[data-ui-mode="bastion"] {
        background:
          radial-gradient(1200px 700px at 15% -5%, #2a2014 0%, #0a0807 45%, #050505 100%),
          repeating-linear-gradient(0deg, rgba(168, 34, 34, 0.07) 0 1px, transparent 1px 4px);
        color: #eadfce;
        letter-spacing: 0.01em;
        font-family: "Rajdhani", "Cinzel", "Segoe UI", system-ui, sans-serif;
      }
      body[data-ui-mode="bastion"] .layout { grid-template-columns: 340px 1fr; }
      body[data-ui-mode="bastion"] .sidebar {
        background:
          linear-gradient(180deg, #2c2115, #19130f 65%, #100d0a);
        color: #f0e5d2;
        border-right: 2px solid #6f4d29;
        box-shadow: inset -1px 0 0 rgba(178, 125, 66, 0.45);
      }
      body[data-ui-mode="bastion"] .sidebar-panel,
      body[data-ui-mode="bastion"] .sidebar-card,
      body[data-ui-mode="bastion"] .sidebar details.compact,
      body[data-ui-mode="bastion"] .sidebar .interactive-panel,
      body[data-ui-mode="bastion"] .sidebar .review-strip {
        background:
          linear-gradient(180deg, rgba(62, 45, 28, 0.9), rgba(33, 25, 18, 0.95));
        border: 1px solid #7a5831;
        color: #f0e5d2;
        box-shadow: inset 0 0 0 1px rgba(174, 120, 58, 0.18);
      }
      body[data-ui-mode="bastion"] .main {
        background: linear-gradient(180deg, #120f0d, #0b0a09);
      }
      body[data-ui-mode="bastion"] .card,
      body[data-ui-mode="bastion"] .ops-health,
      body[data-ui-mode="bastion"] .refresh-run-card,
      body[data-ui-mode="bastion"] .snapshot-card,
      body[data-ui-mode="bastion"] .who-summary,
      body[data-ui-mode="bastion"] .who-why,
      body[data-ui-mode="bastion"] .technique-item,
      body[data-ui-mode="bastion"] .change-row {
        background:
          linear-gradient(180deg, rgba(34, 26, 20, 0.96), rgba(19, 15, 12, 0.98));
        border: 1px solid #7a5831;
        color: #f0e5d2;
        box-shadow:
          inset 0 0 0 1px rgba(175, 118, 52, 0.16),
          0 6px 14px rgba(0, 0, 0, 0.28);
        border-radius: 6px;
      }
      body[data-ui-mode="bastion"] .section-title,
      body[data-ui-mode="bastion"] .timeline-meta,
      body[data-ui-mode="bastion"] .inline-note,
      body[data-ui-mode="bastion"] .who-meta,
      body[data-ui-mode="bastion"] .source-meta,
      body[data-ui-mode="bastion"] .refresh-run-meta {
        color: #cbb394;
      }
      body[data-ui-mode="bastion"] .badge {
        border-color: #805936;
        background: #2b2219;
        color: #f4debe;
        border-radius: 4px;
      }
      body[data-ui-mode="bastion"] .action-button,
      body[data-ui-mode="bastion"] .quick-actions a,
      body[data-ui-mode="bastion"] .quick-actions button,
      body[data-ui-mode="bastion"] .quick-actions details.quick-export-menu > summary,
      body[data-ui-mode="bastion"] button[type="submit"] {
        background: linear-gradient(180deg, #7c5530, #5a3d22);
        border-color: #ae7a3b;
        color: #f7e8cf;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        font-weight: 700;
      }
      body[data-ui-mode="bastion"] .ui-mode-top {
        background: #241b13;
        border-color: #7a5831;
      }
      body[data-ui-mode="bastion"] .ui-mode-top label { color: #e7d0af; }
      body[data-ui-mode="bastion"] .ui-mode-top select {
        background: #1a1410;
        border-color: #7a5831;
        color: #f0e5d2;
      }
      body[data-ui-mode="bastion"] .main-tab-btn,
      body[data-ui-mode="bastion"] .notes-tab-btn,
      body[data-ui-mode="bastion"] .adv-tab-btn {
        background: linear-gradient(180deg, #2f2419, #1c1510);
        border-color: #845f35;
        color: #e9d6bc;
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }
      body[data-ui-mode="bastion"] .main-tab-btn.active,
      body[data-ui-mode="bastion"] .notes-tab-btn.active,
      body[data-ui-mode="bastion"] .adv-tab-btn.active {
        background: linear-gradient(180deg, #8b612f, #6b4926);
        border-color: #d19a57;
        color: #fff3e0;
        box-shadow: 0 0 0 1px rgba(214, 156, 88, 0.35);
      }
      body[data-ui-mode="bastion"] .ataglance-metric,
      body[data-ui-mode="bastion"] .who-kpi,
      body[data-ui-mode="bastion"] .review-metric,
      body[data-ui-mode="bastion"] .ops-health-item,
      body[data-ui-mode="bastion"] .ledger-item,
      body[data-ui-mode="bastion"] .refresh-run-card {
        background: #221912;
        border-color: #6f4d29;
      }
      body[data-ui-mode="bastion"] .live-pill,
      body[data-ui-mode="bastion"] .status-chip {
        background: #221911;
        border-color: #6f4d29;
        color: #e6d1b2;
      }
      body[data-ui-mode="bastion"] .interactive-panel,
      body[data-ui-mode="bastion"] .review-strip,
      body[data-ui-mode="bastion"] details.compact {
        background: #1b1410;
        border-color: #6f4d29;
      }
      body[data-ui-mode="bastion"] .ledger-controls input,
      body[data-ui-mode="bastion"] .ledger-controls select,
      body[data-ui-mode="bastion"] .obs-row input,
      body[data-ui-mode="bastion"] .obs-row select,
      body[data-ui-mode="bastion"] .obs-row textarea {
        background: #130f0c;
        border-color: #6f4d29;
        color: #f0e5d2;
      }
      body[data-ui-mode="bastion"] .geo-open-btn.compact {
        background: linear-gradient(180deg, #7c5530, #5a3d22);
        border-color: #ae7a3b;
        color: #f7e8cf;
      }
      body[data-ui-mode="bastion"] .actor-link {
        background: #241a12;
        border-color: #6f4d29;
        color: #f0e5d2;
      }
      body[data-ui-mode="bastion"] .actor-link.selected {
        background: #5b3f23;
        border-color: #d19a57;
        color: #fff2de;
        box-shadow: inset 0 0 0 1px rgba(214, 156, 88, 0.35);
      }
      body[data-ui-mode="bastion"] .actor-row .actor-remove { color: #d8be98; }
      body[data-ui-mode="bastion"] .actor-row .actor-remove:hover { color: #fff0d7; }
      body[data-ui-mode="bastion"] .main { position: relative; overflow: visible; }
      body[data-ui-mode="bastion"] .main::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        opacity: 0.11;
        background-image:
          linear-gradient(rgba(183,124,47,.18) 1px, transparent 1px),
          linear-gradient(90deg, rgba(183,124,47,.14) 1px, transparent 1px);
        background-size: 38px 38px;
      }
      body[data-ui-mode="bastion"] .top-status-row,
      body[data-ui-mode="bastion"] .dashboard { display: none; }
      body[data-ui-mode="bastion"] .bastion-shell {
        position: relative;
        z-index: 1;
        display: grid;
        grid-template-rows: auto 1fr auto;
        gap: 10px;
        min-height: calc(100vh - 120px);
      }
      @media (max-width: 1500px) {
        .bastion-grid { grid-template-columns: 1fr; }
        .bastion-right { grid-template-columns: 1fr 1fr; }
      }
      @media (max-width: 1120px) {
        .bastion-viz, .bastion-sections { grid-template-columns: 1fr; }
        .bastion-right { grid-template-columns: 1fr; }
        .bastion-micro { grid-template-columns: repeat(2, minmax(80px, 1fr)); }
      }
      .sidebar .interactive-panel { background: #2b3445; border-color: #3d4658; color: #fff; }
      .sidebar .review-strip { background: #2b3445; border-color: #3d4658; }
      .sidebar .review-metric { background: #1f2735; border-color: #3d4658; }
      .sidebar .review-metric .label { color: #b8c7de; }
      .sidebar .review-metric .value { color: #ffffff; }
      .sidebar .review-meta { color: #c7d4ea; }
      .sidebar .review-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .sidebar .review-metric { min-width: 0; }
      .sidebar .review-metric .value { font-size: 13px; overflow-wrap: anywhere; }
      .sidebar .review-actions { gap: 6px; }
      .sidebar .review-actions button { flex: 1 1 140px; }
      .sidebar .ledger-controls label { color: #d6e3f5; }
      .sidebar .ledger-controls input,
      .sidebar .ledger-controls select,
      .sidebar .obs-row input,
      .sidebar .obs-row select,
      .sidebar .obs-row textarea {
        background: #1f2735;
        border-color: #465268;
        color: #fff;
      }
      .sidebar .ledger-item { background: #1f2735; border-color: #3d4658; }
      .sidebar .ledger-head,
      .sidebar .ledger-body,
      .sidebar .ledger-link a,
      .sidebar .ledger-link span,
      .sidebar .observation-meta,
      .sidebar .timeline-empty,
      .sidebar .ledger-count,
      .sidebar .inline-note { color: #d6e3f5; }
      .sidebar .filter-chip { background: #1f2735; border-color: #4f5e77; color: #fff; }
      .sidebar .obs-actions button,
      .sidebar .ledger-actions button,
      .sidebar .ledger-actions a,
      .sidebar .review-actions button { background: #1f2735; border-color: #4f5e77; color: #fff; }
      .req-item { border: 1px solid #e3e3e3; border-radius: 8px; padding: 8px; margin-bottom: 8px; background: #fcfcff; }
      .req-item p { margin: 6px 0; font-size: 13px; line-height: 1.35; }
      .req-item form { margin-top: 6px; }
      .req-validation { margin-top: 6px; font-size: 11px; color: #334155; background: #f5f8ff; border: 1px solid #d9e3f7; border-radius: 6px; padding: 6px; }
      .live-pill { border: 1px solid #c7d4ea; border-radius: 999px; padding: 4px 8px; font-size: 11px; color: #334155; background: #f8fbff; }
      .interactive-panel { border: 1px solid #dce7f8; border-radius: 8px; background: #f9fcff; padding: 8px; margin-top: 8px; }
      .interactive-panel h4 { margin: 0 0 6px; font-size: 13px; }
      .filter-row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 8px; }
      .filter-row select, .filter-row button, .filter-row input { padding: 5px 8px; border-radius: 6px; border: 1px solid #c7d4ea; background: #fff; font-size: 12px; }
      .filter-chips { display: flex; flex-wrap: wrap; gap: 6px; margin: 6px 0 8px; }
      .filter-chip { display: inline-flex; align-items: center; gap: 5px; border: 1px solid #b9cae7; border-radius: 999px; padding: 2px 8px; font-size: 11px; background: #f3f8ff; color: #1f2937; }
      .filter-chip button { border: 0; background: transparent; font-size: 12px; cursor: pointer; color: #334155; padding: 0; line-height: 1; }
      .timeline-table { width: 100%; border-collapse: collapse; font-size: 12px; }
      .timeline-table th, .timeline-table td { border-bottom: 1px solid #e3ebf8; text-align: left; padding: 6px; vertical-align: top; }
      .timeline-table tr:hover { background: #f3f8ff; }
      .timeline-empty { margin-top: 8px; font-size: 12px; color: #475569; }
      .observation-meta { margin-top: 4px; font-size: 11px; color: #475569; }
      .observation-guidance { margin-top: 2px; font-size: 11px; color: #7a3e00; }
      .observation-history { margin-top: 6px; border-top: 1px dashed #cad6ea; padding-top: 6px; font-size: 11px; color: #334155; }
      .observation-history-item { margin-top: 4px; padding: 4px 6px; border: 1px solid #dce7f8; border-radius: 6px; background: #fff; }
      .observation-history-head { font-size: 10px; color: #5b677a; margin-bottom: 2px; }
      .obs-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
      .obs-row input, .obs-row select, .obs-row textarea { width: 100%; box-sizing: border-box; padding: 6px; border-radius: 6px; border: 1px solid #cdd8ea; font-size: 12px; }
      .obs-row textarea { min-height: 70px; resize: vertical; grid-column: 1 / -1; }
      .obs-actions { display: flex; gap: 6px; align-items: center; margin-top: 6px; }
      .obs-actions button,
      .ledger-actions button,
      .ledger-actions a,
      .review-actions button {
        border: 1px solid #b8c7e2;
        background: #f7fbff;
        border-radius: 6px;
        padding: 5px 8px;
        font-size: 12px;
        cursor: pointer;
        min-height: 30px;
      }
      .ledger-list { display: grid; gap: 8px; margin-top: 8px; }
      .ledger-item { border: 1px solid #dce7f8; border-radius: 8px; background: #fbfdff; padding: 8px; }
      .ledger-head { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 4px; font-size: 11px; color: #475569; }
      .ledger-body { font-size: 13px; line-height: 1.35; color: #1f2937; margin-bottom: 4px; }
      .ledger-link { font-size: 12px; }
      .ledger-controls { display: grid; grid-template-columns: repeat(5, minmax(120px, 1fr)); gap: 8px; align-items: end; margin-top: 8px; }
      .ledger-controls label { display: block; font-size: 11px; color: #334155; margin-bottom: 3px; }
      .ledger-controls input, .ledger-controls select { width: 100%; box-sizing: border-box; padding: 6px; border: 1px solid #cdd8ea; border-radius: 6px; background: #fff; font-size: 12px; }
      .ledger-actions { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; margin-top: 8px; }
      .ledger-actions a { text-decoration: none; color: #1f2937; }
      .ledger-count { font-size: 11px; color: #475569; }
      .review-strip { border: 1px solid #d9e7fb; border-radius: 8px; background: #f7fbff; padding: 8px; margin-bottom: 8px; }
      .review-strip h4 { margin: 0 0 6px; font-size: 13px; }
      .review-grid { display: grid; grid-template-columns: repeat(4, minmax(120px, 1fr)); gap: 8px; }
      .review-metric { border: 1px solid #dce7f8; border-radius: 8px; background: #fff; padding: 6px; }
      .review-metric .label { font-size: 10px; text-transform: uppercase; letter-spacing: .02em; color: #64748b; }
      .review-metric .value { font-size: 14px; font-weight: 600; margin-top: 2px; color: #0f172a; }
      .review-actions { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; margin-top: 8px; }
      .review-actions button { background: #fff; }
      .review-meta { font-size: 11px; color: #475569; }
      .live-controls { display: inline-flex; gap: 6px; align-items: center; }
      .live-controls button { border: 1px solid #c7d4ea; background: #fff; border-radius: 999px; font-size: 11px; padding: 4px 8px; cursor: pointer; }
      .ops-health { border: 1px solid #d9e7fb; border-radius: 8px; background: #f7fbff; padding: 8px; margin-top: 8px; }
      .ops-health h4 { margin: 0 0 6px; font-size: 13px; }
      .ops-health-grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 6px; }
      .ops-health-item { border: 1px solid #dce7f8; border-radius: 8px; background: #fff; padding: 6px; min-width: 0; }
      .ops-health-item .label { font-size: 10px; text-transform: uppercase; letter-spacing: .02em; color: #64748b; }
      .ops-health-item .value { font-size: 13px; font-weight: 600; color: #0f172a; margin-top: 2px; overflow-wrap: anywhere; }
      .refresh-activity-head { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 6px; }
      .refresh-activity-actions { display: inline-flex; gap: 6px; align-items: center; flex-wrap: wrap; }
      .refresh-activity-actions button {
        border: 1px solid #b8c7e2;
        background: #f7fbff;
        border-radius: 6px;
        padding: 5px 8px;
        font-size: 12px;
        cursor: pointer;
        min-height: 30px;
      }
      .refresh-activity-live { font-size: 11px; color: #334155; border: 1px solid #c9d7ef; border-radius: 999px; padding: 3px 8px; background: #eef5ff; }
      .refresh-activity-live.running { background: #eef6ff; border-color: #a7c2ea; color: #0f3d80; }
      .refresh-activity-live.ready { background: #eaf9ef; border-color: #9fd2ac; color: #14532d; }
      .refresh-activity-live.error { background: #fff0ef; border-color: #e4b1ad; color: #7f1d1d; }
      .refresh-activity-help { margin: 4px 0 6px; font-size: 12px; color: #334155; }
      .refresh-activity-meta { font-size: 11px; color: #475569; margin-bottom: 6px; }
      .refresh-run-list { display: grid; gap: 7px; }
      .refresh-run-card { border: 1px solid #dce7f8; border-radius: 8px; background: #fff; padding: 8px; }
      .refresh-run-card.is-running { border-color: #a7c2ea; background: #f7fbff; }
      .refresh-run-card.is-error { border-color: #e4b1ad; background: #fff7f6; }
      .refresh-run-top { display: flex; justify-content: space-between; align-items: baseline; gap: 8px; flex-wrap: wrap; }
      .refresh-run-top strong { font-size: 13px; color: #0f172a; }
      .refresh-run-meta { font-size: 11px; color: #475569; }
      .refresh-run-message { margin-top: 4px; font-size: 12px; color: #1f2937; }
      .refresh-phase-list { margin: 6px 0 0; padding-left: 16px; }
      .refresh-phase-list li { margin: 3px 0; font-size: 12px; color: #1f2937; }
      .refresh-empty { border: 1px dashed #c7d8f0; border-radius: 8px; padding: 8px; background: #fafdff; font-size: 12px; color: #334155; }
      .geo-open-wrap { margin-top: 8px; }
      .geo-open-btn {
        width: 100%;
        min-height: 34px;
        border: 1px solid #4f5e77;
        border-radius: 8px;
        background: #1f2735;
        color: #fff;
        font-size: 12px;
        cursor: pointer;
      }
      .geo-modal {
        position: fixed;
        inset: 0;
        z-index: 70;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(15, 23, 42, 0.55);
        padding: 16px;
      }
      .geo-modal.open { display: flex; }
      .geo-modal-card {
        width: min(1200px, calc(100vw - 24px));
        max-height: 86vh;
        overflow: auto;
        border: 1px solid #d6e2f5;
        border-radius: 10px;
        background: #fff;
        box-shadow: 0 14px 36px rgba(15, 23, 42, 0.22);
        padding: 10px;
      }
      .geo-modal-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
      }
      .geo-modal-head h3 {
        margin: 0;
        font-size: 15px;
      }
      .geo-modal-head button {
        border: 1px solid #c6d4ea;
        border-radius: 8px;
        background: #f8fbff;
        color: #1f2937;
        padding: 6px 10px;
        cursor: pointer;
      }
      .quick-note-form { display: grid; gap: 8px; }
      .quick-note-form label { display: grid; gap: 4px; font-size: 12px; color: #334155; }
      .quick-note-form input,
      .quick-note-form select,
      .quick-note-form textarea {
        width: 100%;
        box-sizing: border-box;
        padding: 7px;
        border: 1px solid #cdd8ea;
        border-radius: 6px;
        background: #fff;
        font-size: 12px;
      }
      .quick-note-form textarea { min-height: 100px; resize: vertical; }
      .quick-note-actions { display: flex; justify-content: flex-end; gap: 8px; }
      .quick-note-actions button {
        border: 1px solid #c6d4ea;
        border-radius: 8px;
        background: #f8fbff;
        color: #1f2937;
        padding: 6px 10px;
        cursor: pointer;
      }
      .quick-note-status { font-size: 12px; color: #334155; min-height: 18px; }
      .geo-grid {
        display: grid;
        grid-template-columns: 1fr 360px;
        gap: 10px;
      }
      .geo-canvas-wrap {
        border: 1px solid #dce7f8;
        border-radius: 8px;
        background: #f8fbff;
        padding: 8px;
      }
      #geo-map-canvas {
        width: 100%;
        height: 560px;
        border: 1px solid #c9d7ef;
        border-radius: 8px;
        background: #dbeafe;
      }
      .geo-side {
        border: 1px solid #dce7f8;
        border-radius: 8px;
        background: #f8fbff;
        padding: 8px;
      }
      .geo-region-list { margin-top: 8px; display: grid; gap: 7px; }
      .geo-region-item {
        border: 1px solid #d8e1ef;
        border-radius: 8px;
        background: #fff;
        padding: 8px;
      }
      .geo-actor-pick {
        width: 100%;
        border: 1px solid #d8e1ef;
        border-radius: 8px;
        background: #fff;
        text-align: left;
        padding: 8px;
        cursor: pointer;
      }
      .geo-actor-pick:hover { background: #f6fbff; }
      .geo-actor-pick strong { display: block; font-size: 13px; color: #0f172a; }
      .geo-actor-pick .meta { font-size: 11px; color: #475569; margin-top: 2px; }
      .geo-region-item button {
        margin-top: 6px;
        border: 1px solid #b8c7e2;
        background: #f7fbff;
        border-radius: 6px;
        padding: 5px 8px;
        font-size: 12px;
        cursor: pointer;
      }
      .geo-actor-detail {
        margin-top: 10px;
        border: 1px solid #dce7f8;
        border-radius: 8px;
        background: #ffffff;
        padding: 8px;
      }
      @media (max-width: 1100px) {
        .geo-grid { grid-template-columns: 1fr; }
      }
      .merge-row { margin-top: 8px; padding-top: 8px; border-top: 1px dashed #4f5e77; }
      .merge-list { margin: 6px 0 0; padding: 0; list-style: none; display: grid; gap: 6px; }
      .merge-list li { margin: 0; }
      .merge-list form { display: grid; gap: 6px; }
      .merge-list button { min-height: 32px; font-size: 12px; }
      @media (max-width: 1180px) {
        .workspace-grid { grid-template-columns: 1fr; }
        .workspace-grid .pane { min-height: auto; overflow: visible; }
        .workspace-grid { grid-template-rows: auto; }
        .ataglance-strip { grid-template-columns: repeat(2, minmax(120px, 1fr)); }
        .timeline-ataglance { grid-template-columns: 1fr; }
        .kpi-strip { grid-template-columns: repeat(2, minmax(120px, 1fr)); }
        .snapshot-grid { grid-template-columns: 1fr; }
        .who-kpis { grid-template-columns: 1fr; }
        .technique-grid { grid-template-columns: 1fr; }
      }
      @media (max-width: 960px) {
        .layout { grid-template-columns: 1fr; min-height: auto; }
        .main { overflow: visible; }
        .top-status-row, .ataglance-strip, .workspace-grid .pane .section-title { position: static; }
        .dashboard { height: auto; }
        .status-chip { max-width: 100%; width: 100%; }
        .obs-row { grid-template-columns: 1fr; }
        .ledger-controls { grid-template-columns: 1fr 1fr; }
        .review-grid { grid-template-columns: 1fr 1fr; }
      }
      /*  IOC tab  */
      .ioc-table-wrap { display: flex; flex-direction: column; gap: 10px; }
      .ioc-row { padding: 10px; border: 1px solid #3d4658; border-radius: 8px; background: #1e2938; }
      .ioc-row-head { display: flex; align-items: center; flex-wrap: wrap; gap: 6px; margin-bottom: 4px; }
      .ioc-value { font-family: monospace; font-size: 12px; color: #e2eaf5; word-break: break-all; }
      .ioc-source { font-size: 11px; color: #8a9ab5; }
      .ioc-row-meta { font-size: 11px; color: #6b7e99; margin-bottom: 4px; }
      .ioc-status-form { display: flex; gap: 6px; flex-wrap: wrap; }
      .ioc-enrich-links { display: flex; gap: 4px; margin-left: 4px; }
      .enrich-link {
        display: inline-block; padding: 1px 6px; border-radius: 4px;
        background: #2a3f5e; color: #7eb5f5; font-size: 10px; text-decoration: none;
        border: 1px solid #3d5a7a;
      }
      .enrich-link:hover { background: #35527f; color: #fff; }
      /*  Visuals tab  */
      .visuals-placeholder-grid {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 14px; margin-top: 12px;
      }
      .visuals-placeholder {
        padding: 16px; border: 1px dashed #4a5a72; border-radius: 8px;
        background: #1a2535; color: #8a9ab5;
      }
      .visuals-placeholder-title { font-weight: 600; color: #c0cfe8; margin-bottom: 6px; font-size: 13px; }
      .visuals-placeholder-desc { font-size: 11px; line-height: 1.5; }
      /*  Utility  */
      .btn-secondary {
        display: inline-block; padding: 7px 14px; border-radius: 6px;
        background: #253348; color: #a8bdd4; border: 1px solid #3d4f66;
        text-decoration: none; font-size: 12px;
      }
      .btn-secondary:hover { background: #35527f; color: #fff; }
    </style>
  </head>
  <body {% if notebook %}data-actor-id="{{ notebook.actor.id }}"{% endif %}>
    <div class="layout">
      <aside class="sidebar">
        <h1>ActorWatch</h1>
        <div class="sidebar-panel">
          <div class="actors-head">
            <h3>Actors</h3>
            <button id="geo-map-open" class="geo-open-btn compact" type="button">Map</button>
          </div>
          <div class="actors-subhead">Tracked</div>
          <ul class="actor-list">
            {% for actor in actors %}
            <li>
              <div class="actor-row">
                <a class="actor-link {% if selected_actor_id == actor.id %}selected{% endif %}" href="/?actor_id={{ actor.id }}">
                  <span class="actor-name">{{ actor.display_name }}</span>
                  <span class="actor-scope">Updated {{ actor.last_updated_label or 'Unknown' }}</span>
                </a>
                <form method="post" action="/actors/{{ actor.id }}/untrack">
                  <button type="submit" class="actor-remove" aria-label="Untrack {{ actor.display_name }}">remove</button>
                </form>
              </div>
            </li>
            {% else %}
            <li><span class="actor-scope">No tracked actors yet.</span></li>
            {% endfor %}
          </ul>
          <hr class="actors-divider" />
          <div class="actors-subhead">Add actor</div>
          <form id="add-actor-form" method="post" action="/actors/new">
            <div class="actor-autocomplete-wrap">
              <input id="add-actor-input" type="text" name="display_name" placeholder="Display name" autocomplete="off" required />
              <div id="actor-autocomplete-list" class="actor-autocomplete-list" role="listbox" aria-label="Actor suggestions" hidden></div>
            </div>
            <button class="action-button" type="submit">Add actor</button>
            <small id="actor-autocomplete-hint" class="actor-autocomplete-hint"></small>
          </form>
          {% if duplicate_actor_groups %}
          <div class="merge-row">
            <small>Duplicate actor records detected. Use one-click merge below.</small>
            <ul class="merge-list">
              {% for group in duplicate_actor_groups %}
              {% for source_actor in group.source_actors %}
              <li>
                <form method="post" action="/actors/{{ group.target_actor.id }}/merge">
                  <input type="hidden" name="source_actor_id" value="{{ source_actor.id }}" />
                  <button type="submit">Merge {{ source_actor.display_name }} into {{ group.target_actor.display_name }}</button>
                </form>
              </li>
              {% endfor %}
              {% endfor %}
            </ul>
          </div>
          {% endif %}
        </div>

        {% if notebook %}
        <div class="sidebar-card">
          <h3>Quick actions</h3>
          <div class="quick-actions">
            <form method="post" action="/actors/{{ notebook.actor.id }}/observations/auto-snapshot">
              <button type="submit">Auto-note changes</button>
            </form>
            <button id="workflow-tour-open" type="button">Workflow tour</button>
            <a id="open-timeline-details-link" href="/actors/{{ notebook.actor.id }}/timeline/details">Open timeline details</a>
            <details class="quick-export-menu" id="analyst-pack-menu">
              <summary id="analyst-pack-menu-trigger">Export analyst pack</summary>
              <div class="quick-export-panel">
                {% if actors %}
                <label for="analyst-pack-actor-select">Select actor</label>
                <select id="analyst-pack-actor-select" aria-label="Select tracked actor for analyst pack export">
                  {% for actor in actors %}
                  <option value="{{ actor.id }}" {% if selected_actor_id == actor.id %}selected{% endif %}>{{ actor.display_name }}</option>
                  {% endfor %}
                </select>
                {% endif %}
                <a id="analyst-pack-export-json-link" href="/actors/{{ notebook.actor.id }}/export/analyst-pack.json" target="_blank" rel="noreferrer">Export JSON pack</a>
                <a id="analyst-pack-export-pdf-link" href="/actors/{{ notebook.actor.id }}/export/analyst-pack.pdf" target="_blank" rel="noreferrer">Export PDF pack</a>
                <a href="/actors/{{ notebook.actor.id }}/reports/exec" target="_blank" rel="noreferrer">Executive report (JSON)</a>
                <a href="/actors/{{ notebook.actor.id }}/reports/soc" target="_blank" rel="noreferrer">SOC report (JSON)</a>
                <a href="/actors/{{ notebook.actor.id }}/reports/ir" target="_blank" rel="noreferrer">IR report (JSON)</a>
                <a href="/actors/{{ notebook.actor.id }}/export/tasks.json" target="_blank" rel="noreferrer">Tasks export (JSON)</a>
                <a href="/actors/{{ notebook.actor.id }}/export/tasks.csv" target="_blank" rel="noreferrer">Tasks export (CSV)</a>
                <a href="/actors/{{ notebook.actor.id }}/export/outcomes.json" target="_blank" rel="noreferrer">Outcomes export (JSON)</a>
                <a href="/actors/{{ notebook.actor.id }}/export/outcomes.csv" target="_blank" rel="noreferrer">Outcomes export (CSV)</a>
                <a href="/actors/{{ notebook.actor.id }}/export/coverage.json" target="_blank" rel="noreferrer">Coverage export (JSON)</a>
                <a href="/actors/{{ notebook.actor.id }}/export/coverage.csv" target="_blank" rel="noreferrer">Coverage export (CSV)</a>
                <a href="/actors/{{ notebook.actor.id }}/export/evidence-bundle.json" target="_blank" rel="noreferrer">Evidence bundle (JSON)</a>
                <a href="/actors/{{ notebook.actor.id }}/export/evidence-bundle.csv" target="_blank" rel="noreferrer">Evidence bundle (CSV)</a>
                <a href="/actors/{{ notebook.actor.id }}/export/delta-brief.json?period=weekly" target="_blank" rel="noreferrer">Delta brief (Weekly JSON)</a>
                <a href="/actors/{{ notebook.actor.id }}/export/delta-brief.json?period=monthly" target="_blank" rel="noreferrer">Delta brief (Monthly JSON)</a>
              </div>
            </details>
          </div>
          <form id="refresh-actor-form" method="post" action="/actors/{{ notebook.actor.id }}/refresh" hidden>
            <button id="refresh-actor-button" type="submit" hidden aria-hidden="true" tabindex="-1">Refresh actor</button>
          </form>
          <details class="compact secondary-action">
            <summary class="action-button">More actions</summary>
            <form method="post" action="/actors/{{ notebook.actor.id }}/requirements/generate">
              <label for="priority_mode">Priority Mode</label>
              <select id="priority_mode" name="priority_mode">
                <option value="Strategic" {% if notebook.requirements_context.priority_mode == 'Strategic' %}selected{% endif %}>Strategic (PIR)</option>
                <option value="Operational" {% if notebook.requirements_context.priority_mode == 'Operational' %}selected{% endif %}>Operational (GIR)</option>
                <option value="Tactical" {% if notebook.requirements_context.priority_mode == 'Tactical' %}selected{% endif %}>Tactical (IR)</option>
              </select>
              <label for="org_context">Org Context</label>
              <textarea id="org_context" name="org_context" rows="4" placeholder="Critical assets, business unit, environment, constraints...">{{ notebook.requirements_context.org_context }}</textarea>
              <button class="action-button" type="submit">Generate PIR/GIR/IR</button>
            </form>
            <form method="post" action="/actors/{{ notebook.actor.id }}/tracking-intent">
              <label for="tracking-updated-by">Updated by</label>
              <input id="tracking-updated-by" name="updated_by" type="text" placeholder="Analyst name" />
              <label for="tracking-why-track">Why track this actor</label>
              <textarea id="tracking-why-track" name="why_track" rows="3" placeholder="Mission-level reason for tracking">{{ notebook.tracking_intent.why_track if notebook.tracking_intent else '' }}</textarea>
              <label for="tracking-mission-impact">Mission impact</label>
              <textarea id="tracking-mission-impact" name="mission_impact" rows="2" placeholder="Business/security impact">{{ notebook.tracking_intent.mission_impact if notebook.tracking_intent else '' }}</textarea>
              <label for="tracking-focus">Intelligence focus</label>
              <textarea id="tracking-focus" name="intelligence_focus" rows="2" placeholder="What we need to learn">{{ notebook.tracking_intent.intelligence_focus if notebook.tracking_intent else '' }}</textarea>
              <label for="tracking-key-questions">Key questions (one per line)</label>
              <textarea id="tracking-key-questions" name="key_questions" rows="4" placeholder="Question 1&#10;Question 2">{% if notebook.tracking_intent and notebook.tracking_intent.key_questions %}{{ notebook.tracking_intent.key_questions | join('\n') }}{% endif %}</textarea>
              <label for="tracking-priority">Priority</label>
              <select id="tracking-priority" name="priority">
                {% set tracking_priority = (notebook.tracking_intent.priority if notebook.tracking_intent else 'medium') %}
                <option value="low" {% if tracking_priority == 'low' %}selected{% endif %}>Low</option>
                <option value="medium" {% if tracking_priority == 'medium' %}selected{% endif %}>Medium</option>
                <option value="high" {% if tracking_priority == 'high' %}selected{% endif %}>High</option>
                <option value="critical" {% if tracking_priority == 'critical' %}selected{% endif %}>Critical</option>
              </select>
              <label for="tracking-impact">Impact</label>
              <select id="tracking-impact" name="impact">
                {% set tracking_impact = (notebook.tracking_intent.impact if notebook.tracking_intent else 'medium') %}
                <option value="low" {% if tracking_impact == 'low' %}selected{% endif %}>Low</option>
                <option value="medium" {% if tracking_impact == 'medium' %}selected{% endif %}>Medium</option>
                <option value="high" {% if tracking_impact == 'high' %}selected{% endif %}>High</option>
                <option value="critical" {% if tracking_impact == 'critical' %}selected{% endif %}>Critical</option>
              </select>
              <label for="tracking-cadence">Review cadence (days)</label>
              <input id="tracking-cadence" name="review_cadence_days" type="number" min="1" max="365" value="{{ notebook.tracking_intent.review_cadence_days if notebook.tracking_intent else 30 }}" />
              <label for="tracking-min-sources">Confirmation min sources</label>
              <input id="tracking-min-sources" name="confirmation_min_sources" type="number" min="1" max="10" value="{{ notebook.tracking_intent.confirmation_min_sources if notebook.tracking_intent else 2 }}" />
              <label for="tracking-max-age">Confirmation max age (days)</label>
              <input id="tracking-max-age" name="confirmation_max_age_days" type="number" min="1" max="365" value="{{ notebook.tracking_intent.confirmation_max_age_days if notebook.tracking_intent else 45 }}" />
              <label for="tracking-criteria">Confirmation criteria</label>
              <textarea id="tracking-criteria" name="confirmation_criteria" rows="2" placeholder="What counts as confirmed">{{ notebook.tracking_intent.confirmation_criteria if notebook.tracking_intent else '' }}</textarea>
              <button class="action-button" type="submit">Save tracking intent</button>
            </form>
            <form method="post" action="/actors/{{ notebook.actor.id }}/confirm-assessment">
              <label for="confirm-analyst">Confirm assessment by</label>
              <input id="confirm-analyst" name="analyst" type="text" placeholder="Analyst name" required />
              <label for="confirm-note">Confirmation note</label>
              <textarea id="confirm-note" name="note" rows="2" placeholder="Short confirmation rationale"></textarea>
              <button class="action-button" type="submit">Mark actor assessment confirmed</button>
            </form>
            <form method="post" action="/actors/{{ notebook.actor.id }}/collection-plan">
              <label for="cp-updated-by">Collection plan updated by</label>
              <input id="cp-updated-by" name="updated_by" type="text" placeholder="Analyst name" />
              <label for="cp-frequency">Monitor frequency</label>
              <select id="cp-frequency" name="monitor_frequency">
                <option value="hourly" {% if notebook.collection_plan and notebook.collection_plan.monitor_frequency == 'hourly' %}selected{% endif %}>Hourly</option>
                <option value="daily" {% if notebook.collection_plan and notebook.collection_plan.monitor_frequency != 'hourly' and notebook.collection_plan.monitor_frequency != 'weekly' %}selected{% endif %}>Daily</option>
                <option value="weekly" {% if notebook.collection_plan and notebook.collection_plan.monitor_frequency == 'weekly' %}selected{% endif %}>Weekly</option>
              </select>
              <label for="cp-sources">Monitored sources (one per line)</label>
              <textarea id="cp-sources" name="monitored_sources" rows="3" placeholder="Vendor blog&#10;CERT feed">{% if notebook.collection_plan and notebook.collection_plan.monitored_sources %}{{ notebook.collection_plan.monitored_sources | join('\n') }}{% endif %}</textarea>
              <label for="cp-triggers">Trigger conditions (one per line)</label>
              <textarea id="cp-triggers" name="trigger_conditions" rows="3" placeholder="New domain IOC&#10;New technique">{% if notebook.collection_plan and notebook.collection_plan.trigger_conditions %}{{ notebook.collection_plan.trigger_conditions | join('\n') }}{% endif %}</textarea>
              <label for="cp-alerts">Alert subscriptions (one per line)</label>
              <textarea id="cp-alerts" name="alert_subscriptions" rows="3" placeholder="Email to SOC&#10;Ticket queue">{% if notebook.collection_plan and notebook.collection_plan.alert_subscriptions %}{{ notebook.collection_plan.alert_subscriptions | join('\n') }}{% endif %}</textarea>
              <label for="cp-alert-enabled">
                <input id="cp-alert-enabled" name="alert_notifications_enabled" type="checkbox" value="1" {% if not notebook.collection_plan or notebook.collection_plan.alert_notifications_enabled %}checked{% endif %} />
                Send alert notifications (turn off to keep alerts in queue only)
              </label>
              <button class="action-button" type="submit">Save collection plan</button>
            </form>
            <form method="post" action="/actors/{{ notebook.actor.id }}/report-preferences">
              <label for="rp-updated-by">Report preferences updated by</label>
              <input id="rp-updated-by" name="updated_by" type="text" placeholder="Analyst name" />
              <label for="rp-enabled">
                <input id="rp-enabled" name="delta_brief_enabled" type="checkbox" value="1" {% if not notebook.report_preferences or notebook.report_preferences.delta_brief_enabled %}checked{% endif %} />
                Enable recurring delta brief
              </label>
              <label for="rp-period">Delta brief period</label>
              <select id="rp-period" name="delta_brief_period">
                <option value="weekly" {% if not notebook.report_preferences or notebook.report_preferences.delta_brief_period == 'weekly' %}selected{% endif %}>Weekly</option>
                <option value="monthly" {% if notebook.report_preferences and notebook.report_preferences.delta_brief_period == 'monthly' %}selected{% endif %}>Monthly</option>
              </select>
              <label for="rp-window">Window (days)</label>
              <input id="rp-window" name="delta_brief_window_days" type="number" min="1" max="365" value="{{ notebook.report_preferences.delta_brief_window_days if notebook.report_preferences else 7 }}" />
              <button class="action-button" type="submit">Save report preferences</button>
            </form>
            <form method="post" action="/actors/{{ notebook.actor.id }}/tasks">
              <label for="task-title">New task</label>
              <input id="task-title" name="title" type="text" placeholder="Investigate ..." required />
              <label for="task-details">Task details</label>
              <textarea id="task-details" name="details" rows="2" placeholder="What must be done"></textarea>
              <label for="task-owner">Owner</label>
              <input id="task-owner" name="owner" type="text" placeholder="SOC Tier 2" />
              <label for="task-priority">Priority</label>
              <select id="task-priority" name="priority">
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
                <option value="critical">Critical</option>
              </select>
              <label for="task-due-date">Due date</label>
              <input id="task-due-date" name="due_date" type="date" />
              <button class="action-button" type="submit">Create task</button>
            </form>
            <form method="post" action="/actors/{{ notebook.actor.id }}/outcomes">
              <label for="outcome-type">Operational outcome</label>
              <select id="outcome-type" name="outcome_type">
                <option value="detection_created">Detection created</option>
                <option value="hunt_ran">Hunt ran</option>
                <option value="finding">Finding</option>
                <option value="false_positive">False positive</option>
                <option value="mitigation_applied">Mitigation applied</option>
              </select>
              <label for="outcome-summary">Summary</label>
              <textarea id="outcome-summary" name="summary" rows="2" placeholder="What happened and why it matters" required></textarea>
              <label for="outcome-result">Result</label>
              <input id="outcome-result" name="result" type="text" placeholder="e.g., blocked, no hit, escalated" />
              <label for="outcome-technique">Linked technique (optional)</label>
              <input id="outcome-technique" name="linked_technique_id" type="text" placeholder="T1059" />
              <label for="outcome-evidence">Evidence reference</label>
              <input id="outcome-evidence" name="evidence_ref" type="text" placeholder="Case id / URL / query ref" />
              <label for="outcome-created-by">Created by</label>
              <input id="outcome-created-by" name="created_by" type="text" placeholder="Analyst name" />
              <button class="action-button" type="submit">Record outcome</button>
            </form>
            <form method="post" action="/actors/{{ notebook.actor.id }}/technique-coverage">
              <label for="cov-technique-id">Technique coverage</label>
              <input id="cov-technique-id" name="technique_id" type="text" placeholder="T1059" required />
              <input name="technique_name" type="text" placeholder="Technique name (optional)" />
              <input name="detection_name" type="text" placeholder="Detection name" />
              <input name="control_name" type="text" placeholder="Control name" />
              <select name="coverage_status">
                <option value="covered">Covered</option>
                <option value="partial">Partial</option>
                <option value="gap">Gap</option>
                <option value="unknown" selected>Unknown</option>
              </select>
              <select name="validation_status">
                <option value="validated">Validated</option>
                <option value="not_validated">Not validated</option>
                <option value="unknown" selected>Unknown</option>
              </select>
              <textarea name="validation_evidence" rows="2" placeholder="Evidence of telemetry validation"></textarea>
              <input name="updated_by" type="text" placeholder="Updated by" />
              <button class="action-button" type="submit">Save coverage mapping</button>
            </form>
            <form method="post" action="/actors/{{ notebook.actor.id }}/relationships">
              <label for="rel-src-type">Relationship edge</label>
              <input id="rel-src-type" name="src_entity_type" type="text" placeholder="Source type (actor/tool/infra/victim/campaign)" required />
              <input name="src_entity_key" type="text" placeholder="Source key" required />
              <input name="relationship_type" type="text" placeholder="uses/targets/operates" required />
              <input name="dst_entity_type" type="text" placeholder="Destination type" required />
              <input name="dst_entity_key" type="text" placeholder="Destination key" required />
              <input name="source_ref" type="text" placeholder="Citation URL/source" />
              <input name="observed_on" type="date" />
              <select name="confidence">
                <option value="low">Low</option>
                <option value="moderate" selected>Moderate</option>
                <option value="high">High</option>
              </select>
              <input name="analyst" type="text" placeholder="Analyst name" />
              <button class="action-button" type="submit">Add relationship</button>
            </form>
            <form method="post" action="/actors/{{ notebook.actor.id }}/change-items">
              <label for="change-summary">Change item</label>
              <textarea id="change-summary" name="change_summary" rows="2" placeholder="What changed" required></textarea>
              <select name="change_type">
                <option value="ttp">TTP</option>
                <option value="infra">Infrastructure</option>
                <option value="tooling">Tooling</option>
                <option value="targeting">Targeting</option>
                <option value="timing">Timing</option>
                <option value="access_vector">Access vector</option>
                <option value="other" selected>Other</option>
              </select>
              <label><input type="checkbox" name="ttp_tag" /> TTP</label>
              <label><input type="checkbox" name="infra_tag" /> Infrastructure</label>
              <label><input type="checkbox" name="tooling_tag" /> Tooling</label>
              <label><input type="checkbox" name="targeting_tag" /> Targeting</label>
              <label><input type="checkbox" name="timing_tag" /> Timing</label>
              <label><input type="checkbox" name="access_vector_tag" /> Access vector</label>
              <input name="source_ref" type="text" placeholder="Source reference" />
              <input name="observed_on" type="date" />
              <input name="created_by" type="text" placeholder="Created by" />
              <button class="action-button" type="submit">Add change item</button>
            </form>
            <form method="post" action="/actors/{{ notebook.actor.id }}/change-conflicts">
              <label for="conflict-topic">Conflict/arbitration record</label>
              <input id="conflict-topic" name="conflict_topic" type="text" placeholder="Conflict topic" required />
              <input name="source_a_ref" type="text" placeholder="Source A" required />
              <input name="source_b_ref" type="text" placeholder="Source B" required />
              <textarea name="arbitration_outcome" rows="2" placeholder="Arbitration outcome and rationale" required></textarea>
              <select name="confidence">
                <option value="low">Low</option>
                <option value="moderate" selected>Moderate</option>
                <option value="high">High</option>
              </select>
              <input name="analyst" type="text" placeholder="Analyst name" />
              <button class="action-button" type="submit">Record conflict resolution</button>
            </form>
            <form method="post" action="/actors/{{ notebook.actor.id }}/sources">
              <input type="url" name="source_url" placeholder="https://..." required />
              <button type="submit">Fetch and add source</button>
            </form>
            <form method="post" action="/actors/{{ notebook.actor.id }}/sources/import-feeds">
              <button type="submit">Import established CTI RSS sources</button>
            </form>
            <form method="post" action="/actors/{{ notebook.actor.id }}/iocs">
              <select name="ioc_type">
                <option value="ip">IP</option>
                <option value="domain">Domain</option>
                <option value="hash">Hash</option>
                <option value="url">URL</option>
                <option value="email">Email</option>
                <option value="indicator" selected>Indicator</option>
              </select>
              <select name="handling_tlp">
                <option value="TLP:CLEAR" selected>TLP:CLEAR</option>
                <option value="TLP:GREEN">TLP:GREEN</option>
                <option value="TLP:AMBER">TLP:AMBER</option>
                <option value="TLP:AMBER+STRICT">TLP:AMBER+STRICT</option>
                <option value="TLP:RED">TLP:RED</option>
              </select>
              <input type="text" name="source_ref" placeholder="Source reference (optional)" />
              <textarea name="ioc_values" rows="4" placeholder="One IOC per line or comma-separated" required></textarea>
              <button type="submit">Save IOCs</button>
            </form>
          </details>
          {% if notebook.requirements %}
          <details class="compact">
            <summary>Requirements ({{ notebook.requirements | length }})</summary>
            {% for req in notebook.requirements[:3] %}
            <div class="req-item">
              <div><span class="badge">{{ req.req_type }}</span> <span class="badge {% if req.status == 'open' %}open{% else %}resolved{% endif %}">{{ req.status }}</span></div>
              <p><strong>{{ req.requirement_text }}</strong></p>
              {% if req.status == 'open' %}
              <form method="post" action="/requirements/{{ req.id }}/resolve">
                <input type="hidden" name="actor_id" value="{{ notebook.actor.id }}" />
                <button type="submit">Mark documented</button>
              </form>
              {% endif %}
            </div>
            {% endfor %}
          </details>
          {% endif %}
        </div>

        {% endif %}
      </aside>

      <main class="main">
        {% set llm_message = (ollama_status.message if ollama_status and ollama_status.message else 'LLM status unavailable.') %}
        {% set llm_message_lower = llm_message|lower %}
        {% set llm_ready = (ollama_status and ollama_status.available and ('not found' not in llm_message_lower)) %}
        <div class="top-status-row">
          <button type="button" id="notebook-health-chip" class="notice status-chip status-button status-{{ notebook_health.state }}">
            <strong>System:</strong> <span id="notebook-health-message">{{ notebook_health.message }}</span>
            <div class="status-meta">
              LLM: {% if llm_ready %}ready{% else %}offline{% endif %} |
              Timeline: live |
              Last refresh: <span id="notebook-health-duration">{{ notebook_health.last_refresh_duration }}</span> |
              Sources: <span id="notebook-health-sources">{{ notebook_health.last_refresh_sources }}</span>
              {% if notebook and notebook.actor.last_confirmed_at %}
              | Confirmed: {{ notebook.actor.last_confirmed_at }}{% if notebook.actor.last_confirmed_by %} by {{ notebook.actor.last_confirmed_by }}{% endif %}
              {% endif %}
            </div>
            <div id="notebook-health-progress" class="progress-wrap" {% if not notebook or notebook.actor.notebook_status != 'running' %}style="display:none;"{% endif %}><div class="progress-bar"></div></div>
          </button>
          {% if notice %}
          <div class="notice status-chip">{{ notice }}</div>
          {% endif %}
          {% if notebook %}
          <div class="live-controls">
            <span class="live-pill" id="live-indicator">Live sync on</span>
          </div>
          {% endif %}
          <div class="ui-mode-top">
            <label for="ui-mode-select">Interface mode</label>
            <select id="ui-mode-select" aria-label="Interface mode">
              <option value="classic">Classic</option>
              <option value="redraw">Redraw</option>
              <option value="bastion">Bastion</option>
            </select>
          </div>
          <div id="ui-activity-strip" class="notice status-chip ui-activity-strip status-idle" role="status" aria-live="polite" hidden>
            <strong>Activity:</strong> <span id="ui-activity-text">Idle</span>
          </div>
          {% if refresh_stats %}
          <details class="status-ops-drawer">
            <summary class="notice status-chip status-button">
              <strong>Refresh:</strong>
              <span id="refresh-timeline-status" class="refresh-activity-live">Live updates every 20 seconds</span>
            </summary>
            <div class="status-ops-panel">
              <div class="refresh-activity-actions" style="margin-bottom:8px;">
                <button id="terminal-generate-notes" type="button">Auto-draft notes</button>
                <button id="terminal-add-note" type="button">Write analyst note</button>
              </div>
              <div class="status-ops-grid">
                <div class="status-ops-item">
                  <div class="label">Backoff feeds</div>
                  <div class="value">{{ refresh_stats.feed_state.backoff_feeds }}</div>
                </div>
                <div class="status-ops-item">
                  <div class="label">High confidence</div>
                  <div class="value">{{ refresh_stats.source_state.high_confidence_sources }}</div>
                </div>
                <div class="status-ops-item">
                  <div class="label">24h high confidence</div>
                  <div class="value">{{ refresh_stats.source_state.recent_high_confidence_sources_24h }}</div>
                </div>
                <div class="status-ops-item">
                  <div class="label">Expected remaining</div>
                  <div id="refresh-eta-value" class="value">{% if refresh_stats.eta_seconds is not none %}~{{ refresh_stats.eta_seconds }}s{% else %}n/a{% endif %}</div>
                </div>
                <div class="status-ops-item">
                  <div class="label">LLM cache saved</div>
                  <div id="refresh-cache-saved" class="value">
                    {% set cache_saved_ms = refresh_stats.llm_cache_state.saved_ms_total if refresh_stats.llm_cache_state else 0 %}
                    {% if cache_saved_ms and cache_saved_ms > 0 %}~{{ (cache_saved_ms // 1000) }}s{% else %}0s{% endif %}
                  </div>
                </div>
                <div class="status-ops-item">
                  <div class="label">Queue depth</div>
                  <div id="refresh-queue-depth" class="value">n/a</div>
                </div>
              </div>
              <div class="refresh-activity-meta" style="margin-top:8px;">Last updated: <span id="refresh-timeline-updated">Page load</span></div>
              <div id="refresh-timeline-list" class="refresh-run-list">
                {% if refresh_stats.recent_generation_runs %}
                  {% for run in refresh_stats.recent_generation_runs %}
                  <div class="refresh-run-card {% if run.status == 'running' %}is-running{% elif run.status == 'error' %}is-error{% endif %}">
                    <div class="refresh-run-top">
                      <strong>
                        {% if run.status == 'completed' %}Finished{% elif run.status == 'error' %}Needs attention{% else %}In progress{% endif %}
                      </strong>
                      <span class="refresh-run-meta">
                        {{ run.created_at[:19].replace('T', ' ') if run.created_at else 'Unknown time' }} |
                        {% if run.trigger_type == 'auto_refresh' %}Automatic background refresh{% else %}Manual refresh{% endif %}
                      </span>
                    </div>
                    <div class="refresh-run-message">
                      {% if run.error_message %}{{ run.error_message }}
                      {% elif run.final_message %}{{ run.final_message }}
                      {% elif run.status == 'running' %}Refresh is still running.
                      {% else %}Refresh completed.
                      {% endif %}
                    </div>
                  </div>
                  {% endfor %}
                {% else %}
                  <div id="refresh-timeline-empty" class="refresh-empty">No recent refresh history yet for this actor.</div>
                {% endif %}
              </div>
            </div>
          </details>
          {% endif %}
        </div>
        {% if notebook %}
        {% set recent_change = notebook.get('recent_change_summary', {'new_reports': '0', 'targets': 'Not clear yet', 'damage': 'No clear damage outcome reported yet'}) %}
        {% set bastion_trend = notebook.timeline_graph[-8:] if notebook.timeline_graph else [] %}
        {% set bastion_ns = namespace(trend_max=1) %}
        {% for bucket in bastion_trend %}
          {% if bucket.total > bastion_ns.trend_max %}{% set bastion_ns.trend_max = bucket.total %}{% endif %}
        {% endfor %}
        <section id="bastion-shell" class="bastion-shell" aria-label="Bastion command deck">
          <div class="bastion-top">
            <div>
              <div class="bastion-sub">Immersive command workflow for rapid actor review</div>
            </div>
            <div class="bastion-micro">
              <div class="m"><div class="mk">Status</div><div id="bastion-k-status" class="mv">{{ notebook_health.state|capitalize }}</div></div>
              <div class="m"><div class="mk">Sources</div><div id="bastion-k-sources" class="mv">{{ notebook_health.last_refresh_sources }}</div></div>
              <div class="m"><div class="mk">Activity</div><div id="bastion-k-activity" class="mv">{{ recent_change.new_reports }}</div></div>
              <div class="m"><div class="mk">Techniques</div><div id="bastion-k-techniques" class="mv">{{ notebook.top_techniques|length if notebook.top_techniques else 0 }}</div></div>
            </div>
            <div class="bastion-actions">
              <button type="button" id="bastion-cmd-map">Geography</button>
              <button type="button" id="bastion-cmd-refresh">Refresh actor</button>
            </div>
          </div>
          <div class="bastion-grid">
            <div class="bastion-main">
              <section class="bastion-viz">
                <article class="bastion-card">
                  <h3>Operational Trend</h3>
                  <div id="bastion-trend-bars" class="bastion-bars">
                    {% if bastion_trend %}
                      {% for bucket in bastion_trend %}
                      {% set h = ((bucket.total / bastion_ns.trend_max) * 150) | int if bastion_ns.trend_max else 12 %}
                      <div class="bastion-bar-col">
                        <div class="bastion-bar" style="height: {{ [h, 12]|max }}px;" title="{{ bucket.label }}: {{ bucket.total }}"></div>
                        <div class="bastion-bar-label">{{ bucket.label[-5:] if bucket.label else '-' }}</div>
                      </div>
                      {% endfor %}
                    {% else %}
                      <div class="inline-note">No timeline buckets available yet.</div>
                    {% endif %}
                  </div>
                </article>
                <article class="bastion-card">
                  <h3>Technique Pressure</h3>
                  <div id="bastion-technique-bars" class="bastion-bars">
                    {% if notebook.top_techniques %}
                      {% for technique in notebook.top_techniques[:8] %}
                      {% set score = technique.event_count or technique.source_count or 1 %}
                      {% set th = (score * 18) | int %}
                      {% set th_clamped = [170, [th, 14]|max]|min %}
                      <div class="bastion-bar-col">
                        <div class="bastion-bar" style="height: {{ th_clamped }}px;" title="{{ technique.technique_id }} {{ technique.technique_name }}"></div>
                        <div class="bastion-bar-label">{{ technique.technique_id or 'T' }}</div>
                      </div>
                      {% endfor %}
                    {% else %}
                      <div class="inline-note">No mapped techniques yet.</div>
                    {% endif %}
                  </div>
                </article>
              </section>
              <section class="bastion-sections">
                <article class="bastion-card">
                  <h3>What changed and why it matters</h3>
                  <ul id="bastion-change-list">
                    {% if notebook.top_change_signals %}
                      {% for signal in notebook.top_change_signals[:5] %}
                      <li>{{ signal.change_summary or signal.change_why_new or 'No summarized change text yet.' }}</li>
                      {% endfor %}
                    {% else %}
                      <li>No validated change signals yet.</li>
                    {% endif %}
                  </ul>
                </article>
                <article class="bastion-card">
                  <h3>AI review: what changed recently</h3>
                  <ul id="bastion-ai-list">
                    {% if notebook.recent_activity_synthesis %}
                      {% for synthesis in notebook.recent_activity_synthesis[:5] %}
                      <li>{{ synthesis.text }}</li>
                      {% endfor %}
                    {% else %}
                      <li>No recent AI synthesis available yet.</li>
                    {% endif %}
                  </ul>
                </article>
              </section>
            </div>
            <aside class="bastion-right">
              {% set latest_run = (refresh_stats.recent_generation_runs[0] if refresh_stats and refresh_stats.recent_generation_runs else None) %}
              {% set latest_signal_text = '' %}
              {% if notebook.top_change_signals and notebook.top_change_signals[0] %}
                {% set latest_signal_text = notebook.top_change_signals[0].change_summary or notebook.top_change_signals[0].change_why_new or '' %}
              {% elif notebook.recent_activity_synthesis and notebook.recent_activity_synthesis[0] %}
                {% set latest_signal_text = notebook.recent_activity_synthesis[0].text or '' %}
              {% endif %}
              {% set open_alerts_ns = namespace(count=0) %}
              {% if notebook.alert_queue %}
                {% for alert in notebook.alert_queue %}
                  {% if alert and (alert.status or '')|lower == 'open' %}
                    {% set open_alerts_ns.count = open_alerts_ns.count + 1 %}
                  {% endif %}
                {% endfor %}
              {% endif %}
              <article class="bastion-card">
                <h3>Mission console</h3>
                <div class="bastion-mission-grid">
                  <div class="bastion-mission-item">
                    <div class="label">Now processing</div>
                    <div class="value">
                      {% if latest_run %}
                        {{ latest_run.status|capitalize }} | {{ latest_run.trigger_type|replace('_', ' ')|capitalize }}{% if latest_run.created_at %} | {{ latest_run.created_at[:19].replace('T', ' ') }}{% endif %}
                      {% else %}
                        Idle
                      {% endif %}
                    </div>
                  </div>
                  <div class="bastion-mission-item">
                    <div class="label">Latest signal</div>
                    <div class="value">{{ latest_signal_text or 'No prioritized change signal yet.' }}</div>
                  </div>
                  <div class="bastion-mission-item">
                    <div class="label">Attention queue</div>
                    <ul class="bastion-attention-list">
                      {% set shown_ns = namespace(count=0) %}
                      {% if notebook.ops_tasks %}
                        {% for task in notebook.ops_tasks %}
                          {% if shown_ns.count < 3 and task and (task.status or '')|lower != 'done' %}
                          {% set shown_ns.count = shown_ns.count + 1 %}
                          <li>{{ task.title }}{% if task.owner %} | {{ task.owner }}{% endif %}{% if task.due_date %} | due {{ task.due_date }}{% endif %}</li>
                          {% endif %}
                        {% endfor %}
                      {% endif %}
                      {% if shown_ns.count == 0 %}
                      <li>No open tasks in queue.</li>
                      {% endif %}
                    </ul>
                  </div>
                  <div class="bastion-mission-item">
                    <div class="label">System health</div>
                    <div class="bastion-health-chips">
                      <span class="bastion-health-chip {% if notebook_health.state in ['ready', 'idle'] %}ok{% elif notebook_health.state == 'warning' %}warn{% else %}bad{% endif %}">
                        System: {{ notebook_health.state|capitalize }}
                      </span>
                      <span class="bastion-health-chip {% if llm_ready %}ok{% else %}bad{% endif %}">
                        LLM: {% if llm_ready %}Ready{% else %}Offline{% endif %}
                      </span>
                      <span class="bastion-health-chip {% if open_alerts_ns.count > 0 %}warn{% else %}ok{% endif %}">
                        Alerts: {{ open_alerts_ns.count }}
                      </span>
                      <span class="bastion-health-chip {% if notebook.ops_tasks %}warn{% else %}ok{% endif %}">
                        Tasks: {{ notebook.ops_tasks|length if notebook.ops_tasks else 0 }}
                      </span>
                    </div>
                  </div>
                  <div class="bastion-mission-item">
                    <div class="label">Last analyst action</div>
                    <div class="value">
                      {% if notebook.operational_outcomes and notebook.operational_outcomes[0] %}
                        {{ notebook.operational_outcomes[0].outcome_type }} | {{ notebook.operational_outcomes[0].created_at }}{% if notebook.operational_outcomes[0].created_by %} | {{ notebook.operational_outcomes[0].created_by }}{% endif %}
                      {% else %}
                        No operational outcomes recorded yet.
                      {% endif %}
                    </div>
                  </div>
                </div>
              </article>
            </aside>
          </div>
          <section class="bastion-terminal">
            <div class="head"><span>Operations Terminal</span><span id="bastion-terminal-ping">ONLINE</span></div>
            <pre id="bastion-terminal-log" class="log">[BOOT] Bastion deck online for {{ notebook.actor.display_name }}
[STATUS] System: {{ notebook_health.message }}
[SYNC] Live updates enabled
[READY] Use command buttons above to run notebook actions.</pre>
            <div class="cmds">
              <button type="button" id="bastion-cmd-terminal-notes">Write analyst note</button>
              <button type="button" id="bastion-cmd-terminal-gennotes">Auto-draft notes</button>
              <button type="button" id="bastion-cmd-terminal-timeline">Timeline</button>
              <button type="button" id="bastion-cmd-terminal-top">Back to top</button>
            </div>
          </section>
        </section>
        {% endif %}
        {% if not notebook %}
        <div class="empty">Select an actor to open the notebook.</div>
        {% else %}
        <div class="dashboard">
        {% set recent_change = notebook.get('recent_change_summary', {'new_reports': '0', 'targets': 'Not clear yet', 'damage': 'No clear damage outcome reported yet'}) %}
        {% set first_new_report_url = '' %}
        {% if notebook.top_change_signals %}
          {% for signal in notebook.top_change_signals %}
            {% if signal.validated_sources %}
              {% for evidence in signal.validated_sources %}
                {% if evidence.source_url and not first_new_report_url %}
                  {% set first_new_report_url = evidence.source_url %}
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endfor %}
        {% endif %}
        {% if not first_new_report_url and notebook.recent_activity_highlights %}
          {% for highlight in notebook.recent_activity_highlights %}
            {% if highlight.source_url and not first_new_report_url %}
              {% set first_new_report_url = highlight.source_url %}
            {% endif %}
          {% endfor %}
        {% endif %}
        <section class="card span-2 ataglance-strip" id="section-ataglance">
          <div class="ataglance-metric">
            <div class="ataglance-label">Actor</div>
            <div class="ataglance-value">{{ notebook.actor.display_name }}</div>
          </div>
          <div class="ataglance-metric">
            <div class="ataglance-label">New Reports</div>
            <div class="ataglance-value">
              {% if first_new_report_url %}
              <a id="recent-reports-link" href="{{ first_new_report_url }}" target="_blank" rel="noreferrer" title="Open most recent supporting report source">
                <span id="recent-reports">{{ recent_change.new_reports }}</span>
              </a>
              {% else %}
              <a id="recent-reports-link" href="/actors/{{ notebook.actor.id }}/timeline/details" title="Open timeline details">
                <span id="recent-reports">{{ recent_change.new_reports }}</span>
              </a>
              {% endif %}
            </div>
          </div>
          <div class="ataglance-metric">
            <div class="ataglance-label">Trend</div>
            {% set trend_buckets = notebook.timeline_graph[-6:] if notebook.timeline_graph else [] %}
            {% set latest_bucket = trend_buckets[-1] if trend_buckets else None %}
            {% set prev_bucket = trend_buckets[-2] if trend_buckets|length > 1 else None %}
            {% set latest_total = latest_bucket.total if latest_bucket else 0 %}
            {% set prev_total = prev_bucket.total if prev_bucket else 0 %}
            {% set delta = latest_total - prev_total %}
            {% if latest_total == 0 and prev_total == 0 %}
            {% set trend_label = 'Quiet' %}
            {% elif delta > 0 %}
            {% set trend_label = 'Rising' %}
            {% elif delta < 0 %}
            {% set trend_label = 'Cooling' %}
            {% else %}
            {% set trend_label = 'Steady' %}
            {% endif %}
            <div class="ataglance-value">{{ trend_label }}</div>
            {% if notebook.timeline_graph %}
            <div class="mini-trend-inline" aria-hidden="true">
              {% for bucket in trend_buckets %}
              <span class="mini-trend-bar{% if loop.last %} peak{% endif %}" style="height: {{ [20, [4, bucket.height_pct // 2]|max]|min }}px;" title="{{ bucket.label }}: {{ bucket.total }} events"></span>
              {% endfor %}
            </div>
            <div class="mini-trend-labels"><span>Older</span><span>Latest</span></div>
            <div class="mini-trend-kpis">
              <div class="mini-trend-kpi">
                <span class="k">Latest</span>
                <span class="v">{{ latest_total }}</span>
              </div>
              <div class="mini-trend-kpi">
                <span class="k">Prev</span>
                <span class="v">{{ prev_total }}</span>
              </div>
              <div class="mini-trend-kpi {% if delta > 0 %}up{% elif delta < 0 %}down{% else %}flat{% endif %}">
                <span class="k">Direction</span>
                <span class="v">
                  {% if delta > 0 %}+{{ delta }}{% elif delta < 0 %}{{ delta }}{% else %}0{% endif %}
                </span>
              </div>
            </div>
            <div class="mini-trend-meta">
              Latest bucket: {{ trend_buckets[-1].total if trend_buckets else 0 }} events
            </div>
            {% endif %}
          </div>
          <div class="ataglance-metric">
            <div class="ataglance-label">Notable Impact</div>
            <div class="ataglance-value"><span id="recent-impact">{{ recent_change.damage }}</span></div>
          </div>
        </section>
        <section class="card span-2 decision-queue" data-step="action" id="section-nextchecks">
          <div class="decision-header">
            <div style="display:flex; align-items:center; gap:8px;">
              <h2 class="section-title" style="margin:0;">Quick checks</h2>
              <button type="button" id="quick-check-do-next" style="padding:6px 10px; border:1px solid #9fb3d5; border-radius:8px; background:#eef4ff; cursor:pointer;">DO NEXT</button>
            </div>
            <div>
              {% if notebook.backfill_notice %}
              <span class="badge">{{ notebook.backfill_notice }}</span>
              <span> | </span>
              {% endif %}
              {% if notebook.backfill_debug %}
              <span class="actor-scope">{{ notebook.backfill_debug }}</span>
              <span> | </span>
              {% endif %}
              <a href="/actors/{{ notebook.actor.id }}/questions">Open workspace</a>
              <span> | </span>
              <a href="/actors/{{ notebook.actor.id }}/hunts/iocs?window_days=30">IOC hunt queries</a>
            </div>
          </div>
          <div class="dq-list">
            {% if notebook.priority_questions %}
            {% for question in notebook.priority_questions %}
            <details class="dq-row" data-quick-check="1" data-quick-check-rank="{{ loop.index0 }}">
              <summary>
                <strong>{{ question.title or question.quick_check_title }}</strong>
                <span class="pbadge {{ question.severity.lower() if question.severity else question.priority.lower() }}">{{ question.severity or question.priority }}</span>
              </summary>
              <div class="dq-detail">
                <div class="dq-line"><strong>Behavior to hunt:</strong> {{ question.behavior_to_hunt or question.decision_trigger }}</div>
                <div class="dq-line"><strong>Where to start:</strong> {{ question.where_to_start or question.first_step or question.telemetry_anchor }}</div>
                <div class="dq-line"><strong>What to watch:</strong> {{ question.what_to_watch or question.what_to_look_for or question.success_condition or question.decision_trigger }}</div>
                <div class="dq-line"><strong>Required data:</strong>
                  {% if question.required_data %}
                    {{ question.required_data }}
                  {% else %}
                    Windows Event Logs with host/user context.
                  {% endif %}
                </div>
                <div class="dq-line"><strong>Decision rule:</strong> {{ question.decision_rule or question.success_condition }}</div>
                <div class="dq-line"><strong>Analyst output:</strong> {{ question.analyst_output or question.expected_output }}</div>
                <div class="dq-line"><strong>Evidence used:</strong>
                  {% if question.evidence_used %}
                    {{ question.evidence_used | join(' | ') }}
                  {% else %}
                    No actor-linked evidence in last 30 days.
                  {% endif %}
                </div>
                <div class="dq-line"><a href="/actors/{{ notebook.actor.id }}/hunts/iocs?quick_check_id={{ (question.quick_check_id or question.check_template_id or question.id) | urlencode }}&window_start={{ question.window_start | urlencode }}&window_end={{ question.window_end | urlencode }}">Open IOC hunt queries for this check</a></div>
                <div class="feedback-actions">
                  <button type="button" class="question-feedback-btn positive" data-thread-id="{{ question.id }}" data-feedback="useful">Useful</button>
                  <button type="button" class="question-feedback-btn negative" data-thread-id="{{ question.id }}" data-feedback="not_useful">Not useful</button>
                  <span class="feedback-status" id="feedback-status-{{ question.id }}"></span>
                </div>
              </div>
            </details>
            {% endfor %}
            {% else %}
            <div class="dq-row">
              <div class="dq-detail">
                Quick checks will appear here after source-backed actor updates are processed.
              </div>
            </div>
            {% endif %}
          </div>
        </section>

        <div class="workspace-grid single-card">
        <section class="card pane giant-notebook-card">
          <div class="main-tabs" role="tablist" aria-label="Actor sections">
            <button type="button" class="main-tab-btn active" data-main-tab="overview" role="tab" aria-selected="true">Overview</button>
            <button type="button" class="main-tab-btn" data-main-tab="timeline" role="tab" aria-selected="false">Timeline</button>
            <button type="button" class="main-tab-btn" data-main-tab="iocs" role="tab" aria-selected="false">IOCs</button>
            <button type="button" class="main-tab-btn" data-main-tab="notebook" role="tab" aria-selected="false">Notebook</button>
            <button type="button" class="main-tab-btn" data-main-tab="visuals" role="tab" aria-selected="false">Visuals</button>
          </div>

          <!--  Overview  -->
          <section id="section-overview" data-main-panel="overview">
            <h3 class="section-title">Profile snapshot<span class="role-chip">Understand</span></h3>
            <div class="section-body">
            <div class="who-summary">
              <p>{{ notebook.actor_profile_summary }}</p>
              <div class="who-meta">Framework Group Match: {{ notebook.actor_profile_group_name }} | Source: <a href="{{ notebook.actor_profile_source_url }}" target="_blank" rel="noreferrer">{{ notebook.actor_profile_source_label }}</a> | Created: {{ notebook.actor_created_date }}</div>
            </div>
            {% set why_now_signal = notebook.top_change_signals[0] if notebook.top_change_signals else None %}
            {% set why_now_synthesis = notebook.recent_activity_synthesis[0] if notebook.recent_activity_synthesis else None %}
            {% set why_now_text = '' %}
            {% if why_now_signal and why_now_signal.change_why_new %}
              {% set why_now_text = why_now_signal.change_why_new %}
            {% elif why_now_synthesis and why_now_synthesis.text %}
              {% set why_now_text = why_now_synthesis.text %}
            {% elif why_now_signal and why_now_signal.change_summary %}
              {% set why_now_text = why_now_signal.change_summary %}
            {% else %}
              {% set llm_msg = (ollama_status.message if ollama_status and ollama_status.message else '')|lower %}
              {% set llm_ready = (ollama_status and ollama_status.available and ('not found' not in llm_msg)) %}
              {% if llm_ready %}
                {% set why_now_text = 'No validated LLM synthesis is available for this actor yet. Refresh after additional actor-linked evidence is ingested.' %}
              {% else %}
                {% set why_now_text = 'LLM synthesis is unavailable right now. Confirm Ollama/model status, then refresh this actor notebook.' %}
              {% endif %}
            {% endif %}
            <div class="who-why">
              <strong>What changed and why you should care:</strong> {{ why_now_text }}
              {% if why_now_signal and why_now_signal.validated_source_count %}
              <div class="who-meta">Supported by {{ why_now_signal.validated_source_count }} corroborated source(s).</div>
              {% endif %}
            </div>
            <p class="who-heading"><strong>Common moves they use (top 3)</strong></p>
            {% if notebook.top_techniques %}
            <div class="technique-grid">
              {% for technique in notebook.top_techniques[:3] %}
              <div class="technique-item">
                <div class="technique-head">
                  {% if technique.technique_url %}
                  <a class="technique-pill" href="{{ technique.technique_url }}" target="_blank" rel="noreferrer">{{ technique.technique_id or 'Technique' }}</a>
                  {% else %}
                  <span class="technique-pill">{{ technique.technique_id or 'Technique' }}</span>
                  {% endif %}
                </div>
                <div class="technique-name">{{ technique.technique_name }}</div>
                {% if technique.phase %}
                <div class="technique-phase">{{ technique.phase.replace('_', ' ') }}</div>
                {% endif %}
              </div>
              {% endfor %}
            </div>
            <p><small>New to ATT&amp;CK IDs? Treat these as behavior tags to guide detections and hunts.</small></p>
            {% else %}
            <p><small>No mapped technique profile available yet.</small></p>
            {% endif %}
            <div class="who-kpis">
              <div class="who-kpi">
                <div class="who-kpi-label">30d activity</div>
                <div class="who-kpi-value">{{ notebook.kpis.activity_30d }}</div>
              </div>
              <div class="who-kpi">
                <div class="who-kpi-label">New techniques</div>
                <div class="who-kpi-value">{{ notebook.kpis.new_techniques_30d }}</div>
              </div>
              <div class="who-kpi">
                <div class="who-kpi-label">Last checked</div>
                <div class="who-kpi-value">{{ notebook.kpis.last_verified_update }}</div>
              </div>
            </div>
            <details class="compact">
              <summary>Emerging techniques observed ({{ notebook.emerging_techniques|length if notebook.emerging_techniques else 0 }})</summary>
            {% if notebook.emerging_techniques %}
            <ul class="summary-list">
              {% for technique in notebook.emerging_techniques[:3] %}
              <li>
                {% if technique.technique_url %}
                <a href="{{ technique.technique_url }}" target="_blank" rel="noreferrer">{{ technique.technique_id }}</a>
                {% else %}
                {{ technique.technique_id }}
                {% endif %}
                {% if technique.technique_name %} - {{ technique.technique_name }}{% endif %}
                <small>(first seen {{ technique.first_seen or 'unknown' }}, {{ technique.source_count }} sources, {{ technique.event_count }} events)</small>
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <p><small>No new technique IDs observed yet in actor-specific recent reporting.</small></p>
            {% endif %}
            </details>
            </div>
            {% if not notebook.actor.is_tracked %}
            <form method="post" action="/actors/{{ notebook.actor.id }}/track">
              <button type="submit">Track actor</button>
            </form>
            {% endif %}

            <!-- Recent activity sub-section -->
            <h3 class="section-title" style="margin-top:16px;">Recent activity<span class="role-chip">Watch</span></h3>
            {% if notebook.actor.notebook_status == 'running' %}
            <div class="notice status-working">Source collection is running in the background. This section will populate automatically.</div>
            {% endif %}
            <div class="section-body">
            <ul class="summary-list">
              <li><strong>Report count:</strong> {{ recent_change.new_reports }}</li>
              <li><strong>Target sectors:</strong> <span id="recent-targets">{{ recent_change.targets }}</span></li>
              <li><strong>Reported impact:</strong> {{ recent_change.damage }}</li>
            </ul>
            {% if notebook.recent_activity_synthesis %}
            <p class="inline-note"><strong>How to read:</strong> left to right = change, affected area, and recommended first action.</p>
            <div class="snapshot-grid">
              {% for synthesis in notebook.recent_activity_synthesis %}
              {% if synthesis.label != 'What changed' %}
              <div class="snapshot-card conf-{{ (synthesis.confidence or 'low') | lower }}">
                <h3 class="snapshot-title">{{ synthesis.label }}</h3>
                <p class="snapshot-text">{{ synthesis.text }}</p>
                <div class="snapshot-meta">
                  <span class="badge">{{ synthesis.confidence }}</span>
                  <span>{{ synthesis.lineage }}</span>
                </div>
              </div>
              {% endif %}
              {% endfor %}
            </div>
            {% endif %}
            {% if notebook.recent_activity_highlights %}
            {% set quality_filters = notebook.get('source_quality_filters', source_quality_filters or {}) %}
            <p class="inline-note">
              Built from fresh, higher-confidence reporting.
              Using {{ quality_filters.get('applied_sources', 0) }} of {{ quality_filters.get('total_sources', 0) }} sources{% if quality_filters.get('filtered_out_sources', 0) %} (filtered out: {{ quality_filters.get('filtered_out_sources', 0) }}){% endif %}.
            </p>
            <p><strong>What changed recently (AI reviewed):</strong></p>
            {% if notebook.top_change_signals %}
            <div class="change-list" id="latest-sources-list">
              {% for item in notebook.top_change_signals %}
              <div class="change-row">
                <div class="change-row-main">
                  <div class="change-row-title">{{ item.change_summary }}</div>
                  <div>
                    {% if item.change_window_days %}<span class="badge">first seen in the last {{ item.change_window_days }} days</span>{% endif %}
                    {% if item.change_confidence %}<span class="badge">{{ item.change_confidence }}</span>{% endif %}
                  </div>
                </div>
                {% if item.change_why_new %}
                <div class="change-row-source"><em>{{ item.change_why_new }}</em></div>
                {% endif %}
                <div class="change-row-source">
                  Based on {{ item.validated_source_count or '0' }} source(s) we checked
                  {% if item.category and item.category != 'activity synthesis' %} | {{ item.category.replace('_', ' ') }}{% endif %}
                  {% if item.ttp_ids %} | {{ item.ttp_ids }}{% endif %}
                  {% if item.target_text %} | target: {{ item.target_text }}{% endif %}
                </div>
                {% if item.validated_sources %}
                <ul class="recent-source-list" style="margin-top:6px;">
                  {% for evidence in item.validated_sources %}
                  <li>
                    <div class="source-headline">
                      {% if evidence.source_date %}<span class="badge">{{ evidence.source_date }}</span>{% endif %}
                      {% if evidence.freshness_label %}<span class="badge {{ evidence.freshness_class }}">{{ evidence.freshness_label }}</span>{% endif %}
                      <a class="source-title-link" href="{{ evidence.source_url }}" target="_blank" rel="noreferrer">{{ evidence.source_label or evidence.source_url }}</a>
                    </div>
                    {% if evidence.proof %}<small class="source-meta">{{ evidence.proof }}</small>{% endif %}
                  </li>
                  {% endfor %}
                </ul>
                {% endif %}
              </div>
              {% endfor %}
            </div>
            {% else %}
            <p><small>No clear new behavior was confirmed from recent reporting (last 30/60/90 days).</small></p>
            {% endif %}
            <div class="timeline-footer-link"><a href="/actors/{{ notebook.actor.id }}/timeline/details">View full timeline</a></div>
            {% else %}
            <p>No recent activity summary yet. <a href="/actors/{{ notebook.actor.id }}/timeline/details">Open the timeline</a> to review sources.</p>
            {% endif %}
            </div>
          </section>

          <!--  Timeline  -->
          <section class="tab-panel-hidden" id="section-timeline" data-main-panel="timeline">
            <h3 class="section-title">Timeline</h3>
            <div class="section-body">
              <p class="inline-note">Full chronological event history for this actor. Add events manually, or let source ingest populate it automatically.</p>
              <div style="margin:12px 0;">
                <a href="/actors/{{ notebook.actor.id }}/timeline/details" class="btn-secondary">Open full timeline</a>
              </div>
              {% if notebook.top_change_signals %}
              <div class="who-kpis" style="margin-bottom:12px;">
                <div class="who-kpi"><div class="who-kpi-label">Recent signals</div><div class="who-kpi-value">{{ notebook.top_change_signals|length }}</div></div>
                <div class="who-kpi"><div class="who-kpi-label">30d activity</div><div class="who-kpi-value">{{ notebook.kpis.activity_30d }}</div></div>
                <div class="who-kpi"><div class="who-kpi-label">Last checked</div><div class="who-kpi-value">{{ notebook.kpis.last_verified_update }}</div></div>
              </div>
              <p><strong>Recent signals (preview  open the timeline for full history):</strong></p>
              <div class="change-list">
                {% for item in notebook.top_change_signals[:5] %}
                <div class="change-row">
                  <div class="change-row-main">
                    <div class="change-row-title">{{ item.change_summary }}</div>
                    <div>
                      {% if item.change_window_days %}<span class="badge">last {{ item.change_window_days }}d</span>{% endif %}
                      {% if item.change_confidence %}<span class="badge">{{ item.change_confidence }}</span>{% endif %}
                    </div>
                  </div>
                  <div class="change-row-source">{{ item.validated_source_count or 0 }} source(s){% if item.category and item.category != 'activity synthesis' %} | {{ item.category.replace('_', ' ') }}{% endif %}</div>
                </div>
                {% endfor %}
              </div>
              {% else %}
              <div class="timeline-empty">
                <p>No timeline events yet. <a href="/actors/{{ notebook.actor.id }}/timeline/details">Open the full timeline</a> to add the first event.</p>
              </div>
              {% endif %}
            </div>
          </section>

          <!--  IOCs  -->
          <section class="tab-panel-hidden" id="section-iocs" data-main-panel="iocs">
            <h3 class="section-title">IOCs</h3>
            <div class="section-body">
            {% if notebook.ioc_items %}
            <p class="inline-note">{{ notebook.ioc_items|length }} indicator(s) tracked for this actor. Update status or TLP below. Enrich links open in a new tab  no API keys required.</p>
            <div class="ioc-table-wrap">
              {% for ioc in notebook.ioc_items %}
              <div class="ioc-row">
                <div class="ioc-row-head">
                  <span class="badge">{{ ioc.ioc_type }}</span>
                  <span class="ioc-value">{{ ioc.ioc_value }}</span>
                  {% if ioc.source_ref %}<span class="ioc-source">({{ ioc.source_ref }})</span>{% endif %}
                  <!-- Enrichment link-outs (external only, no API calls) -->
                  {% set itype = (ioc.ioc_type or '')|lower %}
                  {% if itype in ['ip', 'ipv4', 'ipv6', 'ip address'] %}
                  <span class="ioc-enrich-links">
                    <a href="https://www.virustotal.com/gui/search/{{ ioc.ioc_value }}" target="_blank" rel="noreferrer noopener" class="enrich-link">VT</a>
                    <a href="https://www.greynoise.io/noise/{{ ioc.ioc_value }}" target="_blank" rel="noreferrer noopener" class="enrich-link">GreyNoise</a>
                    <a href="https://www.abuseipdb.com/check/{{ ioc.ioc_value }}" target="_blank" rel="noreferrer noopener" class="enrich-link">AbuseIPDB</a>
                  </span>
                  {% elif itype in ['domain', 'hostname', 'fqdn'] %}
                  <span class="ioc-enrich-links">
                    <a href="https://www.virustotal.com/gui/domain/{{ ioc.ioc_value }}" target="_blank" rel="noreferrer noopener" class="enrich-link">VT</a>
                    <a href="https://urlscan.io/search/#{{ ioc.ioc_value }}" target="_blank" rel="noreferrer noopener" class="enrich-link">URLScan</a>
                    <a href="https://threatfox.abuse.ch/browse/?q={{ ioc.ioc_value }}" target="_blank" rel="noreferrer noopener" class="enrich-link">ThreatFox</a>
                  </span>
                  {% elif itype in ['hash', 'md5', 'sha1', 'sha256', 'sha512', 'file hash'] %}
                  <span class="ioc-enrich-links">
                    <a href="https://www.virustotal.com/gui/file/{{ ioc.ioc_value }}" target="_blank" rel="noreferrer noopener" class="enrich-link">VT</a>
                    <a href="https://bazaar.abuse.ch/browse/?q={{ ioc.ioc_value }}" target="_blank" rel="noreferrer noopener" class="enrich-link">MalwareBazaar</a>
                    <a href="https://threatfox.abuse.ch/browse/?q={{ ioc.ioc_value }}" target="_blank" rel="noreferrer noopener" class="enrich-link">ThreatFox</a>
                  </span>
                  {% elif itype in ['url'] %}
                  <span class="ioc-enrich-links">
                    <a href="https://urlscan.io/search/#{{ ioc.ioc_value }}" target="_blank" rel="noreferrer noopener" class="enrich-link">URLScan</a>
                    <a href="https://www.virustotal.com/gui/search/{{ ioc.ioc_value }}" target="_blank" rel="noreferrer noopener" class="enrich-link">VT</a>
                  </span>
                  {% endif %}
                </div>
                <div class="ioc-row-meta">
                  <small>Status: {{ ioc.lifecycle_status or 'active' }} | TLP: {{ ioc.handling_tlp or 'TLP:CLEAR' }} | Seen: {{ ioc.seen_count or 1 }} | Last seen: {{ ioc.last_seen_at or ioc.created_at or 'unknown' }}</small>
                </div>
                <form method="post" action="/actors/{{ notebook.actor.id }}/iocs/{{ ioc.id }}/status" class="ioc-status-form" style="display:flex; gap:6px; margin-top:4px; flex-wrap:wrap;">
                  <select name="lifecycle_status">
                    <option value="active" {% if (ioc.lifecycle_status or '') == 'active' %}selected{% endif %}>active</option>
                    <option value="monitor" {% if (ioc.lifecycle_status or '') == 'monitor' %}selected{% endif %}>monitor</option>
                    <option value="superseded" {% if (ioc.lifecycle_status or '') == 'superseded' %}selected{% endif %}>superseded</option>
                    <option value="revoked" {% if (ioc.lifecycle_status or '') == 'revoked' %}selected{% endif %}>revoked</option>
                    <option value="false_positive" {% if (ioc.lifecycle_status or '') == 'false_positive' %}selected{% endif %}>false_positive</option>
                  </select>
                  <select name="handling_tlp">
                    <option value="TLP:CLEAR" {% if (ioc.handling_tlp or 'TLP:CLEAR') == 'TLP:CLEAR' %}selected{% endif %}>TLP:CLEAR</option>
                    <option value="TLP:GREEN" {% if (ioc.handling_tlp or '') == 'TLP:GREEN' %}selected{% endif %}>TLP:GREEN</option>
                    <option value="TLP:AMBER" {% if (ioc.handling_tlp or '') == 'TLP:AMBER' %}selected{% endif %}>TLP:AMBER</option>
                    <option value="TLP:AMBER+STRICT" {% if (ioc.handling_tlp or '') == 'TLP:AMBER+STRICT' %}selected{% endif %}>TLP:AMBER+STRICT</option>
                    <option value="TLP:RED" {% if (ioc.handling_tlp or '') == 'TLP:RED' %}selected{% endif %}>TLP:RED</option>
                  </select>
                  <input type="text" name="status_reason" placeholder="reason (optional)" />
                  <button type="submit">Update</button>
                </form>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <div class="timeline-empty">
              <p>No IOCs tracked yet for this actor.</p>
              <p class="inline-note">IOCs are automatically extracted from source feeds when this actor is tracked. Once ingested, they appear here with one-click enrichment links.</p>
            </div>
            {% endif %}
            </div>
          </section>

          <!--  Notebook  -->
          <section class="tab-panel-hidden" id="section-notebook" data-main-panel="notebook">
            <h2 class="section-title">Analyst notes</h2>
            <p class="inline-note">Capture what matters, then review outcomes and coverage without leaving the workflow.</p>
            <div class="notes-tabs" role="tablist" aria-label="Analyst notes tabs">
              <button type="button" class="notes-tab-btn active" data-notes-tab="capture" role="tab" aria-selected="true">Capture</button>
              <button type="button" class="notes-tab-btn" data-notes-tab="review" role="tab" aria-selected="false">Since review</button>
              <button type="button" class="notes-tab-btn" data-notes-tab="bestpractices" role="tab" aria-selected="false">Best practices</button>
              <button type="button" class="notes-tab-btn" data-notes-tab="advanced" role="tab" aria-selected="false">Advanced</button>
            </div>
            <div data-notes-panel="capture">
            <div class="interactive-panel" data-observation-item-type="actor" data-observation-item-key="summary">
              <div class="obs-row">
                <div>
                  <label>Analyst</label>
                  <input type="text" class="observation-analyst" placeholder="name or handle" />
                </div>
                <div>
                  <label>Confidence</label>
                  <select class="observation-confidence">
                    <option value="moderate">Moderate</option>
                    <option value="high">High</option>
                    <option value="low">Low</option>
                  </select>
                </div>
                <div>
                  <label>Claim type</label>
                  <select class="observation-claim-type">
                    <option value="assessment">Assessment</option>
                    <option value="evidence">Evidence-backed</option>
                  </select>
                </div>
                <div>
                  <label>Observed on</label>
                  <input type="date" class="observation-observed-on" />
                </div>
                <div style="grid-column: 1 / -1;">
                  <label>Citation URL</label>
                  <input type="url" class="observation-citation-url" placeholder="https://source.example/report" />
                </div>
                <textarea class="observation-note" placeholder="What changed that matters for this actor?"></textarea>
              </div>
              <div class="obs-actions">
                <button type="button" class="observation-save">Save note</button>
                <button type="button" class="observation-history-toggle">View history</button>
                <span class="observation-meta" data-observation-meta></span>
              </div>
              <div class="observation-history" data-observation-history style="display:none;"></div>
            </div>
            </div>
            <div class="tab-panel-hidden" data-notes-panel="review">
            <div class="review-strip" style="margin-top:8px;">
              <h4>Since last review</h4>
              <div class="review-grid">
                <div class="review-metric"><div class="label">Since</div><div class="value" id="since-review-date">Not set</div></div>
                <div class="review-metric"><div class="label">Notes</div><div class="value" id="since-review-observations">0</div></div>
                <div class="review-metric"><div class="label">Sources</div><div class="value" id="since-review-sources">0</div></div>
                <div class="review-metric"><div class="label">Reports</div><div class="value" id="since-review-reports">0</div></div>
              </div>
              <div class="review-actions">
                <button type="button" id="mark-reviewed">Mark reviewed now</button>
                <button type="button" id="clear-reviewed">Clear baseline</button>
                <span id="review-meta" class="review-meta"></span>
              </div>
            </div>
            </div>
            <div class="tab-panel-hidden" data-notes-panel="bestpractices">
              <div class="interactive-panel">
                <div class="section-body">
                  <div><strong>Use this format:</strong> observation -> evidence -> action.</div>
                  <div><strong>Observation:</strong> what you saw (specific event, host, user, IOC).</div>
                  <div><strong>Evidence:</strong> one source link or log reference that supports it.</div>
                  <div><strong>Action:</strong> contain, monitor, escalate, or close.</div>
                  <div><strong>Avoid:</strong> long narratives, assumptions without evidence, and duplicate notes.</div>
                </div>
              </div>
            </div>
            <details class="compact tab-panel-hidden" data-notes-panel="advanced">
              <summary>Advanced history and operations</summary>
              <div class="adv-tabs" role="tablist" aria-label="Advanced operations tabs">
                <button type="button" class="adv-tab-btn active" data-adv-tab="history" role="tab" aria-selected="true">History</button>
                <button type="button" class="adv-tab-btn" data-adv-tab="tasks" role="tab" aria-selected="false">Tasks</button>
                <button type="button" class="adv-tab-btn" data-adv-tab="alerts" role="tab" aria-selected="false">Alerts</button>
                <button type="button" class="adv-tab-btn" data-adv-tab="coverage" role="tab" aria-selected="false">Coverage</button>
              </div>
            <div data-adv-panel="history">
            <h4 style="margin-top:8px;">History, filters, export</h4>
            <div class="ledger-controls">
              <div>
                <label for="ledger-filter-analyst">Analyst</label>
                <input id="ledger-filter-analyst" type="text" placeholder="name contains..." />
              </div>
              <div>
                <label for="ledger-filter-confidence">Confidence</label>
                <select id="ledger-filter-confidence">
                  <option value="">All</option>
                  <option value="high">High</option>
                  <option value="moderate">Moderate</option>
                  <option value="low">Low</option>
                </select>
              </div>
              <div>
                <label for="ledger-filter-from">Updated from</label>
                <input id="ledger-filter-from" type="date" />
              </div>
              <div>
                <label for="ledger-filter-to">Updated to</label>
                <input id="ledger-filter-to" type="date" />
              </div>
              <div>
                <label for="ledger-limit">Show</label>
                <select id="ledger-limit">
                  <option value="12">12</option>
                  <option value="25">25</option>
                  <option value="50">50</option>
                </select>
              </div>
            </div>
            <div id="ledger-filter-chips" class="filter-chips"></div>
            <div class="ledger-actions">
              <button type="button" id="ledger-apply">Apply filters</button>
              <button type="button" id="ledger-clear">Clear</button>
              <a id="ledger-export-json" href="#" target="_blank" rel="noreferrer">Export JSON</a>
              <a id="ledger-export-csv" href="#" target="_blank" rel="noreferrer">Export CSV</a>
              <span id="observation-ledger-count" class="ledger-count"></span>
            </div>
            <div id="observation-ledger-empty" class="timeline-empty">No observations saved yet.</div>
            <div id="observation-ledger-list" class="ledger-list"></div>
            </div>
            <div class="tab-panel-hidden" data-adv-panel="tasks">
            <h4 style="margin-top:12px;">Task queue and outcomes</h4>
            {% if notebook.ops_tasks %}
            <div class="ledger-list">
              {% for task in notebook.ops_tasks[:12] %}
              <div class="ledger-item">
                <div class="ledger-head">
                  <span><strong>{{ task.title }}</strong></span>
                  <span>Status: {{ task.status }}</span>
                  <span>Priority: {{ task.priority }}</span>
                  <span>Owner: {{ task.owner or 'unassigned' }}</span>
                  {% if task.due_date %}<span>Due: {{ task.due_date }}</span>{% endif %}
                </div>
                {% if task.details %}<div class="ledger-body">{{ task.details }}</div>{% endif %}
                {% if task.status != 'done' %}
                <form method="post" action="/actors/{{ notebook.actor.id }}/tasks/{{ task.id }}">
                  <input type="hidden" name="status" value="done" />
                  <button type="submit">Mark done</button>
                </form>
                {% endif %}
              </div>
              {% endfor %}
            </div>
            {% else %}
            <div class="timeline-empty">No tasks yet.</div>
            {% endif %}
            <h4 style="margin-top:8px;">Operational outcomes</h4>
            {% if notebook.operational_outcomes %}
            <div class="ledger-list">
              {% for outcome in notebook.operational_outcomes[:12] %}
              <div class="ledger-item">
                <div class="ledger-head">
                  <span>{{ outcome.outcome_type }}</span>
                  <span>{{ outcome.created_at }}</span>
                  <span>{{ outcome.created_by or 'analyst' }}</span>
                </div>
                <div class="ledger-body">{{ outcome.summary }}</div>
                {% if outcome.result %}<div class="ledger-link">Result: {{ outcome.result }}</div>{% endif %}
                {% if outcome.linked_technique_id %}<div class="ledger-link">Technique: {{ outcome.linked_technique_id }}</div>{% endif %}
              </div>
              {% endfor %}
            </div>
            {% else %}
            <div class="timeline-empty">No outcomes recorded yet.</div>
            {% endif %}
            </div>
            <div class="tab-panel-hidden" data-adv-panel="alerts">
            <h4 style="margin-top:12px;">Alert queue</h4>
            {% if notebook.alert_queue %}
            <div class="ledger-list">
              {% for alert in notebook.alert_queue[:20] %}
              <div class="ledger-item">
                <div class="ledger-head">
                  <span><strong>{{ alert.severity|upper }}</strong></span>
                  <span>{{ alert.alert_type }}</span>
                  <span>Status: {{ alert.status }}</span>
                  <span>{{ alert.created_at }}</span>
                </div>
                <div class="ledger-body">{{ alert.title }}</div>
                {% if alert.detail %}<div class="ledger-link">{{ alert.detail }}</div>{% endif %}
                {% if alert.source_ref %}<div class="ledger-link">Source: {{ alert.source_ref }}</div>{% endif %}
                {% if alert.channel_targets %}
                <div class="ledger-link">Notify: {{ alert.channel_targets | join(', ') }}</div>
                {% endif %}
                {% if alert.status == 'open' %}
                <form method="post" action="/actors/{{ notebook.actor.id }}/alerts/{{ alert.id }}/ack">
                  <input type="text" name="analyst" placeholder="Analyst (optional)" />
                  <button type="submit">Acknowledge alert</button>
                </form>
                {% elif alert.acknowledged_at %}
                <div class="ledger-link">Acknowledged {{ alert.acknowledged_at }}{% if alert.acknowledged_by %} by {{ alert.acknowledged_by }}{% endif %}</div>
                {% endif %}
              </div>
              {% endfor %}
            </div>
            {% else %}
            <div class="timeline-empty">No active alerts.</div>
            {% endif %}
            </div>
            <div class="tab-panel-hidden" data-adv-panel="coverage">
            <h4 style="margin-top:12px;">Coverage, change taxonomy, and graph</h4>
            <h4 style="margin-top:8px;">Technique coverage</h4>
            {% if notebook.technique_coverage %}
            <div class="ledger-list">
              {% for item in notebook.technique_coverage[:20] %}
              <div class="ledger-item">
                <div class="ledger-head">
                  <span><strong>{{ item.technique_id }}</strong> {{ item.technique_name }}</span>
                  <span>Coverage: {{ item.coverage_status }}</span>
                  <span>Validation: {{ item.validation_status }}</span>
                </div>
                {% if item.detection_name %}<div class="ledger-link">Detection: {{ item.detection_name }}</div>{% endif %}
                {% if item.control_name %}<div class="ledger-link">Control: {{ item.control_name }}</div>{% endif %}
              </div>
              {% endfor %}
            </div>
            {% else %}
            <div class="timeline-empty">No coverage mappings yet.</div>
            {% endif %}
            <h4 style="margin-top:8px;">Structured change items</h4>
            {% if notebook.change_items %}
            <div class="ledger-list">
              {% for item in notebook.change_items[:12] %}
              <div class="ledger-item">
                <div class="ledger-head">
                  <span>{{ item.change_type }}</span>
                  <span>{{ item.confidence }}</span>
                  <span>{{ item.observed_on or item.created_at }}</span>
                </div>
                <div class="ledger-body">{{ item.change_summary }}</div>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <div class="timeline-empty">No change taxonomy items yet.</div>
            {% endif %}
            <h4 style="margin-top:8px;">Relationship edges</h4>
            {% if notebook.relationship_items %}
            <div class="ledger-list">
              {% for rel in notebook.relationship_items[:20] %}
              <div class="ledger-item">
                <div class="ledger-body">{{ rel.src_entity_type }}:{{ rel.src_entity_key }} -> {{ rel.relationship_type }} -> {{ rel.dst_entity_type }}:{{ rel.dst_entity_key }}</div>
                <div class="ledger-head">
                  <span>{{ rel.confidence }}</span>
                  <span>{{ rel.observed_on or rel.updated_at }}</span>
                </div>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <div class="timeline-empty">No relationship graph edges yet.</div>
            {% endif %}
            </div>

            </details>
          </section>

          <!--  Visuals  -->
          <section class="tab-panel-hidden" id="section-visuals" data-main-panel="visuals">
            <h3 class="section-title">Visuals</h3>
            <div class="section-body">
              <p class="inline-note">Charts and visualizations generated from this actor's tracked data. All built from local data  no external calls.</p>
              <div class="visuals-placeholder-grid">
                <div class="visuals-placeholder">
                  <div class="visuals-placeholder-title">IOC Volume Over Time</div>
                  <div class="visuals-placeholder-desc">IOC count per month, broken down by type. Shows when this actor was infrastructure-heavy vs. quiet.</div>
                </div>
                <div class="visuals-placeholder">
                  <div class="visuals-placeholder-title">Actor Activity Calendar</div>
                  <div class="visuals-placeholder-desc">GitHub-style heatmap  each cell = one day, intensity = event and IOC count.</div>
                </div>
                <div class="visuals-placeholder">
                  <div class="visuals-placeholder-title">ATT&amp;CK Coverage Map</div>
                  <div class="visuals-placeholder-desc">MITRE tactic columns with highlighted techniques attributed to this actor. Click to see referencing events.</div>
                </div>
                <div class="visuals-placeholder">
                  <div class="visuals-placeholder-title">Activity vs. Reporting Correlation</div>
                  <div class="visuals-placeholder-desc">Analyst-added events vs. public reporting over time. Shows whether reporting lags behind observed activity.</div>
                </div>
              </div>
            </div>
          </section>

        </section>
        </div>
        {% endif %}
      </main>
    </div>
    <div id="workflow-tour-modal" class="geo-modal" aria-hidden="true">
      <div class="geo-modal-card" role="dialog" aria-modal="true" aria-labelledby="workflow-tour-title">
        <div class="geo-modal-head">
          <h3 id="workflow-tour-title">Community Workflow Tour</h3>
          <button id="workflow-tour-close" type="button">Close</button>
        </div>
        <div class="section-body">
          <ol>
            <li>Set tracking intent and collection plan in <strong>More actions</strong>.</li>
            <li>Review top changes and quick checks on the main notebook view.</li>
            <li>Add evidence-backed analyst notes with citation URL and observed date.</li>
            <li>Create tasks for follow-up work and assign owner/due date.</li>
            <li>Record operational outcomes (detection/hunt/finding/mitigation).</li>
            <li>Update ATT&amp;CK coverage and telemetry validation status.</li>
            <li>Use role reports and exports for executive, SOC, and IR audiences.</li>
          </ol>
          <div class="review-actions">
            <button id="workflow-tour-dismiss" type="button">Dont show again</button>
          </div>
        </div>
      </div>
    </div>
    <div id="quick-note-modal" class="geo-modal" aria-hidden="true">
      <div class="geo-modal-card" role="dialog" aria-modal="true" aria-labelledby="quick-note-title">
        <div class="geo-modal-head">
          <h3 id="quick-note-title">Add analyst note</h3>
          <button id="quick-note-close" type="button">Close</button>
        </div>
        <form id="quick-note-form" class="quick-note-form">
          <label>
            Analyst
            <input id="quick-note-analyst" type="text" placeholder="Your name" required />
          </label>
          <label>
            Confidence
            <select id="quick-note-confidence">
              <option value="low">Low</option>
              <option value="moderate" selected>Moderate</option>
              <option value="high">High</option>
            </select>
          </label>
          <label>
            Claim type
            <select id="quick-note-claim-type">
              <option value="assessment" selected>Assessment</option>
              <option value="evidence">Evidence-backed</option>
            </select>
          </label>
          <div id="quick-note-evidence-fields" hidden>
            <label>
              Citation URL
              <input id="quick-note-citation-url" type="url" placeholder="https://source/report" />
            </label>
            <label>
              Observed date
              <input id="quick-note-observed-on" type="date" />
            </label>
          </div>
          <label>
            Note
            <textarea id="quick-note-text" placeholder="Evidence-backed analyst note..." required></textarea>
          </label>
          <div id="quick-note-status" class="quick-note-status"></div>
          <div class="quick-note-actions">
            <button id="quick-note-cancel" type="button">Cancel</button>
            <button id="quick-note-save" type="submit">Save note</button>
          </div>
        </form>
      </div>
    </div>
    <div id="geo-modal" class="geo-modal" aria-hidden="true">
      <div class="geo-modal-card" role="dialog" aria-modal="true" aria-labelledby="geo-modal-title">
        <div class="geo-modal-head">
          <h3 id="geo-modal-title">Actor Geography Map</h3>
          <button id="geo-map-close" type="button">Close</button>
        </div>
        <div class="geo-grid">
          <div class="geo-canvas-wrap">
            <div id="geo-map-canvas" aria-label="World actor geography map"></div>
          </div>
          <div class="geo-side">
            <div><strong id="geo-region-title">Select a location</strong></div>
            <div id="geo-region-hint" class="inline-note">Click a country on the map. If country resolution fails, continent selection is used.</div>
            <div id="geo-region-list" class="geo-region-list"></div>
            <div id="geo-actor-detail" class="geo-actor-detail"><small>Select an actor to view details.</small></div>
          </div>
        </div>
      </div>
    </div>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
    <script src="/static/actor_autocomplete.js" defer></script>
    <script src="/static/index.js" defer></script>
    <script src="/static/geography_map.js" defer></script>
    <script src="/static/ui_mode.js" defer></script>
    <div id="ui-toast-stack" class="ui-toast-stack" aria-live="polite" aria-atomic="false"></div>
  </body>
</html>
