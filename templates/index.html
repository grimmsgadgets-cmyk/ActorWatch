<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ActorWatch</title>
    <style>
      body { margin: 0; font-family: Arial, sans-serif; background: #f7f7f7; color: #111; line-height: 1.4; }
      .layout { display: grid; grid-template-columns: 320px 1fr; min-height: 100vh; }
      .sidebar { background: #1e2430; color: #fff; padding: 16px; }
      .sidebar h1 { font-size: 20px; margin: 0 0 12px; }
      .sidebar h3 { margin: 0 0 8px; font-size: 14px; letter-spacing: .01em; }
      .sidebar-panel, .sidebar-card { margin-top: 12px; padding: 10px; border: 1px solid #3d4658; border-radius: 10px; background: #273143; }
      .sidebar-panel:first-of-type { margin-top: 0; }
      .actor-list { list-style: none; padding: 0; margin: 0; }
      .actor-list li { margin-bottom: 6px; }
      .actor-autocomplete-wrap { position: relative; }
      .actor-autocomplete-list {
        position: absolute;
        left: 0;
        right: 0;
        top: calc(100% + 4px);
        z-index: 30;
        border: 1px solid #3d4658;
        border-radius: 8px;
        background: #1f2735;
        max-height: 220px;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(10, 15, 25, 0.35);
      }
      .actor-autocomplete-list[hidden] { display: none; }
      .actor-autocomplete-item {
        width: 100%;
        border: 0;
        border-bottom: 1px solid #2d3646;
        background: transparent;
        color: #e8eef6;
        text-align: left;
        padding: 8px 10px;
        font-size: 12px;
        cursor: pointer;
      }
      .actor-autocomplete-item:last-child { border-bottom: 0; }
      .actor-autocomplete-item:hover,
      .actor-autocomplete-item.active { background: #31415a; }
      .actor-autocomplete-hint {
        display: block;
        margin-top: 6px;
        font-size: 11px;
        color: #a7b7cb;
      }
      .actor-link {
        display: block;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid #3d4658;
        color: #fff;
        text-decoration: none;
        background: #2b3445;
      }
      .actor-link.selected { background: #35527f; border-color: #7ea4df; }
      .actor-name { font-weight: bold; display: block; }
      .actor-scope { font-size: 11px; opacity: 0.9; margin-top: 3px; }
      .actor-row { display: grid; grid-template-columns: 1fr auto; gap: 6px; align-items: stretch; }
      .actor-row form { margin: 0; display: flex; }
      .actor-row .actor-remove {
        padding: 0 4px;
        border-radius: 6px;
        border: 0;
        background: transparent;
        color: #9fb3d5;
        font-size: 11px;
        line-height: 1;
        cursor: pointer;
      }
      .actor-row .actor-remove:hover { color: #d7e4ff; text-decoration: underline; }
      .sidebar form { display: grid; gap: 8px; }
      .sidebar input, .sidebar textarea, .sidebar button { padding: 8px; border-radius: 6px; border: 1px solid #6c7586; }
      .sidebar button { background: #4a7bd0; color: #fff; border: 0; cursor: pointer; }
      .sidebar .action-button {
        display: block;
        width: 100%;
        min-height: 36px;
        padding: 8px;
        border-radius: 6px;
        box-sizing: border-box;
        border: 0;
        background: #4a7bd0;
        color: #fff;
        font-size: 14px;
        line-height: 1.2;
        font-weight: 400;
        text-align: center;
      }
      button,
      .action-button,
      .quick-actions a,
      .quick-actions details.quick-export-menu > summary,
      .question-feedback-btn,
      .live-controls button {
        transition: transform 90ms ease, box-shadow 120ms ease, filter 120ms ease, opacity 120ms ease;
      }
      button:active,
      .action-button:active,
      .quick-actions a:active,
      .quick-actions details.quick-export-menu > summary:active,
      .question-feedback-btn:active,
      .live-controls button:active {
        transform: translateY(1px) scale(0.99);
        filter: brightness(0.94);
        box-shadow: inset 0 0 0 2px rgba(15, 23, 42, 0.14);
      }
      button:focus-visible,
      .action-button:focus-visible,
      .quick-actions a:focus-visible,
      .quick-actions details.quick-export-menu > summary:focus-visible,
      .question-feedback-btn:focus-visible,
      .live-controls button:focus-visible {
        outline: 2px solid #1f4a8a;
        outline-offset: 2px;
      }
      .main { padding: 16px; overflow: hidden; display: flex; flex-direction: column; gap: 12px; }
      .top-status-row { position: sticky; top: 0; z-index: 15; background: #f7f7f7; padding-bottom: 6px; }
      .dashboard { display: grid; grid-template-rows: auto auto minmax(0, 1fr) auto; gap: 10px; flex: 1; min-height: 0; }
      .workspace-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr; gap: 10px; min-height: 0; }
      .workspace-grid .pane { min-height: 0; overflow: auto; }
      .workspace-grid .pane .section-title { position: sticky; top: 0; z-index: 4; background: #fff; }
      .card { background: #fff; border: 1px solid #d9e2ef; border-radius: 10px; padding: 12px; margin-bottom: 0; box-shadow: 0 1px 0 rgba(15, 23, 42, 0.03); }
      .card.span-2 { grid-column: 1 / -1; }
      .ataglance-strip { display: grid; grid-template-columns: repeat(4, minmax(120px, 1fr)); gap: 10px; padding: 10px 12px; position: sticky; top: 54px; z-index: 10; }
      .ataglance-metric { border: 1px solid #dce7f8; border-radius: 8px; background: #f8fbff; padding: 8px; min-height: 54px; }
      .ataglance-label { font-size: 10px; text-transform: uppercase; color: #64748b; letter-spacing: .03em; }
      .ataglance-value { font-size: 14px; font-weight: 700; color: #0f172a; margin-top: 3px; }
      .ataglance-value a { color: inherit; text-decoration: underline; text-decoration-thickness: 1px; text-underline-offset: 2px; }
      .ataglance-value a:hover { text-decoration-thickness: 2px; }
      .mini-trend-inline { display: flex; align-items: flex-end; gap: 2px; margin-top: 6px; height: 20px; overflow: hidden; }
      .mini-trend-bar { width: 6px; border-radius: 2px; background: #89a8d8; }
      .mini-trend-bar.peak { background: #c44f4f; }
      .mini-trend-meta { margin-top: 4px; font-size: 10px; color: #475569; line-height: 1.2; }
      .mini-trend-labels { display: flex; justify-content: space-between; margin-top: 2px; font-size: 9px; color: #64748b; }
      .mini-trend-kpis { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 4px; margin-top: 5px; }
      .mini-trend-kpi { border: 1px solid #d7e2f4; border-radius: 6px; background: #f2f7ff; padding: 3px 4px; }
      .mini-trend-kpi .k { display: block; font-size: 9px; text-transform: uppercase; letter-spacing: .02em; color: #64748b; line-height: 1.1; }
      .mini-trend-kpi .v { display: block; font-size: 11px; font-weight: 700; color: #1f2937; line-height: 1.2; margin-top: 1px; }
      .mini-trend-kpi.up .v { color: #0f6b2f; }
      .mini-trend-kpi.down .v { color: #8a1c1c; }
      .mini-trend-kpi.flat .v { color: #334155; }
      .bottom-drawer { min-height: 0; }
      .section-title { margin-top: 0; margin-bottom: 8px; font-size: 16px; line-height: 1.2; padding-bottom: 6px; border-bottom: 1px solid #e8eef8; }
      .role-chip { display: inline-block; margin-left: 8px; font-size: 10px; text-transform: uppercase; letter-spacing: .03em; border: 1px solid #cfdcee; border-radius: 999px; padding: 2px 7px; color: #41556f; background: #f3f8ff; vertical-align: middle; }
      .section-body { padding-right: 2px; }
      .section-body p { margin: 0 0 6px; }
      .section-body ul { margin-top: 4px; }
      .event { border-left: 3px solid #3f5f9a; margin: 6px 0; padding: 6px 8px; background: #f8fbff; }
      .event.notable-primary { border-left-color: #c44f4f; background: #fff1f1; }
      .event.notable-primary strong { color: #7f1d1d; }
      .change-list { display: grid; gap: 8px; margin-top: 8px; }
      .change-row { border: 1px solid #dfe6f3; border-radius: 8px; padding: 8px; background: #fbfdff; }
      .change-row-main { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; font-size: 12px; }
      .change-row-title { font-weight: 600; font-size: 13px; color: #1f2937; }
      .change-row-source { margin-top: 4px; font-size: 12px; color: #334155; }
      .timeline-graphic { position: relative; margin: 10px 0 0 6px; padding-left: 28px; }
      .timeline-graphic::before { content: ""; position: absolute; left: 9px; top: 0; bottom: 0; width: 3px; background: #c7d7ef; }
      .timeline-node { position: relative; margin: 0 0 14px; padding: 10px; border: 1px solid #d8e1ef; border-radius: 8px; background: #f9fbff; }
      .timeline-node::before { content: ""; position: absolute; left: -24px; top: 14px; width: 12px; height: 12px; border-radius: 50%; background: #3f5f9a; }
      .timeline-row { display: grid; grid-template-columns: 150px 1fr; gap: 10px; align-items: start; margin-bottom: 10px; }
      .timeline-date { font-size: 12px; color: #334155; }
      .timeline-bar { height: 8px; border-radius: 999px; background: linear-gradient(90deg, #4a7bd0, #9bb7e8); margin: 6px 0 10px; }
      .timeline-meta { font-size: 12px; color: #334155; margin-top: 4px; }
      .timeline-ataglance { display: grid; grid-template-columns: 1fr 2fr; gap: 10px; align-items: start; margin-bottom: 10px; }
      .deviation-strip { border: 1px solid #dce7f8; border-radius: 8px; background: #f7fbff; padding: 8px; }
      .deviation-strip h4 { margin: 0 0 6px; font-size: 13px; }
      .chip-line { display: flex; flex-wrap: wrap; gap: 6px; }
      .chip { display: inline-block; font-size: 11px; border-radius: 999px; border: 1px solid #9db2d3; padding: 2px 8px; background: #eef4ff; }
      .chip.alert { border-color: #e4b26b; background: #fff6e7; }
      .mini-graph { border: 1px solid #dce7f8; border-radius: 8px; padding: 8px; background: #fbfdff; }
      .mini-graph h4 { margin: 0 0 6px; font-size: 13px; }
      .graph-cols { display: flex; align-items: flex-end; gap: 6px; min-height: 110px; }
      .graph-col { width: 28px; display: flex; flex-direction: column; align-items: center; gap: 4px; }
      .stack { width: 20px; height: 100px; border-radius: 6px; border: 1px solid #d8e1ef; display: flex; flex-direction: column-reverse; overflow: hidden; background: #f1f4fa; }
      .stack-seg { width: 100%; }
      .graph-label { font-size: 10px; color: #4a5568; }
      .graph-legend { display: flex; flex-wrap: wrap; gap: 6px 10px; margin-top: 8px; font-size: 11px; color: #334155; }
      .legend-item { display: inline-flex; align-items: center; gap: 5px; }
      .legend-swatch { width: 10px; height: 10px; border-radius: 2px; border: 1px solid #c9d3e5; }
      .timeline-footer-link { margin-top: 8px; font-size: 12px; }
      .priority-strip { background: #fff; border: 1px solid #dfe6f3; border-radius: 10px; padding: 10px; margin-bottom: 10px; }
      .decision-queue { margin-bottom: 0; }
      .decision-header { display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 8px; }
      .phase-block { margin-bottom: 8px; }
      .phase-title { font-size: 11px; text-transform: uppercase; letter-spacing: .02em; color: #475569; margin: 0 0 4px; }
      .dq-card { border: 1px solid #e3e9f5; border-radius: 8px; padding: 7px 8px; background: #fbfdff; margin-bottom: 6px; }
      .dq-line { font-size: 12px; line-height: 1.35; color: #1f2937; margin: 4px 0; }
      .dq-line strong { font-weight: 600; }
      .dq-list { display: grid; gap: 6px; }
      .dq-row { border: 1px solid #e3e9f5; border-radius: 10px; background: #fbfdff; }
      .dq-row > summary { cursor: pointer; padding: 8px 10px; font-size: 12px; list-style: none; display: flex; align-items: center; justify-content: space-between; gap: 8px; }
      .dq-row > summary::-webkit-details-marker { display: none; }
      .dq-detail { padding: 0 10px 10px; border-top: 1px solid #ecf1fa; }
      .deemphasized { opacity: 0.75; }
      .summary-list { margin: 8px 0 0; padding-left: 18px; }
      .summary-list li { margin: 4px 0; font-size: 13px; line-height: 1.4; color: #1f2937; }
      .who-meta { margin: 6px 0 0; font-size: 12px; color: #334155; line-height: 1.4; }
      .who-meta a { color: #1f4a8a; }
      .who-summary { border: 1px solid #dce7f8; border-radius: 8px; background: #f8fbff; padding: 8px; margin-bottom: 8px; }
      .who-summary p { margin: 0; font-size: 14px; line-height: 1.45; color: #0f172a; }
      .who-why { margin: 8px 0; border: 1px solid #dce7f8; border-radius: 8px; background: #f8fbff; padding: 8px; font-size: 15px; line-height: 1.45; color: #0f172a; font-weight: 500; }
      .who-heading { margin: 8px 0 6px; font-size: 13px; letter-spacing: .01em; color: #1f2937; }
      .technique-grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 8px; margin-top: 8px; }
      .technique-item { border: 1px solid #dfe6f3; border-radius: 8px; background: #fbfdff; padding: 8px; }
      .technique-head { display: flex; align-items: center; gap: 6px; margin-bottom: 3px; }
      .technique-pill { display: inline-block; border-radius: 999px; border: 1px solid #9bb6dc; background: #eef4ff; color: #1f4a8a; padding: 2px 8px; font-size: 11px; text-decoration: none; font-weight: 600; }
      .technique-name { font-size: 13px; color: #0f172a; line-height: 1.35; }
      .technique-phase { font-size: 12px; color: #334155; line-height: 1.35; }
      .who-kpis { display: grid; grid-template-columns: repeat(3, minmax(120px, 1fr)); gap: 8px; margin: 10px 0; }
      .who-kpi { border: 1px solid #dfe6f3; border-radius: 8px; background: #fbfdff; padding: 8px; }
      .who-kpi-label { font-size: 11px; text-transform: uppercase; letter-spacing: .02em; color: #475569; }
      .who-kpi-value { margin-top: 2px; font-size: 15px; font-weight: 700; color: #0f172a; line-height: 1.3; }
      .snapshot-grid { display: grid; grid-template-columns: repeat(3, minmax(180px, 1fr)); gap: 8px; margin: 10px 0; }
      .snapshot-card { border: 1px solid #dfe6f3; border-radius: 10px; padding: 10px; background: #fbfdff; border-top: 3px solid #9aa8bf; min-height: 118px; display: flex; flex-direction: column; gap: 6px; }
      .snapshot-card.conf-high { border-top-color: #c44f4f; background: #fff7f7; }
      .snapshot-card.conf-medium { border-top-color: #d0a13b; background: #fffaf0; }
      .snapshot-card.conf-low { border-top-color: #4e7ecf; background: #f6faff; }
      .snapshot-title { font-size: 11px; text-transform: uppercase; letter-spacing: .04em; color: #475569; margin: 0; }
      .snapshot-text { font-size: 13px; line-height: 1.35; margin: 0; color: #1f2937; }
      .snapshot-meta { font-size: 11px; color: #475569; margin-top: auto; display: flex; gap: 8px; flex-wrap: wrap; }
      .helper-box { border: 1px solid #d9e3f7; border-radius: 8px; background: #f5f8ff; padding: 8px; margin: 8px 0; }
      .helper-box h4 { margin: 0 0 6px; font-size: 13px; }
      .helper-box p { margin: 0 0 6px; font-size: 12px; line-height: 1.35; color: #1f2937; }
      .helper-box ul { margin: 6px 0 0; padding-left: 18px; }
      .helper-box li { margin: 3px 0; font-size: 12px; line-height: 1.35; }
      .inline-note { margin: 6px 0 0; font-size: 12px; color: #334155; }
      .kpi-strip { display: grid; grid-template-columns: repeat(4, minmax(120px, 1fr)); gap: 8px; margin-bottom: 10px; }
      .kpi-card { background: #fff; border: 1px solid #dfe6f3; border-radius: 10px; padding: 8px 10px; }
      .kpi-label { font-size: 11px; color: #475569; text-transform: uppercase; letter-spacing: .02em; }
      .kpi-value { font-size: 18px; font-weight: 700; margin-top: 2px; }
      .priority-list { display: grid; gap: 6px; }
      .priority-item { display: grid; grid-template-columns: 70px 1fr; gap: 8px; align-items: start; border: 1px solid #edf1f7; border-radius: 8px; padding: 6px 8px; background: #fbfdff; }
      .priority-body { display: grid; gap: 4px; }
      .priority-q { font-size: 13px; line-height: 1.3; }
      .priority-meta { font-size: 11px; color: #475569; line-height: 1.25; }
      .pbadge { display: inline-block; border-radius: 999px; padding: 2px 8px; border: 1px solid #aeb8c5; font-size: 11px; }
      .pbadge.high { background: #ffe9e8; border-color: #e5a7a4; }
      .pbadge.medium { background: #fff6df; border-color: #e6cb86; }
      .pbadge.low { background: #edf7ed; border-color: #a8d0aa; }
      .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #888; }
      .badge.open { background: #fff7d8; }
      .badge.resolved { background: #e1f5e6; }
      .badge.freshness-new { background: #eaf9ef; border-color: #9fd2ac; }
      .badge.freshness-recent { background: #eef6ff; border-color: #a7c2ea; }
      .badge.freshness-stale { background: #fff6e8; border-color: #e8c885; }
      .badge.freshness-old { background: #f4f5f7; border-color: #c8ced8; }
      .badge.freshness-unknown { background: #f4f5f7; border-color: #c8ced8; }
      .source-item { border-bottom: 1px solid #e3e3e3; padding: 8px 0; }
      .recent-source-list { margin: 6px 0 0; padding: 0; list-style: none; display: grid; gap: 8px; }
      .recent-source-list li { margin: 0; font-size: 13px; border: 1px solid #e4ebf7; border-radius: 8px; background: #fbfdff; padding: 8px; }
      .source-headline { display: flex; flex-wrap: wrap; align-items: center; gap: 6px; margin-bottom: 4px; }
      .source-meta { display: block; color: #475569; font-size: 11px; line-height: 1.35; margin-bottom: 2px; }
      .source-title-link {
        display: inline-block;
        max-width: 56ch;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        vertical-align: bottom;
      }
      .question { border: 1px solid #ddd; border-radius: 8px; padding: 8px; margin: 8px 0; }
      blockquote { margin: 6px 0; padding: 8px 10px; background: #f3f5f7; border-left: 3px solid #9aa5b1; }
      .guidance { border: 1px solid #d6e3f5; border-radius: 8px; background: #f5faff; padding: 10px; margin: 8px 0; }
      .notice { background: #fff6d9; border: 1px solid #e1cc78; border-radius: 8px; padding: 6px 8px; margin-bottom: 8px; }
      .top-status-row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 10px; }
      .status-chip { margin-bottom: 0; padding: 4px 8px; font-size: 11px; line-height: 1.25; width: fit-content; max-width: 340px; border-radius: 999px; }
      .status-chip strong { font-weight: 600; }
      .status-meta { margin-top: 3px; font-size: 10px; color: #334155; }
      .status-running { background: #eef6ff; border-color: #a7c2ea; }
      .status-ready { background: #eaf9ef; border-color: #9fd2ac; }
      .status-error { background: #ffeceb; border-color: #e4a8a3; }
      .status-idle { background: #f4f5f7; border-color: #c8ced8; }
      .status-warning { background: #fff6e8; border-color: #e8c885; }
      .status-llm-ok { background: #eaf9ef; border-color: #9fd2ac; }
      .status-llm-bad { background: #ffeceb; border-color: #e4a8a3; }
      .status-working { background: #eef6ff; border-color: #8fb2e8; }
      .ui-activity-strip { max-width: 520px; }
      .region-busy { opacity: 0.55; pointer-events: none; transition: opacity 120ms ease; }
      .is-loading-btn {
        opacity: 0.85;
        cursor: progress;
        box-shadow: inset 0 0 0 2px rgba(15, 23, 42, 0.14);
      }
      .ui-toast-stack { position: fixed; right: 14px; bottom: 14px; z-index: 60; display: grid; gap: 8px; width: min(340px, calc(100vw - 28px)); }
      .ui-toast { border-radius: 8px; border: 1px solid #c8d7ef; padding: 8px 10px; font-size: 12px; box-shadow: 0 8px 20px rgba(15, 23, 42, 0.12); background: #f8fbff; color: #0f172a; }
      .ui-toast.success { background: #edf9f0; border-color: #a9d9b3; }
      .ui-toast.error { background: #fff0ef; border-color: #e4b1ad; }
      .ui-toast.info { background: #eef5ff; border-color: #b5caec; }
      .progress-wrap { margin-top: 4px; background: #dfe9f7; border-radius: 999px; height: 6px; overflow: hidden; width: 120px; }
      .progress-bar { height: 6px; width: 35%; background: #4a7bd0; border-radius: 999px; animation: loading 1.1s linear infinite; }
      @keyframes loading { 0% { margin-left: -35%; } 100% { margin-left: 100%; } }
      .empty { padding: 40px; text-align: center; background: #fff; border: 1px dashed #bbb; border-radius: 8px; }
      pre { white-space: pre-wrap; margin: 0; }
      .track-grid { display: grid; gap: 8px; }
      .track-row { display: flex; justify-content: space-between; align-items: center; border: 1px solid #ddd; border-radius: 8px; padding: 8px; }
      .mini-form { display: inline; }
      .mini-form button { padding: 6px 10px; }
      details.compact { border: 1px solid #e3e3e3; border-radius: 8px; padding: 8px 10px; margin-top: 8px; background: #fafafa; }
      details.compact > summary { cursor: pointer; font-weight: 600; }
      .sidebar-card { margin-top: 12px; }
      .sidebar-card h3 { margin: 0 0 8px; }
      .sidebar-card small { display: block; opacity: 0.9; margin-bottom: 8px; line-height: 1.35; }
      .learning-grid { display: grid; gap: 6px; }
      .learning-grid label { font-size: 12px; opacity: 0.95; }
      .learning-status { font-size: 11px; color: #c6d4ea; min-height: 14px; }
      .feedback-actions { display: flex; gap: 6px; margin-top: 6px; }
      .feedback-actions button { padding: 4px 8px; font-size: 12px; border-radius: 6px; border: 1px solid #cdd8ea; cursor: pointer; }
      .feedback-actions .positive { background: #eaf9ef; border-color: #9fd2ac; }
      .feedback-actions .negative { background: #fff2ef; border-color: #e3b0a7; }
      .feedback-status { font-size: 11px; color: #475569; margin-left: 6px; }
      .sidebar details.compact { background: #2b3445; border: 1px solid #3d4658; color: #fff; }
      .sidebar details.compact > summary { list-style: none; }
      .sidebar details.compact > summary::-webkit-details-marker { display: none; }
      .sidebar .secondary-action {
        margin-top: 8px;
        padding: 0;
        border: 0;
        background: transparent;
      }
      .sidebar .secondary-action > summary {
        cursor: pointer;
      }
      .sidebar .secondary-action[open] {
        padding: 8px;
        border: 1px solid #3d4658;
        border-radius: 8px;
        background: #2b3445;
      }
      .quick-actions { display: grid; gap: 8px; margin-bottom: 10px; }
      .quick-actions form { margin: 0; }
      .quick-actions details.quick-export-menu { margin: 0; }
      .quick-actions details.quick-export-menu > summary { list-style: none; }
      .quick-actions details.quick-export-menu > summary::-webkit-details-marker { display: none; }
      .quick-actions a, .quick-actions button {
        display: block;
        width: 100%;
        min-height: 36px;
        text-align: center;
        border: 0;
        border-radius: 8px;
        padding: 8px;
        font-size: 12px;
        background: #4a7bd0;
        color: #fff;
        text-decoration: none;
        cursor: pointer;
      }
      .quick-actions a, .quick-actions button { display: inline-flex; align-items: center; justify-content: center; box-sizing: border-box; }
      .quick-actions details.quick-export-menu > summary {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        box-sizing: border-box;
        width: 100%;
        min-height: 36px;
        text-align: center;
        border: 0;
        border-radius: 8px;
        padding: 8px;
        font-size: 12px;
        background: #4a7bd0;
        color: #fff;
        text-decoration: none;
        cursor: pointer;
      }
      .quick-actions .quick-export-panel {
        margin-top: 8px;
        padding: 8px;
        border: 1px solid #3d4658;
        border-radius: 8px;
        background: #2b3445;
        display: grid;
        gap: 8px;
      }
      .quick-actions .quick-export-panel label { font-size: 11px; color: #d6e3f5; }
      .quick-actions .quick-export-panel select {
        width: 100%;
        background: #1f2735;
        border: 1px solid #465268;
        color: #fff;
        border-radius: 6px;
        padding: 8px;
      }
      .sidebar .secondary-action button { min-height: 34px; font-size: 12px; }
      .sidebar .secondary-action[open] > summary { margin-bottom: 8px; }
      .sidebar .interactive-panel { background: #2b3445; border-color: #3d4658; color: #fff; }
      .sidebar .review-strip { background: #2b3445; border-color: #3d4658; }
      .sidebar .review-metric { background: #1f2735; border-color: #3d4658; }
      .sidebar .review-metric .label { color: #b8c7de; }
      .sidebar .review-metric .value { color: #ffffff; }
      .sidebar .review-meta { color: #c7d4ea; }
      .sidebar .review-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .sidebar .review-metric { min-width: 0; }
      .sidebar .review-metric .value { font-size: 13px; overflow-wrap: anywhere; }
      .sidebar .review-actions { gap: 6px; }
      .sidebar .review-actions button { flex: 1 1 140px; }
      .sidebar .ledger-controls label { color: #d6e3f5; }
      .sidebar .ledger-controls input,
      .sidebar .ledger-controls select,
      .sidebar .obs-row input,
      .sidebar .obs-row select,
      .sidebar .obs-row textarea {
        background: #1f2735;
        border-color: #465268;
        color: #fff;
      }
      .sidebar .ledger-item { background: #1f2735; border-color: #3d4658; }
      .sidebar .ledger-head,
      .sidebar .ledger-body,
      .sidebar .ledger-link a,
      .sidebar .ledger-link span,
      .sidebar .observation-meta,
      .sidebar .timeline-empty,
      .sidebar .ledger-count,
      .sidebar .inline-note { color: #d6e3f5; }
      .sidebar .filter-chip { background: #1f2735; border-color: #4f5e77; color: #fff; }
      .sidebar .obs-actions button,
      .sidebar .ledger-actions button,
      .sidebar .ledger-actions a,
      .sidebar .review-actions button { background: #1f2735; border-color: #4f5e77; color: #fff; }
      .req-item { border: 1px solid #e3e3e3; border-radius: 8px; padding: 8px; margin-bottom: 8px; background: #fcfcff; }
      .req-item p { margin: 6px 0; font-size: 13px; line-height: 1.35; }
      .req-item form { margin-top: 6px; }
      .req-validation { margin-top: 6px; font-size: 11px; color: #334155; background: #f5f8ff; border: 1px solid #d9e3f7; border-radius: 6px; padding: 6px; }
      .live-pill { border: 1px solid #c7d4ea; border-radius: 999px; padding: 4px 8px; font-size: 11px; color: #334155; background: #f8fbff; }
      .interactive-panel { border: 1px solid #dce7f8; border-radius: 8px; background: #f9fcff; padding: 8px; margin-top: 8px; }
      .interactive-panel h4 { margin: 0 0 6px; font-size: 13px; }
      .filter-row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 8px; }
      .filter-row select, .filter-row button, .filter-row input { padding: 5px 8px; border-radius: 6px; border: 1px solid #c7d4ea; background: #fff; font-size: 12px; }
      .filter-chips { display: flex; flex-wrap: wrap; gap: 6px; margin: 6px 0 8px; }
      .filter-chip { display: inline-flex; align-items: center; gap: 5px; border: 1px solid #b9cae7; border-radius: 999px; padding: 2px 8px; font-size: 11px; background: #f3f8ff; color: #1f2937; }
      .filter-chip button { border: 0; background: transparent; font-size: 12px; cursor: pointer; color: #334155; padding: 0; line-height: 1; }
      .timeline-table { width: 100%; border-collapse: collapse; font-size: 12px; }
      .timeline-table th, .timeline-table td { border-bottom: 1px solid #e3ebf8; text-align: left; padding: 6px; vertical-align: top; }
      .timeline-table tr:hover { background: #f3f8ff; }
      .timeline-empty { margin-top: 8px; font-size: 12px; color: #475569; }
      .observation-meta { margin-top: 4px; font-size: 11px; color: #475569; }
      .observation-guidance { margin-top: 2px; font-size: 11px; color: #7a3e00; }
      .observation-history { margin-top: 6px; border-top: 1px dashed #cad6ea; padding-top: 6px; font-size: 11px; color: #334155; }
      .observation-history-item { margin-top: 4px; padding: 4px 6px; border: 1px solid #dce7f8; border-radius: 6px; background: #fff; }
      .observation-history-head { font-size: 10px; color: #5b677a; margin-bottom: 2px; }
      .obs-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
      .obs-row input, .obs-row select, .obs-row textarea { width: 100%; box-sizing: border-box; padding: 6px; border-radius: 6px; border: 1px solid #cdd8ea; font-size: 12px; }
      .obs-row textarea { min-height: 70px; resize: vertical; grid-column: 1 / -1; }
      .obs-actions { display: flex; gap: 6px; align-items: center; margin-top: 6px; }
      .obs-actions button,
      .ledger-actions button,
      .ledger-actions a,
      .review-actions button {
        border: 1px solid #b8c7e2;
        background: #f7fbff;
        border-radius: 6px;
        padding: 5px 8px;
        font-size: 12px;
        cursor: pointer;
        min-height: 30px;
      }
      .ledger-list { display: grid; gap: 8px; margin-top: 8px; }
      .ledger-item { border: 1px solid #dce7f8; border-radius: 8px; background: #fbfdff; padding: 8px; }
      .ledger-head { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 4px; font-size: 11px; color: #475569; }
      .ledger-body { font-size: 13px; line-height: 1.35; color: #1f2937; margin-bottom: 4px; }
      .ledger-link { font-size: 12px; }
      .ledger-controls { display: grid; grid-template-columns: repeat(5, minmax(120px, 1fr)); gap: 8px; align-items: end; margin-top: 8px; }
      .ledger-controls label { display: block; font-size: 11px; color: #334155; margin-bottom: 3px; }
      .ledger-controls input, .ledger-controls select { width: 100%; box-sizing: border-box; padding: 6px; border: 1px solid #cdd8ea; border-radius: 6px; background: #fff; font-size: 12px; }
      .ledger-actions { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; margin-top: 8px; }
      .ledger-actions a { text-decoration: none; color: #1f2937; }
      .ledger-count { font-size: 11px; color: #475569; }
      .review-strip { border: 1px solid #d9e7fb; border-radius: 8px; background: #f7fbff; padding: 8px; margin-bottom: 8px; }
      .review-strip h4 { margin: 0 0 6px; font-size: 13px; }
      .review-grid { display: grid; grid-template-columns: repeat(4, minmax(120px, 1fr)); gap: 8px; }
      .review-metric { border: 1px solid #dce7f8; border-radius: 8px; background: #fff; padding: 6px; }
      .review-metric .label { font-size: 10px; text-transform: uppercase; letter-spacing: .02em; color: #64748b; }
      .review-metric .value { font-size: 14px; font-weight: 600; margin-top: 2px; color: #0f172a; }
      .review-actions { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; margin-top: 8px; }
      .review-actions button { background: #fff; }
      .review-meta { font-size: 11px; color: #475569; }
      .live-controls { display: inline-flex; gap: 6px; align-items: center; }
      .live-controls button { border: 1px solid #c7d4ea; background: #fff; border-radius: 999px; font-size: 11px; padding: 4px 8px; cursor: pointer; }
      .ops-health { border: 1px solid #d9e7fb; border-radius: 8px; background: #f7fbff; padding: 8px; margin-top: 8px; }
      .ops-health h4 { margin: 0 0 6px; font-size: 13px; }
      .ops-health-grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 6px; }
      .ops-health-item { border: 1px solid #dce7f8; border-radius: 8px; background: #fff; padding: 6px; min-width: 0; }
      .ops-health-item .label { font-size: 10px; text-transform: uppercase; letter-spacing: .02em; color: #64748b; }
      .ops-health-item .value { font-size: 13px; font-weight: 600; color: #0f172a; margin-top: 2px; overflow-wrap: anywhere; }
      .merge-row { margin-top: 8px; padding-top: 8px; border-top: 1px dashed #4f5e77; }
      .merge-list { margin: 6px 0 0; padding: 0; list-style: none; display: grid; gap: 6px; }
      .merge-list li { margin: 0; }
      .merge-list form { display: grid; gap: 6px; }
      .merge-list button { min-height: 32px; font-size: 12px; }
      @media (max-width: 1180px) {
        .workspace-grid { grid-template-columns: 1fr; }
        .workspace-grid .pane { min-height: auto; overflow: visible; }
        .workspace-grid { grid-template-rows: auto; }
        .ataglance-strip { grid-template-columns: repeat(2, minmax(120px, 1fr)); }
        .timeline-ataglance { grid-template-columns: 1fr; }
        .kpi-strip { grid-template-columns: repeat(2, minmax(120px, 1fr)); }
        .snapshot-grid { grid-template-columns: 1fr; }
        .who-kpis { grid-template-columns: 1fr; }
        .technique-grid { grid-template-columns: 1fr; }
      }
      @media (max-width: 960px) {
        .layout { grid-template-columns: 1fr; min-height: auto; }
        .main { overflow: visible; }
        .top-status-row, .ataglance-strip, .workspace-grid .pane .section-title { position: static; }
        .dashboard { height: auto; }
        .status-chip { max-width: 100%; width: 100%; }
        .obs-row { grid-template-columns: 1fr; }
        .ledger-controls { grid-template-columns: 1fr 1fr; }
        .review-grid { grid-template-columns: 1fr 1fr; }
      }
    </style>
  </head>
  <body {% if notebook %}data-actor-id="{{ notebook.actor.id }}"{% endif %}>
    <div class="layout">
      <aside class="sidebar">
        <h1>ActorWatch</h1>
        <div class="sidebar-panel">
          <h3>Tracked actors</h3>
          <ul class="actor-list">
            {% for actor in actors %}
            <li>
              <div class="actor-row">
                <a class="actor-link {% if selected_actor_id == actor.id %}selected{% endif %}" href="/?actor_id={{ actor.id }}">
                  <span class="actor-name">{{ actor.display_name }}</span>
                  <span class="actor-scope">Updated {{ actor.last_updated_label or 'Unknown' }}</span>
                </a>
                <form method="post" action="/actors/{{ actor.id }}/untrack">
                  <button type="submit" class="actor-remove" aria-label="Untrack {{ actor.display_name }}">remove</button>
                </form>
              </div>
            </li>
            {% else %}
            <li><span class="actor-scope">No tracked actors yet.</span></li>
            {% endfor %}
          </ul>
        </div>

        <div class="sidebar-panel">
          <h3>Add actor</h3>
          <form id="add-actor-form" method="post" action="/actors/new">
            <div class="actor-autocomplete-wrap">
              <input id="add-actor-input" type="text" name="display_name" placeholder="Display name" autocomplete="off" required />
              <div id="actor-autocomplete-list" class="actor-autocomplete-list" role="listbox" aria-label="Actor suggestions" hidden></div>
            </div>
            <button class="action-button" type="submit">Add actor</button>
            <small id="actor-autocomplete-hint" class="actor-autocomplete-hint"></small>
          </form>
          {% if duplicate_actor_groups %}
          <div class="merge-row">
            <small>Duplicate actor records detected. Use one-click merge below.</small>
            <ul class="merge-list">
              {% for group in duplicate_actor_groups %}
              {% for source_actor in group.source_actors %}
              <li>
                <form method="post" action="/actors/{{ group.target_actor.id }}/merge">
                  <input type="hidden" name="source_actor_id" value="{{ source_actor.id }}" />
                  <button type="submit">Merge {{ source_actor.display_name }} into {{ group.target_actor.display_name }}</button>
                </form>
              </li>
              {% endfor %}
              {% endfor %}
            </ul>
          </div>
          {% endif %}
        </div>

        {% if notebook %}
        <div class="sidebar-card">
          <h3>Quick actions</h3>
          <div class="quick-actions">
            <form method="post" action="/actors/{{ notebook.actor.id }}/refresh">
              <button type="submit">Refresh actor</button>
            </form>
            <form method="post" action="/actors/{{ notebook.actor.id }}/observations/auto-snapshot">
              <button type="submit">Auto-note changes</button>
            </form>
            <a href="/actors/{{ notebook.actor.id }}/timeline/details">Open timeline details</a>
            <details class="quick-export-menu" id="analyst-pack-menu">
              <summary id="analyst-pack-menu-trigger">Export analyst pack</summary>
              <div class="quick-export-panel">
                {% if actors %}
                <label for="analyst-pack-actor-select">Select actor</label>
                <select id="analyst-pack-actor-select" aria-label="Select tracked actor for analyst pack export">
                  {% for actor in actors %}
                  <option value="{{ actor.id }}" {% if selected_actor_id == actor.id %}selected{% endif %}>{{ actor.display_name }}</option>
                  {% endfor %}
                </select>
                {% endif %}
                <a id="analyst-pack-export-json-link" href="/actors/{{ notebook.actor.id }}/export/analyst-pack.json" target="_blank" rel="noreferrer">Export JSON pack</a>
                <a id="analyst-pack-export-pdf-link" href="/actors/{{ notebook.actor.id }}/export/analyst-pack.pdf" target="_blank" rel="noreferrer">Export PDF pack</a>
              </div>
            </details>
          </div>
          <details class="compact secondary-action">
            <summary class="action-button">More actions</summary>
            <form method="post" action="/actors/{{ notebook.actor.id }}/requirements/generate">
              <label for="priority_mode">Priority Mode</label>
              <select id="priority_mode" name="priority_mode">
                <option value="Strategic" {% if notebook.requirements_context.priority_mode == 'Strategic' %}selected{% endif %}>Strategic (PIR)</option>
                <option value="Operational" {% if notebook.requirements_context.priority_mode == 'Operational' %}selected{% endif %}>Operational (GIR)</option>
                <option value="Tactical" {% if notebook.requirements_context.priority_mode == 'Tactical' %}selected{% endif %}>Tactical (IR)</option>
              </select>
              <label for="org_context">Org Context</label>
              <textarea id="org_context" name="org_context" rows="4" placeholder="Critical assets, business unit, environment, constraints...">{{ notebook.requirements_context.org_context }}</textarea>
              <button class="action-button" type="submit">Generate PIR/GIR/IR</button>
            </form>
            <form method="post" action="/actors/{{ notebook.actor.id }}/sources">
              <input type="url" name="source_url" placeholder="https://..." required />
              <button type="submit">Fetch and add source</button>
            </form>
            <form method="post" action="/actors/{{ notebook.actor.id }}/sources/import-feeds">
              <button type="submit">Import established CTI RSS sources</button>
            </form>
            <form method="post" action="/actors/{{ notebook.actor.id }}/iocs">
              <select name="ioc_type">
                <option value="ip">IP</option>
                <option value="domain">Domain</option>
                <option value="hash">Hash</option>
                <option value="url">URL</option>
                <option value="email">Email</option>
                <option value="indicator" selected>Indicator</option>
              </select>
              <select name="handling_tlp">
                <option value="TLP:CLEAR" selected>TLP:CLEAR</option>
                <option value="TLP:GREEN">TLP:GREEN</option>
                <option value="TLP:AMBER">TLP:AMBER</option>
                <option value="TLP:AMBER+STRICT">TLP:AMBER+STRICT</option>
                <option value="TLP:RED">TLP:RED</option>
              </select>
              <input type="text" name="source_ref" placeholder="Source reference (optional)" />
              <textarea name="ioc_values" rows="4" placeholder="One IOC per line or comma-separated" required></textarea>
              <button type="submit">Save IOCs</button>
            </form>
          </details>
          {% if notebook.requirements %}
          <details class="compact">
            <summary>Requirements ({{ notebook.requirements | length }})</summary>
            {% for req in notebook.requirements[:3] %}
            <div class="req-item">
              <div><span class="badge">{{ req.req_type }}</span> <span class="badge {% if req.status == 'open' %}open{% else %}resolved{% endif %}">{{ req.status }}</span></div>
              <p><strong>{{ req.requirement_text }}</strong></p>
              {% if req.status == 'open' %}
              <form method="post" action="/requirements/{{ req.id }}/resolve">
                <input type="hidden" name="actor_id" value="{{ notebook.actor.id }}" />
                <button type="submit">Mark documented</button>
              </form>
              {% endif %}
            </div>
            {% endfor %}
          </details>
          {% endif %}
        </div>

        <div class="sidebar-card" id="section-learning">
          <h3>Learning controls</h3>
          <small>Tune hunt query style to your environment and rate quick checks.</small>
          <div class="learning-grid">
            <label for="env-query-dialect">Query dialect</label>
            <select id="env-query-dialect">
              <option value="generic">Generic</option>
              <option value="kql">KQL</option>
              <option value="spl">SPL</option>
              <option value="eql">EQL</option>
            </select>
            <label for="env-time-window">Default time window (hours)</label>
            <input id="env-time-window" type="number" min="1" max="720" value="24" />
            <button type="button" id="env-profile-save">Save learning profile</button>
            <div id="env-profile-status" class="learning-status"></div>
          </div>
        </div>

        <div class="sidebar-card" id="section-history-left">
          <h3>Notes and history</h3>
          <small>Keep one short running note, then review/export changes over time.</small>
          <details class="compact" style="margin-top:8px;">
            <summary>Analyst note best practices</summary>
            <div class="section-body">
              <div><strong>Use this format:</strong> observation -> evidence -> action.</div>
              <div><strong>Observation:</strong> what you saw (specific event, host, user, IOC).</div>
              <div><strong>Evidence:</strong> one source link or log reference that supports it.</div>
              <div><strong>Action:</strong> contain, monitor, escalate, or close.</div>
              <div><strong>Avoid:</strong> long narratives, assumptions without evidence, and duplicate notes.</div>
            </div>
          </details>
          <div class="interactive-panel" data-observation-item-type="actor" data-observation-item-key="summary">
            <div class="obs-row">
              <div>
                <label>Analyst</label>
                <input type="text" class="observation-analyst" placeholder="name or handle" />
              </div>
              <div>
                <label>Confidence</label>
                <select class="observation-confidence">
                  <option value="moderate">Moderate</option>
                  <option value="high">High</option>
                  <option value="low">Low</option>
                </select>
              </div>
              <textarea class="observation-note" placeholder="What changed that matters for this actor?"></textarea>
            </div>
            <div class="obs-actions">
              <button type="button" class="observation-save">Save note</button>
              <button type="button" class="observation-history-toggle">View history</button>
              <span class="observation-meta" data-observation-meta></span>
            </div>
            <div class="observation-history" data-observation-history style="display:none;"></div>
          </div>
          <div class="review-strip" style="margin-top:8px;">
            <h4>Since last review</h4>
            <div class="review-grid">
              <div class="review-metric"><div class="label">Since</div><div class="value" id="since-review-date">Not set</div></div>
              <div class="review-metric"><div class="label">Notes</div><div class="value" id="since-review-observations">0</div></div>
              <div class="review-metric"><div class="label">Sources</div><div class="value" id="since-review-sources">0</div></div>
              <div class="review-metric"><div class="label">Reports</div><div class="value" id="since-review-reports">0</div></div>
            </div>
            <div class="review-actions">
              <button type="button" id="mark-reviewed">Mark reviewed now</button>
              <button type="button" id="clear-reviewed">Clear baseline</button>
              <span id="review-meta" class="review-meta"></span>
            </div>
          </div>
          <details class="compact">
            <summary>History, filters, export</summary>
            <div class="ledger-controls">
              <div>
                <label for="ledger-filter-analyst">Analyst</label>
                <input id="ledger-filter-analyst" type="text" placeholder="name contains..." />
              </div>
              <div>
                <label for="ledger-filter-confidence">Confidence</label>
                <select id="ledger-filter-confidence">
                  <option value="">All</option>
                  <option value="high">High</option>
                  <option value="moderate">Moderate</option>
                  <option value="low">Low</option>
                </select>
              </div>
              <div>
                <label for="ledger-filter-from">Updated from</label>
                <input id="ledger-filter-from" type="date" />
              </div>
              <div>
                <label for="ledger-filter-to">Updated to</label>
                <input id="ledger-filter-to" type="date" />
              </div>
              <div>
                <label for="ledger-limit">Show</label>
                <select id="ledger-limit">
                  <option value="12">12</option>
                  <option value="25">25</option>
                  <option value="50">50</option>
                </select>
              </div>
            </div>
            <div id="ledger-filter-chips" class="filter-chips"></div>
            <div class="ledger-actions">
              <button type="button" id="ledger-apply">Apply filters</button>
              <button type="button" id="ledger-clear">Clear</button>
              <a id="ledger-export-json" href="#" target="_blank" rel="noreferrer">Export JSON</a>
              <a id="ledger-export-csv" href="#" target="_blank" rel="noreferrer">Export CSV</a>
              <span id="observation-ledger-count" class="ledger-count"></span>
            </div>
            <div id="observation-ledger-empty" class="timeline-empty">No observations saved yet.</div>
            <div id="observation-ledger-list" class="ledger-list"></div>
          </details>
        </div>
        {% endif %}
      </aside>

      <main class="main">
        <div class="top-status-row">
          <div id="notebook-health-chip" class="notice status-chip status-{{ notebook_health.state }}">
            <strong>Notebook health:</strong> <span id="notebook-health-message">{{ notebook_health.message }}</span>
            <div class="status-meta">Last refresh: <span id="notebook-health-duration">{{ notebook_health.last_refresh_duration }}</span> | Sources processed: <span id="notebook-health-sources">{{ notebook_health.last_refresh_sources }}</span></div>
            <div id="notebook-health-progress" class="progress-wrap" {% if not notebook or notebook.actor.notebook_status != 'running' %}style="display:none;"{% endif %}><div class="progress-bar"></div></div>
          </div>
          {% set llm_message = (ollama_status.message if ollama_status and ollama_status.message else 'LLM status unavailable.') %}
          {% set llm_message_lower = llm_message|lower %}
          {% set llm_ready = (ollama_status and ollama_status.available and ('not found' not in llm_message_lower)) %}
          <div id="llm-status-chip" class="notice status-chip {% if llm_ready %}status-llm-ok{% else %}status-llm-bad{% endif %}">
            <strong>LLM:</strong> {% if llm_ready %}ready{% else %}offline{% endif %}
            <div class="status-meta">{{ llm_message }}</div>
          </div>
          {% if notice %}
          <div class="notice status-chip">{{ notice }}</div>
          {% endif %}
          {% if notebook %}
          <div class="live-controls">
            <span class="live-pill" id="live-indicator">Live sync on</span>
          </div>
          {% endif %}
          <div id="ui-activity-strip" class="notice status-chip ui-activity-strip status-idle" role="status" aria-live="polite" hidden>
            <strong>Activity:</strong> <span id="ui-activity-text">Idle</span>
          </div>
        </div>
        {% if refresh_stats %}
        <div class="ops-health">
          <h4>Refresh health (at a glance)</h4>
          <div class="ops-health-grid">
            <div class="ops-health-item">
              <div class="label">Feeds in backoff</div>
              <div class="value">{{ refresh_stats.feed_state.backoff_feeds }}</div>
            </div>
            <div class="ops-health-item">
              <div class="label">High confidence</div>
              <div class="value">{{ refresh_stats.source_state.high_confidence_sources }}</div>
            </div>
            <div class="ops-health-item">
              <div class="label">24h high confidence</div>
              <div class="value">{{ refresh_stats.source_state.recent_high_confidence_sources_24h }}</div>
            </div>
          </div>
        </div>
        {% endif %}
        {% if not notebook %}
        <div class="empty">Select an actor to open the notebook.</div>
        {% else %}
        <div class="dashboard">
        {% set recent_change = notebook.get('recent_change_summary', {'new_reports': '0', 'targets': 'Not clear yet', 'damage': 'No clear damage outcome reported yet'}) %}
        {% set first_new_report_url = '' %}
        {% if notebook.top_change_signals %}
          {% for signal in notebook.top_change_signals %}
            {% if signal.validated_sources %}
              {% for evidence in signal.validated_sources %}
                {% if evidence.source_url and not first_new_report_url %}
                  {% set first_new_report_url = evidence.source_url %}
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endfor %}
        {% endif %}
        {% if not first_new_report_url and notebook.recent_activity_highlights %}
          {% for highlight in notebook.recent_activity_highlights %}
            {% if highlight.source_url and not first_new_report_url %}
              {% set first_new_report_url = highlight.source_url %}
            {% endif %}
          {% endfor %}
        {% endif %}
        <section class="card span-2 ataglance-strip" id="section-ataglance">
          <div class="ataglance-metric">
            <div class="ataglance-label">Actor</div>
            <div class="ataglance-value">{{ notebook.actor.display_name }}</div>
          </div>
          <div class="ataglance-metric">
            <div class="ataglance-label">New Reports</div>
            <div class="ataglance-value">
              {% if first_new_report_url %}
              <a id="recent-reports-link" href="{{ first_new_report_url }}" target="_blank" rel="noreferrer" title="Open most recent supporting report source">
                <span id="recent-reports">{{ recent_change.new_reports }}</span>
              </a>
              {% else %}
              <a id="recent-reports-link" href="/actors/{{ notebook.actor.id }}/timeline/details" title="Open timeline details">
                <span id="recent-reports">{{ recent_change.new_reports }}</span>
              </a>
              {% endif %}
            </div>
          </div>
          <div class="ataglance-metric">
            <div class="ataglance-label">Trend</div>
            {% set trend_buckets = notebook.timeline_graph[-6:] if notebook.timeline_graph else [] %}
            {% set latest_bucket = trend_buckets[-1] if trend_buckets else None %}
            {% set prev_bucket = trend_buckets[-2] if trend_buckets|length > 1 else None %}
            {% set latest_total = latest_bucket.total if latest_bucket else 0 %}
            {% set prev_total = prev_bucket.total if prev_bucket else 0 %}
            {% set delta = latest_total - prev_total %}
            {% if latest_total == 0 and prev_total == 0 %}
            {% set trend_label = 'Quiet' %}
            {% elif delta > 0 %}
            {% set trend_label = 'Rising' %}
            {% elif delta < 0 %}
            {% set trend_label = 'Cooling' %}
            {% else %}
            {% set trend_label = 'Steady' %}
            {% endif %}
            <div class="ataglance-value">{{ trend_label }}</div>
            {% if notebook.timeline_graph %}
            <div class="mini-trend-inline" aria-hidden="true">
              {% for bucket in trend_buckets %}
              <span class="mini-trend-bar{% if loop.last %} peak{% endif %}" style="height: {{ [20, [4, bucket.height_pct // 2]|max]|min }}px;" title="{{ bucket.label }}: {{ bucket.total }} events"></span>
              {% endfor %}
            </div>
            <div class="mini-trend-labels"><span>Older</span><span>Latest</span></div>
            <div class="mini-trend-kpis">
              <div class="mini-trend-kpi">
                <span class="k">Latest</span>
                <span class="v">{{ latest_total }}</span>
              </div>
              <div class="mini-trend-kpi">
                <span class="k">Prev</span>
                <span class="v">{{ prev_total }}</span>
              </div>
              <div class="mini-trend-kpi {% if delta > 0 %}up{% elif delta < 0 %}down{% else %}flat{% endif %}">
                <span class="k">Direction</span>
                <span class="v">
                  {% if delta > 0 %}+{{ delta }}{% elif delta < 0 %}{{ delta }}{% else %}0{% endif %}
                </span>
              </div>
            </div>
            <div class="mini-trend-meta">
              Latest bucket: {{ trend_buckets[-1].total if trend_buckets else 0 }} events
            </div>
            {% endif %}
          </div>
          <div class="ataglance-metric">
            <div class="ataglance-label">Notable Impact</div>
            <div class="ataglance-value"><span id="recent-impact">{{ recent_change.damage }}</span></div>
          </div>
        </section>
        {% if notebook.priority_questions %}
        <section class="card span-2 decision-queue" data-step="action" id="section-nextchecks">
          <div class="decision-header">
            <div style="display:flex; align-items:center; gap:8px;">
              <h2 class="section-title" style="margin:0;">Quick checks</h2>
              <button type="button" id="quick-check-do-next" style="padding:6px 10px; border:1px solid #9fb3d5; border-radius:8px; background:#eef4ff; cursor:pointer;">DO NEXT</button>
            </div>
            <div>
              {% if notebook.backfill_notice %}
              <span class="badge">{{ notebook.backfill_notice }}</span>
              <span> | </span>
              {% endif %}
              {% if notebook.backfill_debug %}
              <span class="actor-scope">{{ notebook.backfill_debug }}</span>
              <span> | </span>
              {% endif %}
              <a href="/actors/{{ notebook.actor.id }}/questions">Open workspace</a>
              <span> | </span>
              <a href="/actors/{{ notebook.actor.id }}/hunts/iocs?window_days=30">IOC hunt queries</a>
            </div>
          </div>
          <div class="dq-list">
            {% for question in notebook.priority_questions %}
            <details class="dq-row" data-quick-check="1" data-quick-check-rank="{{ loop.index0 }}">
              <summary>
                <strong>{{ question.title or question.quick_check_title }}</strong>
                <span class="pbadge {{ question.severity.lower() if question.severity else question.priority.lower() }}">{{ question.severity or question.priority }}</span>
              </summary>
              <div class="dq-detail">
                <div class="dq-line"><strong>Behavior to hunt:</strong> {{ question.behavior_to_hunt or question.decision_trigger }}</div>
                <div class="dq-line"><strong>Where to start:</strong> {{ question.where_to_start or question.first_step or question.telemetry_anchor }}</div>
                <div class="dq-line"><strong>What to watch:</strong> {{ question.what_to_watch or question.what_to_look_for or question.success_condition or question.decision_trigger }}</div>
                <div class="dq-line"><strong>Required data:</strong>
                  {% if question.required_data %}
                    {{ question.required_data }}
                  {% else %}
                    Windows Event Logs with host/user context.
                  {% endif %}
                </div>
                <div class="dq-line"><strong>Decision rule:</strong> {{ question.decision_rule or question.success_condition }}</div>
                <div class="dq-line"><strong>Analyst output:</strong> {{ question.analyst_output or question.expected_output }}</div>
                <div class="dq-line"><strong>Evidence used:</strong>
                  {% if question.evidence_used %}
                    {{ question.evidence_used | join(' | ') }}
                  {% else %}
                    No actor-linked evidence in last 30 days.
                  {% endif %}
                </div>
                <div class="dq-line"><a href="/actors/{{ notebook.actor.id }}/hunts/iocs?quick_check_id={{ (question.quick_check_id or question.check_template_id or question.id) | urlencode }}&window_start={{ question.window_start | urlencode }}&window_end={{ question.window_end | urlencode }}">Open IOC hunt queries for this check</a></div>
                <div class="feedback-actions">
                  <button type="button" class="question-feedback-btn positive" data-thread-id="{{ question.id }}" data-feedback="useful">Useful</button>
                  <button type="button" class="question-feedback-btn negative" data-thread-id="{{ question.id }}" data-feedback="not_useful">Not useful</button>
                  <span class="feedback-status" id="feedback-status-{{ question.id }}"></span>
                </div>
              </div>
            </details>
            {% endfor %}
          </div>
        </section>
        {% endif %}

        <div class="workspace-grid">
        <section class="card pane" data-step="who" id="section-who">
          <h2 class="section-title">1) Who are they?<span class="role-chip">Understand</span></h2>
          <div class="section-body">
          <div class="who-summary">
            <p>{{ notebook.actor_profile_summary }}</p>
            <div class="who-meta">Framework Group Match: {{ notebook.actor_profile_group_name }} | Source: <a href="{{ notebook.actor_profile_source_url }}" target="_blank" rel="noreferrer">{{ notebook.actor_profile_source_label }}</a> | Created: {{ notebook.actor_created_date }}</div>
          </div>
          {% set why_now_signal = notebook.top_change_signals[0] if notebook.top_change_signals else None %}
          {% set why_now_synthesis = notebook.recent_activity_synthesis[0] if notebook.recent_activity_synthesis else None %}
          {% set why_now_text = '' %}
          {% if why_now_signal and why_now_signal.change_why_new %}
            {% set why_now_text = why_now_signal.change_why_new %}
          {% elif why_now_synthesis and why_now_synthesis.text %}
            {% set why_now_text = why_now_synthesis.text %}
          {% elif why_now_signal and why_now_signal.change_summary %}
            {% set why_now_text = why_now_signal.change_summary %}
          {% else %}
            {% set why_now_text = recent_change.new_reports ~ ' recent report(s) were added for this actor, with observed impact reported as ' ~ recent_change.damage ~ '.' %}
          {% endif %}
          <div class="who-why">
            <strong>Why this matters now:</strong> {{ why_now_text }}
            {% if why_now_signal and why_now_signal.validated_source_count %}
            <div class="who-meta">Supported by {{ why_now_signal.validated_source_count }} corroborated source(s).</div>
            {% endif %}
          </div>
          <p class="who-heading"><strong>Common moves they use (top 3)</strong></p>
          {% if notebook.top_techniques %}
          <div class="technique-grid">
            {% for technique in notebook.top_techniques[:3] %}
            <div class="technique-item">
              <div class="technique-head">
                {% if technique.technique_url %}
                <a class="technique-pill" href="{{ technique.technique_url }}" target="_blank" rel="noreferrer">{{ technique.technique_id or 'Technique' }}</a>
                {% else %}
                <span class="technique-pill">{{ technique.technique_id or 'Technique' }}</span>
                {% endif %}
              </div>
              <div class="technique-name">{{ technique.technique_name }}</div>
              {% if technique.phase %}
              <div class="technique-phase">{{ technique.phase.replace('_', ' ') }}</div>
              {% endif %}
            </div>
            {% endfor %}
          </div>
          <p><small>New to ATT&CK IDs? Treat these as behavior tags to guide detections and hunts.</small></p>
          {% else %}
          <p><small>No mapped technique profile available yet.</small></p>
          {% endif %}
          <div class="who-kpis">
            <div class="who-kpi">
              <div class="who-kpi-label">30d activity</div>
              <div class="who-kpi-value">{{ notebook.kpis.activity_30d }}</div>
            </div>
            <div class="who-kpi">
              <div class="who-kpi-label">New techniques</div>
              <div class="who-kpi-value">{{ notebook.kpis.new_techniques_30d }}</div>
            </div>
            <div class="who-kpi">
              <div class="who-kpi-label">Last checked</div>
              <div class="who-kpi-value">{{ notebook.kpis.last_verified_update }}</div>
            </div>
          </div>
          <details class="compact">
            <summary>Emerging techniques observed ({{ notebook.emerging_techniques|length if notebook.emerging_techniques else 0 }})</summary>
          {% if notebook.emerging_techniques %}
          <ul class="summary-list">
            {% for technique in notebook.emerging_techniques[:3] %}
            <li>
              {% if technique.technique_url %}
              <a href="{{ technique.technique_url }}" target="_blank" rel="noreferrer">{{ technique.technique_id }}</a>
              {% else %}
              {{ technique.technique_id }}
              {% endif %}
              {% if technique.technique_name %} - {{ technique.technique_name }}{% endif %}
              <small>(first seen {{ technique.first_seen or 'unknown' }}, {{ technique.source_count }} sources, {{ technique.event_count }} events)</small>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p><small>No new technique IDs observed yet in actor-specific recent reporting.</small></p>
          {% endif %}
          </details>
          </div>
          {% if not notebook.actor.is_tracked %}
          <form method="post" action="/actors/{{ notebook.actor.id }}/track">
            <button type="submit">Track actor</button>
          </form>
          {% endif %}
        </section>

        <section class="card pane" data-step="recent" id="section-recent">
          <h2 class="section-title">2) What have they been up to recently?<span class="role-chip">Watch</span></h2>
          {% if notebook.actor.notebook_status == 'running' %}
          <div class="notice status-working">Source collection is running in the background. This section will populate automatically.</div>
          {% endif %}
          <div class="section-body">
          <p><strong>Recent activity snapshot:</strong></p>
          <ul class="summary-list">
            <li><strong>Report count:</strong> {{ recent_change.new_reports }}</li>
            <li><strong>Target sectors:</strong> <span id="recent-targets">{{ recent_change.targets }}</span></li>
            <li><strong>Reported impact:</strong> {{ recent_change.damage }}</li>
          </ul>
          {% if notebook.recent_activity_synthesis %}
          <p class="inline-note"><strong>How to read:</strong> left to right = change, affected area, and recommended first action.</p>
          <div class="snapshot-grid">
            {% for synthesis in notebook.recent_activity_synthesis %}
            <div class="snapshot-card conf-{{ (synthesis.confidence or 'low') | lower }}">
              <h3 class="snapshot-title">{{ synthesis.label }}</h3>
              <p class="snapshot-text">{{ synthesis.text }}</p>
              <div class="snapshot-meta">
                <span class="badge">{{ synthesis.confidence }}</span>
                <span>{{ synthesis.lineage }}</span>
              </div>
            </div>
            {% endfor %}
          </div>
          {% endif %}
          {% if notebook.recent_activity_highlights %}
          {% set quality_filters = notebook.get('source_quality_filters', source_quality_filters or {}) %}
          <p class="inline-note">
            Built from fresh, higher-confidence reporting.
            Using {{ quality_filters.get('applied_sources', 0) }} of {{ quality_filters.get('total_sources', 0) }} sources{% if quality_filters.get('filtered_out_sources', 0) %} (filtered out: {{ quality_filters.get('filtered_out_sources', 0) }}){% endif %}.
          </p>
          <p><strong>What changed recently (AI reviewed):</strong></p>
          {% if notebook.top_change_signals %}
          <div class="change-list" id="latest-sources-list">
            {% for item in notebook.top_change_signals %}
            <div class="change-row">
              <div class="change-row-main">
                <div class="change-row-title">{{ item.change_summary }}</div>
                <div>
                  {% if item.change_window_days %}<span class="badge">first seen in the last {{ item.change_window_days }} days</span>{% endif %}
                  {% if item.change_confidence %}<span class="badge">{{ item.change_confidence }}</span>{% endif %}
                </div>
              </div>
              {% if item.change_why_new %}
              <div class="change-row-source"><em>{{ item.change_why_new }}</em></div>
              {% endif %}
              <div class="change-row-source">
                Based on {{ item.validated_source_count or '0' }} source(s) we checked
                {% if item.category and item.category != 'activity synthesis' %} | {{ item.category.replace('_', ' ') }}{% endif %}
                {% if item.ttp_ids %} | {{ item.ttp_ids }}{% endif %}
                {% if item.target_text %} | target: {{ item.target_text }}{% endif %}
              </div>
              {% if item.validated_sources %}
              <ul class="recent-source-list" style="margin-top:6px;">
                {% for evidence in item.validated_sources %}
                <li>
                  <div class="source-headline">
                    {% if evidence.source_date %}<span class="badge">{{ evidence.source_date }}</span>{% endif %}
                    {% if evidence.freshness_label %}<span class="badge {{ evidence.freshness_class }}">{{ evidence.freshness_label }}</span>{% endif %}
                    <a class="source-title-link" href="{{ evidence.source_url }}" target="_blank" rel="noreferrer">{{ evidence.source_label or evidence.source_url }}</a>
                  </div>
                  {% if evidence.proof %}<small class="source-meta">{{ evidence.proof }}</small>{% endif %}
                </li>
                {% endfor %}
              </ul>
              {% endif %}
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p><small>No clear new behavior was confirmed from recent reporting (last 30/60/90 days).</small></p>
          {% endif %}
          <div class="timeline-footer-link"><a href="/actors/{{ notebook.actor.id }}/timeline/details">View source timeline evidence</a></div>
          {% else %}
          <p>No recent activity summary yet.</p>
          {% endif %}

          </div>

        </section>

        </div>

          {% if notebook.ioc_items %}
          <details class="compact">
            <summary>Recent IOCs</summary>
            <div class="section-body">
              {% for ioc in notebook.ioc_items[:20] %}
              <div style="margin-bottom:6px;">
                <div><span class="badge">{{ ioc.ioc_type }}</span> {{ ioc.ioc_value }}{% if ioc.source_ref %} ({{ ioc.source_ref }}){% endif %}</div>
                <div><small>Status: {{ ioc.lifecycle_status or 'active' }} | TLP: {{ ioc.handling_tlp or 'TLP:CLEAR' }} | Seen: {{ ioc.seen_count or 1 }} | Last seen: {{ ioc.last_seen_at or ioc.created_at or 'unknown' }}</small></div>
                <form method="post" action="/actors/{{ notebook.actor.id }}/iocs/{{ ioc.id }}/status" style="display:flex; gap:6px; margin-top:4px; flex-wrap:wrap;">
                  <select name="lifecycle_status">
                    <option value="active" {% if (ioc.lifecycle_status or '') == 'active' %}selected{% endif %}>active</option>
                    <option value="monitor" {% if (ioc.lifecycle_status or '') == 'monitor' %}selected{% endif %}>monitor</option>
                    <option value="superseded" {% if (ioc.lifecycle_status or '') == 'superseded' %}selected{% endif %}>superseded</option>
                    <option value="revoked" {% if (ioc.lifecycle_status or '') == 'revoked' %}selected{% endif %}>revoked</option>
                    <option value="false_positive" {% if (ioc.lifecycle_status or '') == 'false_positive' %}selected{% endif %}>false_positive</option>
                  </select>
                  <select name="handling_tlp">
                    <option value="TLP:CLEAR" {% if (ioc.handling_tlp or 'TLP:CLEAR') == 'TLP:CLEAR' %}selected{% endif %}>TLP:CLEAR</option>
                    <option value="TLP:GREEN" {% if (ioc.handling_tlp or '') == 'TLP:GREEN' %}selected{% endif %}>TLP:GREEN</option>
                    <option value="TLP:AMBER" {% if (ioc.handling_tlp or '') == 'TLP:AMBER' %}selected{% endif %}>TLP:AMBER</option>
                    <option value="TLP:AMBER+STRICT" {% if (ioc.handling_tlp or '') == 'TLP:AMBER+STRICT' %}selected{% endif %}>TLP:AMBER+STRICT</option>
                    <option value="TLP:RED" {% if (ioc.handling_tlp or '') == 'TLP:RED' %}selected{% endif %}>TLP:RED</option>
                  </select>
                  <input type="text" name="status_reason" placeholder="reason (optional)" />
                  <button type="submit">Update</button>
                </form>
              </div>
              {% endfor %}
            </div>
          </details>
          {% endif %}

        </div>
        {% endif %}
      </main>
    </div>
    <script src="/static/actor_autocomplete.js" defer></script>
    <script src="/static/index.js" defer></script>
    <div id="ui-toast-stack" class="ui-toast-stack" aria-live="polite" aria-atomic="false"></div>
  </body>
</html>
