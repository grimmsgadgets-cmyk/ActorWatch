<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>IOC Hunt Queries</title>
    <style>
      body { margin: 0; padding: 16px; font-family: Arial, sans-serif; background: #f7f7f7; color: #111; }
      .wrap { max-width: 1120px; margin: 0 auto; }
      .muted { color: #475569; font-size: 12px; }
      .card { background: #fff; border: 1px solid #d9e2ef; border-radius: 10px; padding: 12px; margin-bottom: 12px; }
      .notice { background: #fff7d6; border: 1px solid #ead48f; border-radius: 8px; padding: 10px; margin-bottom: 12px; }
      .tabs { display: flex; gap: 6px; margin: 8px 0; }
      .tab-btn { border: 1px solid #b9c9e4; background: #eef4ff; border-radius: 8px; padding: 5px 10px; cursor: pointer; font-size: 12px; }
      .tab-btn.active { background: #dce9ff; border-color: #8ea9d9; }
      .tab-panel { display: none; }
      .tab-panel.active { display: block; }
      .query-panel { border: 1px solid #d8e1ef; border-radius: 8px; background: #f8fbff; padding: 10px; margin: 8px 0; }
      pre { margin: 6px 0 0; white-space: pre-wrap; word-break: break-word; background: #0f172a; color: #e2e8f0; border-radius: 8px; padding: 10px; }
      table { width: 100%; border-collapse: collapse; }
      th, td { border-bottom: 1px solid #e5ebf5; padding: 8px; text-align: left; font-size: 12px; }
      .filter-row { display: grid; grid-template-columns: repeat(4, minmax(120px, 1fr)) auto; gap: 8px; align-items: end; }
      .filter-row label { font-size: 12px; color: #334155; display: grid; gap: 4px; }
      input, select, button { padding: 7px; border-radius: 6px; border: 1px solid #c8d5ea; }
      .actions { display: flex; gap: 8px; }
      a { color: #2255aa; text-decoration: none; }
      a:hover { text-decoration: underline; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <a href="/?actor_id={{ actor_id }}">&larr; Back to dashboard</a>
        <h1 style="margin:8px 0 4px;">IOC hunt queries: {{ actor_name }}</h1>
        <div class="muted">Actor scope: {{ actor_id }} | IOC window: {{ window_start }} to {{ window_end }}</div>
        <div class="muted">Dialect: {{ environment_profile.query_dialect }} | Query default lookback: {{ environment_profile.default_time_window_hours }}h (per-hunt query setting)</div>
        {% if quick_check_id %}
        <div class="muted">Check pre-filter: {{ quick_check_id }}</div>
        {% endif %}
      </div>

      {% if reason %}
      <div class="notice">{{ reason }}</div>
      {% endif %}
      {% if not ollama_status.available %}
      <div class="notice">Ollama is offline. Generated query slots will show placeholders until configured.</div>
      {% endif %}

      <div class="card">
        <h2 style="margin:0 0 8px;">Primary IOC Hunts</h2>
        {% for section in sections %}
        <div class="query-panel">
          <h3 style="margin:0 0 6px;">{{ section.label }}</h3>
          <div class="tabs" data-tabs="{{ section.id }}">
            {% for tab in platform_tabs %}
            <button type="button" class="tab-btn{% if loop.first %} active{% endif %}" data-tab="{{ section.id }}-{{ tab.key }}">{{ tab.label }}</button>
            {% endfor %}
          </div>

          {% for tab in platform_tabs %}
          <div id="{{ section.id }}-{{ tab.key }}" class="tab-panel{% if loop.first %} active{% endif %}">
            {% if section.platforms[tab.key] %}
              {% for item in section.platforms[tab.key] %}
              <div class="query-panel">
                <div><strong>Required data sources/tables:</strong> {{ item.required_data }}</div>
                <div><strong>What this returns:</strong> {{ item.returns }}</div>
                <pre>{{ item.query }}</pre>
              </div>
              {% endfor %}
            {% else %}
            <div class="muted">Not configured</div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
        {% endfor %}
      </div>

      <div class="card">
        <h2 style="margin:0 0 8px;">Misc IOCs (from reports)</h2>
        <div class="muted">Actor-related unmatched IOCs</div>
        <form method="get" class="filter-row">
          <input type="hidden" name="window_start" value="{{ window_start }}" />
          <input type="hidden" name="window_end" value="{{ window_end }}" />
          {% if quick_check_id %}<input type="hidden" name="quick_check_id" value="{{ quick_check_id }}" />{% endif %}
          <label>Type
            <select name="ioc_type">
              <option value="" {% if not filters.ioc_type %}selected{% endif %}>All</option>
              <option value="domain" {% if filters.ioc_type == 'domain' %}selected{% endif %}>domain</option>
              <option value="ip" {% if filters.ioc_type == 'ip' %}selected{% endif %}>ip</option>
              <option value="url" {% if filters.ioc_type == 'url' %}selected{% endif %}>url</option>
              <option value="hash" {% if filters.ioc_type == 'hash' %}selected{% endif %}>hash</option>
              <option value="email" {% if filters.ioc_type == 'email' %}selected{% endif %}>email</option>
            </select>
          </label>
          <label>Confidence (min)
            <input type="number" min="0" max="5" name="confidence" value="{{ filters.confidence }}" />
          </label>
          <label>Source count (min)
            <input type="number" min="1" name="source_count" value="{{ filters.source_count }}" />
          </label>
          <label>Freshness
            <select name="freshness">
              <option value="" {% if not filters.freshness %}selected{% endif %}>Any</option>
              <option value="24h" {% if filters.freshness == '24h' %}selected{% endif %}>24h</option>
              <option value="7d" {% if filters.freshness == '7d' %}selected{% endif %}>7d</option>
              <option value="30d" {% if filters.freshness == '30d' %}selected{% endif %}>30d</option>
            </select>
          </label>
          <button type="submit">Apply</button>
        </form>
        <div class="actions" style="margin:8px 0;">
          <a href="?window_start={{ window_start | urlencode }}&window_end={{ window_end | urlencode }}{% if quick_check_id %}&quick_check_id={{ quick_check_id | urlencode }}{% endif %}&ioc_type={{ filters.ioc_type | urlencode }}&confidence={{ filters.confidence | urlencode }}&source_count={{ filters.source_count | urlencode }}&freshness={{ filters.freshness | urlencode }}&export=csv">Export CSV</a>
          <a href="?window_start={{ window_start | urlencode }}&window_end={{ window_end | urlencode }}{% if quick_check_id %}&quick_check_id={{ quick_check_id | urlencode }}{% endif %}&ioc_type={{ filters.ioc_type | urlencode }}&confidence={{ filters.confidence | urlencode }}&source_count={{ filters.source_count | urlencode }}&freshness={{ filters.freshness | urlencode }}&export=json">Export JSON</a>
        </div>
        <table>
          <thead>
            <tr>
              <th>type</th>
              <th>value</th>
              <th>first_seen</th>
              <th>last_seen</th>
              <th>sources_count</th>
              <th>confidence</th>
            </tr>
          </thead>
          <tbody>
            {% for item in misc_iocs %}
            <tr>
              <td>{{ item.ioc_type }}</td>
              <td>{{ item.ioc_value }}</td>
              <td>{{ item.first_seen }}</td>
              <td>{{ item.last_seen }}</td>
              <td>{{ item.sources_count }}</td>
              <td>{{ item.confidence }}</td>
            </tr>
            {% endfor %}
            {% if not misc_iocs %}
            <tr><td colspan="6" class="muted">No IOC rows in the actor-scoped last-30-day window.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    <script>
      (function () {
        const groups = document.querySelectorAll("[data-tabs]");
        groups.forEach((group) => {
          const buttons = Array.from(group.querySelectorAll(".tab-btn"));
          buttons.forEach((button) => {
            button.addEventListener("click", () => {
              const targetId = button.getAttribute("data-tab");
              if (!targetId) return;
              const parent = group.parentElement;
              if (!parent) return;
              buttons.forEach((btn) => btn.classList.remove("active"));
              button.classList.add("active");
              Array.from(parent.querySelectorAll(".tab-panel")).forEach((panel) => panel.classList.remove("active"));
              const target = parent.querySelector("#" + CSS.escape(targetId));
              if (target) target.classList.add("active");
            });
          });
        });
      })();
    </script>
  </body>
</html>
